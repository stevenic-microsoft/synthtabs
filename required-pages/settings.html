<!DOCTYPE html><html lang="en"><head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SynthOS - Settings</title>
    <script src="/api/theme-info.js"></script>
    <link rel="stylesheet" href="/api/theme.css">
    <style>
        /* Settings Page Styles */
        .settings-title { font-size: 22px; font-weight: 700; min-height: var(--header-min-height); padding: var(--header-padding-vertical) var(--header-padding-horizontal); line-height: var(--header-line-height); display: flex; align-items: center; justify-content: center; box-sizing: border-box; background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary)); color: white; border-radius: 12px 12px 0 0; width: 100%; max-width: 800px; box-shadow: 0 6px 25px var(--accent-glow); letter-spacing: 2px; text-shadow: 0 2px 10px rgba(0,0,0,0.3); }
        .settings-container { display: flex; flex-direction: column; width: 100%; max-width: 800px; max-height: calc(100vh - 160px); background: rgba(15, 15, 35, 0.8); border-radius: 0 0 12px 12px; border: 1px solid rgba(138, 43, 226, 0.2); border-top: none; overflow: hidden; }

        /* Tab bar */
        .tab-bar { display: flex; flex-shrink: 0; border-bottom: 1px solid var(--border-color); }
        .tab-btn { flex: 1; padding: 14px 20px; background: transparent; border: none; border-bottom: 3px solid transparent; color: var(--text-secondary); font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.3s ease; letter-spacing: 0.5px; }
        .tab-btn:hover { color: var(--text-primary); background: rgba(138, 43, 226, 0.05); }
        .tab-btn.active { color: var(--text-primary); border-bottom-color: var(--accent-primary); }

        /* Tab content */
        .tab-content { display: none; flex-direction: column; gap: 15px; flex-grow: 1; overflow-y: auto; padding: 25px; }
        .tab-content.active { display: flex; }

        /* Form groups (kept from original) */
        .form-group { display: flex; flex-direction: column; width: 100%; }
        .form-group label { display: block; margin-bottom: 8px; color: var(--text-secondary); font-weight: 600; font-size: 14px; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 14px 18px; border-radius: 12px; border: 1px solid var(--border-color); background: rgba(15, 15, 35, 0.8); color: var(--text-primary); font-size: 14px; transition: all 0.3s ease; box-shadow: inset 0 2px 10px rgba(0,0,0,0.3); }
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus { outline: none; border-color: rgba(183, 148, 246, 0.6); box-shadow: inset 0 2px 10px rgba(0,0,0,0.3), 0 0 20px var(--accent-glow); }
        .form-group input::placeholder, .form-group textarea::placeholder { color: rgba(183, 148, 246, 0.5); }
        .form-group textarea { resize: vertical; min-height: 100px; }
        .form-group select { cursor: pointer; appearance: none; background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23b794f6' d='M6 8L1 3h10z'/%3E%3C/svg%3E"); background-repeat: no-repeat; background-position: right 15px center; }
        .form-group select option { background: var(--bg-tertiary); color: var(--text-primary); padding: 10px; }

        /* Button row */
        .button-row { display: flex; justify-content: flex-end; padding: 15px 25px; border-top: 1px solid var(--border-color); flex-shrink: 0; }
        .update-btn { padding: 12px 30px; border: none; border-radius: 12px; font-size: 15px; background: linear-gradient(135deg, var(--accent-primary) 0%, var(--accent-secondary) 50%, var(--accent-tertiary) 100%); color: white; cursor: pointer; transition: all 0.3s ease; font-weight: 600; letter-spacing: 1px; box-shadow: 0 4px 20px rgba(102, 126, 234, 0.4); }
        .update-btn:hover { transform: translateY(-2px); box-shadow: 0 6px 25px rgba(102, 126, 234, 0.6); }
        .update-btn:active { transform: translateY(0); }

        .disabled { background: rgba(102, 126, 234, 0.2) !important; cursor: not-allowed !important; opacity: 0.6; }
        .info-text { color: rgba(183, 148, 246, 0.7); font-size: 13px; line-height: 1.6; text-align: center; padding: 15px; background: rgba(15, 15, 35, 0.4); border-radius: 10px; border: 1px solid var(--border-color); }
        .info-text a { color: var(--accent-tertiary); text-decoration: none; transition: all 0.3s; font-weight: 500; }
        .info-text a:hover { color: var(--text-secondary); text-shadow: 0 0 10px var(--accent-glow); }

        /* Light-mode overrides */
        .light-mode .settings-container {
            background: rgba(255, 255, 255, 0.8);
        }
        .light-mode .tab-btn { color: rgba(107, 79, 138, 0.7); }
        .light-mode .tab-btn:hover { background: rgba(118, 75, 162, 0.05); color: var(--text-primary); }
        .light-mode .tab-btn.active { color: var(--text-primary); }
        .light-mode .form-group input,
        .light-mode .form-group select,
        .light-mode .form-group textarea {
            background: rgba(255, 255, 255, 0.8);
            box-shadow: inset 0 2px 10px rgba(118, 75, 162, 0.05);
        }
        .light-mode .form-group input:focus,
        .light-mode .form-group select:focus,
        .light-mode .form-group textarea:focus {
            box-shadow: inset 0 2px 10px rgba(118, 75, 162, 0.05), 0 0 20px var(--accent-glow);
        }
        .light-mode .form-group input::placeholder,
        .light-mode .form-group textarea::placeholder { color: rgba(107, 79, 138, 0.5); }
        .light-mode .info-text {
            color: rgba(107, 79, 138, 0.7);
            background: rgba(255, 255, 255, 0.4);
        }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.9.0/d3.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/14.1.1/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mermaid/11.1.0/mermaid.min.js"></script>
</head>
<body>
    <div class="chat-panel">
        <div class="chat-header">SynthOS</div>
        <div class="chat-messages" id="chatMessages">
            <div class="chat-message">
                <p><strong>SynthOS:</strong> Please fill in all required fields in the settings form and click 'Update'. Ensure your OpenAI or Anthropic API Key is valid and select the model you wish to use.</p>
                <p><code>Max Output Tokens</code> controls how large of a page that can be rendered and <code>Additional Instructions</code> can be used to provide further prompt instructions for how pages should be updated.</p>
            </div>
        </div>
        <div class="link-group">
            <a href="#" id="saveLink">Save</a>
            <a href="/pages" id="pagesLink">Pages</a>
            <a href="#" id="resetLink">Reset</a>
        </div>
        <form action="/" method="POST" id="chatForm">
            <input type="text" class="chat-input" id="chatInput" name="message" placeholder="Type a message...">
            <button type="submit" class="chat-submit">Send</button>
        </form>
    </div>
    <div class="viewer-panel" id="viewerPanel" style="justify-content: flex-start; align-items: stretch;">
        <div class="settings-title" style="max-width: none; border-radius: 12px 12px 0 0;">Settings</div>
        <div class="settings-container" style="max-width: none; border-radius: 0; max-height: none; flex-grow: 1;">
            <div class="tab-bar">
                <button class="tab-btn active" data-tab="models">Models</button>
                <button class="tab-btn" data-tab="preferences">Preferences</button>
            </div>
            <div class="tab-content active" id="tab-models">
                <div class="form-group">
                    <label for="serviceApiKey">Service API Key</label>
                    <input type="password" id="serviceApiKey" placeholder="Enter your API Key" required="">
                </div>
                <div class="form-group">
                    <label for="model">Model</label>
                    <select id="model" required="">
                        <option value="">Select a model</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="maxTokens">Max Output Tokens</label>
                    <input type="number" id="maxTokens" placeholder="Enter max token count" required="">
                </div>
                <div class="form-group">
                    <label for="instructions">Additional Instructions</label>
                    <textarea id="instructions" placeholder="Enter any additional instructions"></textarea>
                </div>
                <p class="info-text">An API Key is required which can be generated from either <a href="https://platform.openai.com/api-keys" target="_blank">OpenAI API Keys</a> or <a href="https://console.anthropic.com/settings/keys" target="_blank">Anthropic API Keys</a>.</p>
            </div>
            <div class="tab-content" id="tab-preferences">
                <div class="form-group">
                    <label for="theme">Theme</label>
                    <select id="theme">
                        <option value="">Loading themes...</option>
                    </select>
                </div>
            </div>
            <div class="button-row">
                <button class="update-btn" id="updateBtn">Update</button>
            </div>
        </div>
    </div>
    <div id="thoughts" style="display: none;">Added border-radius: 12px 12px 0 0 to the settings title to round only the top-left and top-right corners, maintaining the flat bottom edge that connects with the settings container.</div>
    <div id="loadingOverlay" class="loading-overlay"><div class="spinner"></div></div>
    <script>
        // Basic chat functionality
        document.getElementById("chatInput").focus();
        document.getElementById("chatForm").addEventListener('submit', (event) => {
            document.getElementById("loadingOverlay").style.display = 'flex';
            document.getElementById("chatForm").action = window.location.pathname;
        });
        document.getElementById("saveLink").addEventListener("click", function() {
            const pageName = prompt("Enter the name of the page to save as:");
            if (pageName) {
                window.location.href = `${window.location.pathname}/save?name=${encodeURIComponent(pageName)}`;
            }
        });
        document.getElementById("resetLink").addEventListener("click", function() {
            window.location.href = `${window.location.pathname}/reset`;
        });
        window.onload = function() {
            const chatMessages = document.getElementById('chatMessages');
            chatMessages.scrollTop = chatMessages.scrollHeight;
        };

        // Tab switching
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                btn.classList.add('active');
                document.getElementById('tab-' + btn.dataset.tab).classList.add('active');
            });
        });

        // Fetch settings and themes in parallel, then populate form
        let isConfigured = false;
        Promise.all([
            fetch('/api/settings').then(r => r.json()),
            fetch('/api/themes').then(r => r.json())
        ]).then(([data, themes]) => {
            // Populate Models tab
            const serviceApiKey = data.serviceApiKey || '';
            const model = data.model || '';
            const maxTokens = data.maxTokens || '';
            isConfigured = serviceApiKey && model && maxTokens;
            document.getElementById('serviceApiKey').value = serviceApiKey;
            document.getElementById('model').innerHTML = data.availableModels.map(m => `<option value="${m}">${m}</option>`).join('');
            document.getElementById('model').value = model;
            document.getElementById('maxTokens').value = maxTokens;
            document.getElementById('instructions').value = data.instructions || '';

            // Populate Preferences tab
            const currentTheme = data.theme || 'nebula-dusk';
            document.getElementById('theme').innerHTML = themes.map(t => `<option value="${t}">${t}</option>`).join('');
            document.getElementById('theme').value = currentTheme;

            // Disable chat input if not configured
            if (!isConfigured) {
                document.getElementById('chatInput').disabled = true;
                document.getElementById('chatInput').classList.add('disabled');
            }
        }).catch(error => console.error('Error fetching settings:', error));

        // Update button â€” collect fields from both tabs, POST JSON, reload on success
        document.getElementById('updateBtn').addEventListener('click', () => {
            const serviceApiKey = document.getElementById('serviceApiKey').value;
            const model = document.getElementById('model').value;
            const maxTokens = document.getElementById('maxTokens').value;

            if (!serviceApiKey || !model || !maxTokens) {
                alert('Please fill in all required fields (API Key, Model, Max Output Tokens).');
                return;
            }

            const body = {
                serviceApiKey,
                model,
                maxTokens,
                instructions: document.getElementById('instructions').value,
                theme: document.getElementById('theme').value
            };

            fetch('/api/settings', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(body)
            }).then(res => {
                if (res.ok || res.redirected) {
                    window.location.reload();
                } else {
                    alert('Failed to save settings. Please try again.');
                }
            }).catch(err => {
                console.error('Error saving settings:', err);
                alert('Failed to save settings. Please try again.');
            });
        });
    </script>


</body></html>