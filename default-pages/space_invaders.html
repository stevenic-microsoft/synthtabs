<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SynthOS</title>
    <script src="/api/theme-info.js"></script>
    <link rel="stylesheet" href="/api/theme.css">
    <style>
        /* Game Styles */
        .game-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
            width: 100%;
            height: 100%;
        }
        .game-header {
            display: flex;
            justify-content: space-between;
            width: 100%;
            max-width: 600px;
            padding: 10px 20px;
            background: linear-gradient(135deg, rgba(102,126,234,0.2) 0%, rgba(118,75,162,0.2) 100%);
            border-radius: 15px;
            border: 1px solid rgba(138,43,226,0.3);
        }
        .game-stat {
            font-size: 18px;
            font-weight: 600;
            color: #f093fb;
            text-shadow: 0 0 10px rgba(240,147,251,0.5);
        }
        #gameCanvas {
            border: 2px solid rgba(138,43,226,0.5);
            border-radius: 10px;
            box-shadow: 0 0 30px rgba(138,43,226,0.3), inset 0 0 50px rgba(75,0,130,0.2);
            background: rgba(10,10,25,0.9);
        }
        .game-controls {
            display: flex;
            gap: 15px;
            margin-top: 10px;
        }
        .game-btn {
            padding: 12px 25px;
            border: none;
            border-radius: 25px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        .game-btn.start {
            background: linear-gradient(135deg, #00f260 0%, #0575e6 100%);
            color: #fff;
            box-shadow: 0 4px 20px rgba(0,242,96,0.4);
        }
        .game-btn.start:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 25px rgba(0,242,96,0.6);
        }
        .game-btn.pause {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: #fff;
            box-shadow: 0 4px 20px rgba(240,147,251,0.4);
        }
        .game-instructions {
            font-size: 12px;
            color: rgba(183,148,246,0.7);
            text-align: center;
            margin-top: 5px;
        }
        /* Light-mode overrides */
        .light-mode .game-instructions { color: rgba(107, 79, 138, 0.7); }
        #loadingOverlay { position: absolute; }
        .chat-submit:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
        .chat-input:disabled { opacity: 0.5; cursor: not-allowed; }
    </style>
</head>
<body>
    <div class="chat-panel">
        <div class="chat-header">SynthOS</div>
        <div class="chat-messages" id="chatMessages">
            <div class="chat-message"><p><strong>SynthOS:</strong> What can I create for you?</p></div>
            <div class="chat-message"><p><strong>You:</strong> create a cool looking space invaders game</p></div>
            <div class="chat-message"><p><strong>SynthOS:</strong> üöÄ Space Invaders activated! I've created a neon-themed retro arcade game with glowing aliens, particle explosions, and smooth animations. Use <code>‚Üê</code> <code>‚Üí</code> to move and <code>SPACE</code> to fire. Good luck, pilot!</p></div>
        </div>
        <div class="link-group">
            <a href="#" id="saveLink">Save</a>
            <a href="/pages" id="pagesLink">Pages</a>
            <a href="#" id="resetLink">Reset</a>
        </div>
        <form action="/" method="POST" id="chatForm">
            <input type="text" class="chat-input" id="chatInput" name="message" placeholder="Type a message...">
            <button type="submit" class="chat-submit">Send</button>
        </form>
    </div>
    <div class="viewer-panel" id="viewerPanel">
        <div class="game-container">
            <div class="game-header">
                <span class="game-stat">SCORE: <span id="score">0</span></span>
                <span class="game-stat">LEVEL: <span id="level">1</span></span>
                <span class="game-stat">LIVES: <span id="lives">3</span></span>
            </div>
            <canvas id="gameCanvas" width="600" height="450"></canvas>
            <div class="game-controls">
                <button class="game-btn start" id="startBtn">Start Game</button>
                <button class="game-btn pause" id="pauseBtn">Pause</button>
            </div>
            <div class="game-instructions">‚Üê ‚Üí to move | SPACE to fire | Destroy all aliens!</div>
        </div>
        <div id="loadingOverlay" class="loading-overlay"><div class="spinner"></div></div>
    </div>
    <div id="thoughts" style="display: none;">Created a visually stunning Space Invaders game with a neon/cyberpunk aesthetic that matches the Nebula Dusk theme. Features include: glowing aliens with different colors per row, a sleek player ship with gradient effects, particle explosions when enemies are destroyed, smooth animations, level progression with increasing difficulty, lives system, and responsive controls. The game uses canvas for rendering with requestAnimationFrame for smooth 60fps gameplay. Added visual effects like glow shadows, star field background, and pulsing animations to make it feel modern while keeping the classic gameplay.</div>
    <script>
        document.getElementById("chatInput").focus();
        document.getElementById("chatForm").addEventListener('submit', () => {
            document.getElementById("loadingOverlay").style.display = 'flex';
            document.getElementById("chatForm").action = window.location.pathname;
            setTimeout(() => {
                document.getElementById("chatInput").disabled = true;
                document.querySelector(".chat-submit").disabled = true;
                document.querySelectorAll(".link-group a").forEach(a => {
                    a.style.pointerEvents = 'none';
                    a.style.opacity = '0.5';
                });
            }, 50);
        });
        document.getElementById("saveLink").addEventListener("click", function() {
            const pageName = prompt("Enter the name of the page to save as:");
            if (pageName) {
                window.location.href = `${window.location.pathname}/save?name=${encodeURIComponent(pageName)}`;
            }
        });
        document.getElementById("resetLink").addEventListener("click", function() {
            window.location.href = `${window.location.pathname}/reset`;
        });
        window.onload = function() {
            const chatMessages = document.getElementById('chatMessages');
            chatMessages.scrollTo({
                top: chatMessages.scrollHeight,
                behavior: 'smooth'
            });
        };

        // Space Invaders Game
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        
        // Game state
        let gameRunning = false;
        let gamePaused = false;
        let score = 0;
        let level = 1;
        let lives = 3;
        
        // Player
        const player = {
            x: canvas.width / 2 - 25,
            y: canvas.height - 50,
            width: 50,
            height: 30,
            speed: 7,
            color: '#00f260'
        };
        
        // Bullets
        let bullets = [];
        const bulletSpeed = 8;
        
        // Enemy bullets
        let enemyBullets = [];
        const enemyBulletSpeed = 4;
        
        // Aliens
        let aliens = [];
        const alienRows = 5;
        const alienCols = 10;
        const alienWidth = 40;
        const alienHeight = 30;
        const alienPadding = 10;
        let alienDirection = 1;
        let alienSpeed = 1;
        let alienDropAmount = 20;
        
        // Particles for explosions
        let particles = [];
        
        // Stars background
        let stars = [];
        for (let i = 0; i < 100; i++) {
            stars.push({
                x: Math.random() * canvas.width,
                y: Math.random() * canvas.height,
                size: Math.random() * 2 + 0.5,
                speed: Math.random() * 0.5 + 0.1,
                opacity: Math.random() * 0.5 + 0.5
            });
        }
        
        // Alien colors by row
        const alienColors = ['#f093fb', '#667eea', '#00f260', '#f5576c', '#ffd700'];
        
        // Controls
        const keys = {
            left: false,
            right: false,
            space: false
        };
        
        let lastShot = 0;
        const shootCooldown = 250;
        
        // Initialize aliens
        function initAliens() {
            aliens = [];
            for (let row = 0; row < alienRows; row++) {
                for (let col = 0; col < alienCols; col++) {
                    aliens.push({
                        x: col * (alienWidth + alienPadding) + 50,
                        y: row * (alienHeight + alienPadding) + 40,
                        width: alienWidth,
                        height: alienHeight,
                        color: alienColors[row],
                        alive: true,
                        pulsePhase: Math.random() * Math.PI * 2
                    });
                }
            }
        }
        
        // Create explosion particles
        function createExplosion(x, y, color) {
            for (let i = 0; i < 15; i++) {
                particles.push({
                    x: x,
                    y: y,
                    vx: (Math.random() - 0.5) * 8,
                    vy: (Math.random() - 0.5) * 8,
                    life: 1,
                    color: color,
                    size: Math.random() * 4 + 2
                });
            }
        }
        
        // Draw functions
        function drawStars() {
            stars.forEach(star => {
                ctx.fillStyle = `rgba(255, 255, 255, ${star.opacity})`;
                ctx.beginPath();
                ctx.arc(star.x, star.y, star.size, 0, Math.PI * 2);
                ctx.fill();
                
                star.y += star.speed;
                if (star.y > canvas.height) {
                    star.y = 0;
                    star.x = Math.random() * canvas.width;
                }
            });
        }
        
        function drawPlayer() {
            ctx.save();
            
            // Glow effect
            ctx.shadowColor = player.color;
            ctx.shadowBlur = 20;
            
            // Ship body
            const gradient = ctx.createLinearGradient(player.x, player.y + player.height, player.x, player.y);
            gradient.addColorStop(0, '#0575e6');
            gradient.addColorStop(1, '#00f260');
            
            ctx.fillStyle = gradient;
            ctx.beginPath();
            ctx.moveTo(player.x + player.width / 2, player.y);
            ctx.lineTo(player.x + player.width, player.y + player.height);
            ctx.lineTo(player.x + player.width - 10, player.y + player.height);
            ctx.lineTo(player.x + player.width / 2, player.y + player.height - 10);
            ctx.lineTo(player.x + 10, player.y + player.height);
            ctx.lineTo(player.x, player.y + player.height);
            ctx.closePath();
            ctx.fill();
            
            // Cockpit
            ctx.fillStyle = '#fff';
            ctx.shadowBlur = 10;
            ctx.beginPath();
            ctx.arc(player.x + player.width / 2, player.y + 12, 5, 0, Math.PI * 2);
            ctx.fill();
            
            ctx.restore();
        }
        
        function drawAliens() {
            const time = Date.now() / 1000;
            
            aliens.forEach(alien => {
                if (!alien.alive) return;
                
                ctx.save();
                
                const pulse = Math.sin(time * 3 + alien.pulsePhase) * 0.2 + 0.8;
                
                // Glow
                ctx.shadowColor = alien.color;
                ctx.shadowBlur = 15 * pulse;
                
                // Alien body
                ctx.fillStyle = alien.color;
                
                // Draw alien shape (classic invader style)
                const cx = alien.x + alien.width / 2;
                const cy = alien.y + alien.height / 2;
                
                ctx.beginPath();
                // Body
                ctx.roundRect(alien.x + 5, alien.y + 5, alien.width - 10, alien.height - 10, 5);
                ctx.fill();
                
                // Eyes
                ctx.fillStyle = '#0f0f23';
                ctx.beginPath();
                ctx.arc(cx - 8, cy - 2, 4, 0, Math.PI * 2);
                ctx.arc(cx + 8, cy - 2, 4, 0, Math.PI * 2);
                ctx.fill();
                
                // Antennae
                ctx.strokeStyle = alien.color;
                ctx.lineWidth = 2;
                ctx.beginPath();
                ctx.moveTo(cx - 10, alien.y + 5);
                ctx.lineTo(cx - 15, alien.y - 5);
                ctx.moveTo(cx + 10, alien.y + 5);
                ctx.lineTo(cx + 15, alien.y - 5);
                ctx.stroke();
                
                ctx.restore();
            });
        }
        
        function drawBullets() {
            ctx.save();
            
            bullets.forEach(bullet => {
                ctx.shadowColor = '#00f260';
                ctx.shadowBlur = 10;
                ctx.fillStyle = '#00f260';
                ctx.fillRect(bullet.x - 2, bullet.y, 4, 15);
            });
            
            enemyBullets.forEach(bullet => {
                ctx.shadowColor = '#f5576c';
                ctx.shadowBlur = 10;
                ctx.fillStyle = '#f5576c';
                ctx.fillRect(bullet.x - 2, bullet.y, 4, 15);
            });
            
            ctx.restore();
        }
        
        function drawParticles() {
            particles.forEach(p => {
                ctx.save();
                ctx.globalAlpha = p.life;
                ctx.shadowColor = p.color;
                ctx.shadowBlur = 10;
                ctx.fillStyle = p.color;
                ctx.beginPath();
                ctx.arc(p.x, p.y, p.size * p.life, 0, Math.PI * 2);
                ctx.fill();
                ctx.restore();
            });
        }
        
        function drawGameOver() {
            ctx.save();
            ctx.fillStyle = 'rgba(15, 15, 35, 0.8)';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            ctx.shadowColor = '#f093fb';
            ctx.shadowBlur = 30;
            ctx.fillStyle = '#f093fb';
            ctx.font = 'bold 48px Segoe UI';
            ctx.textAlign = 'center';
            ctx.fillText('GAME OVER', canvas.width / 2, canvas.height / 2 - 20);
            
            ctx.shadowBlur = 10;
            ctx.font = '24px Segoe UI';
            ctx.fillStyle = '#667eea';
            ctx.fillText(`Final Score: ${score}`, canvas.width / 2, canvas.height / 2 + 30);
            
            ctx.restore();
        }
        
        // Update functions
        function updatePlayer() {
            if (keys.left && player.x > 0) {
                player.x -= player.speed;
            }
            if (keys.right && player.x < canvas.width - player.width) {
                player.x += player.speed;
            }
            if (keys.space && Date.now() - lastShot > shootCooldown) {
                bullets.push({
                    x: player.x + player.width / 2,
                    y: player.y
                });
                lastShot = Date.now();
            }
        }
        
        function updateBullets() {
            bullets = bullets.filter(bullet => {
                bullet.y -= bulletSpeed;
                return bullet.y > 0;
            });
            
            enemyBullets = enemyBullets.filter(bullet => {
                bullet.y += enemyBulletSpeed;
                return bullet.y < canvas.height;
            });
        }
        
        function updateAliens() {
            let hitEdge = false;
            let lowestY = 0;
            
            aliens.forEach(alien => {
                if (!alien.alive) return;
                
                alien.x += alienSpeed * alienDirection;
                
                if (alien.x <= 0 || alien.x + alien.width >= canvas.width) {
                    hitEdge = true;
                }
                
                if (alien.y + alien.height > lowestY) {
                    lowestY = alien.y + alien.height;
                }
            });
            
            if (hitEdge) {
                alienDirection *= -1;
                aliens.forEach(alien => {
                    alien.y += alienDropAmount;
                });
            }
            
            // Check if aliens reached player
            if (lowestY >= player.y) {
                lives = 0;
                gameRunning = false;
            }
            
            // Random alien shooting
            if (Math.random() < 0.02 * level) {
                const aliveAliens = aliens.filter(a => a.alive);
                if (aliveAliens.length > 0) {
                    const shooter = aliveAliens[Math.floor(Math.random() * aliveAliens.length)];
                    enemyBullets.push({
                        x: shooter.x + shooter.width / 2,
                        y: shooter.y + shooter.height
                    });
                }
            }
        }
        
        function updateParticles() {
            particles = particles.filter(p => {
                p.x += p.vx;
                p.y += p.vy;
                p.life -= 0.02;
                p.vx *= 0.98;
                p.vy *= 0.98;
                return p.life > 0;
            });
        }
        
        function checkCollisions() {
            // Bullets vs Aliens
            bullets.forEach((bullet, bi) => {
                aliens.forEach(alien => {
                    if (!alien.alive) return;
                    
                    if (bullet.x > alien.x && bullet.x < alien.x + alien.width &&
                        bullet.y > alien.y && bullet.y < alien.y + alien.height) {
                        alien.alive = false;
                        bullets.splice(bi, 1);
                        score += 10 * level;
                        document.getElementById('score').textContent = score;
                        createExplosion(alien.x + alien.width / 2, alien.y + alien.height / 2, alien.color);
                    }
                });
            });
            
            // Enemy bullets vs Player
            enemyBullets.forEach((bullet, bi) => {
                if (bullet.x > player.x && bullet.x < player.x + player.width &&
                    bullet.y > player.y && bullet.y < player.y + player.height) {
                    enemyBullets.splice(bi, 1);
                    lives--;
                    document.getElementById('lives').textContent = lives;
                    createExplosion(player.x + player.width / 2, player.y + player.height / 2, '#00f260');
                    
                    if (lives <= 0) {
                        gameRunning = false;
                    }
                }
            });
            
            // Check level complete
            if (aliens.every(a => !a.alive)) {
                level++;
                document.getElementById('level').textContent = level;
                alienSpeed = 1 + level * 0.5;
                initAliens();
            }
        }
        
        // Game loop
        function gameLoop() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            drawStars();
            
            if (gameRunning && !gamePaused) {
                updatePlayer();
                updateBullets();
                updateAliens();
                updateParticles();
                checkCollisions();
            }
            
            drawAliens();
            drawPlayer();
            drawBullets();
            drawParticles();
            
            if (!gameRunning && lives <= 0) {
                drawGameOver();
            }
            
            requestAnimationFrame(gameLoop);
        }
        
        // Event listeners
        document.addEventListener('keydown', (e) => {
            if (e.key === 'ArrowLeft' || e.key === 'a') keys.left = true;
            if (e.key === 'ArrowRight' || e.key === 'd') keys.right = true;
            if (e.key === ' ') {
                e.preventDefault();
                keys.space = true;
            }
        });
        
        document.addEventListener('keyup', (e) => {
            if (e.key === 'ArrowLeft' || e.key === 'a') keys.left = false;
            if (e.key === 'ArrowRight' || e.key === 'd') keys.right = false;
            if (e.key === ' ') keys.space = false;
        });
        
        document.getElementById('startBtn').addEventListener('click', () => {
            score = 0;
            level = 1;
            lives = 3;
            alienSpeed = 1;
            bullets = [];
            enemyBullets = [];
            particles = [];
            player.x = canvas.width / 2 - 25;
            
            document.getElementById('score').textContent = score;
            document.getElementById('level').textContent = level;
            document.getElementById('lives').textContent = lives;
            
            initAliens();
            gameRunning = true;
            gamePaused = false;
        });
        
        document.getElementById('pauseBtn').addEventListener('click', () => {
            if (gameRunning) {
                gamePaused = !gamePaused;
                document.getElementById('pauseBtn').textContent = gamePaused ? 'Resume' : 'Pause';
            }
        });
        
        // Initialize and start
        initAliens();
        gameLoop();

        // Chat panel toggle
        (function() {
            const btn = document.createElement('button');
            btn.className = 'chat-toggle';
            btn.setAttribute('aria-label', 'Toggle chat panel');
            const dots = document.createElement('span');
            dots.className = 'chat-toggle-dots';
            for (let i = 0; i < 3; i++) {
                const dot = document.createElement('span');
                dot.className = 'chat-toggle-dot';
                dots.appendChild(dot);
            }
            btn.appendChild(dots);
            document.body.appendChild(btn);

            const STORAGE_KEY = 'synthos-chat-collapsed';

            // Restore persisted state
            if (localStorage.getItem(STORAGE_KEY) === 'true') {
                document.body.classList.add('chat-collapsed');
            }

            btn.addEventListener('click', function() {
                document.body.classList.toggle('chat-collapsed');
                localStorage.setItem(STORAGE_KEY, document.body.classList.contains('chat-collapsed'));
            });
        })();

        // Focus management ‚Äî prevent viewer content from stealing keystrokes
        (function() {
            const chatInput = document.getElementById('chatInput');
            const viewerPanel = document.getElementById('viewerPanel');

            chatInput.addEventListener('mousedown', function(e) {
                e.stopPropagation();
            });

            ['keydown', 'keyup', 'keypress'].forEach(type => {
                document.addEventListener(type, function(e) {
                    if (document.activeElement === chatInput) {
                        e.stopImmediatePropagation();
                    }
                }, true);
            });

            viewerPanel.setAttribute('tabindex', '-1');
            chatInput.addEventListener('blur', function() {
                viewerPanel.focus();
            });
        })();
    </script>
</body>
</html>