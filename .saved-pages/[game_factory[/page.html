<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SynthOS</title>
    <style>
        *{margin:0;padding:0;box-sizing:border-box}body{font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;background:linear-gradient(135deg,#1a1a2e 0%,#16213e 50%,#0f0f23 100%);color:#e0e0e0;height:100vh;display:flex;overflow:hidden}.chat-panel{width:30%;min-width:300px;background:linear-gradient(180deg,rgba(26,26,46,0.95) 0%,rgba(22,33,62,0.95) 100%);box-shadow:0 0 30px rgba(138,43,226,0.2),inset 0 0 60px rgba(75,0,130,0.1);padding:20px;display:flex;flex-direction:column;border-right:1px solid rgba(138,43,226,0.3);position:relative;z-index:10;transform:translateX(0);transition:transform 0.4s cubic-bezier(0.4,0,0.2,1),margin-right 0.4s cubic-bezier(0.4,0,0.2,1);flex-shrink:0}.chat-panel.collapsed{transform:translateX(-100%);margin-right:calc(-30% + 45px)}.chat-panel .chat-content{display:flex;flex-direction:column;height:100%;opacity:1;transition:opacity 0.2s ease}.chat-panel.collapsed .chat-content{opacity:0}.chat-header{font-size:24px;padding:15px;background:linear-gradient(135deg,#667eea 0%,#764ba2 50%,#f093fb 100%);color:#fff;text-align:center;border-radius:15px;box-shadow:0 4px 20px rgba(102,126,234,0.4);text-shadow:0 2px 10px rgba(0,0,0,0.3);letter-spacing:2px;flex-shrink:0}.chat-messages{flex-grow:1;overflow-y:auto;padding:15px;margin-top:15px;background:rgba(15,15,35,0.6);border-radius:15px;border:1px solid rgba(138,43,226,0.2);box-shadow:inset 0 0 30px rgba(75,0,130,0.2)}.chat-message{margin-bottom:15px;padding:12px 15px;background:linear-gradient(135deg,rgba(102,126,234,0.15) 0%,rgba(118,75,162,0.15) 100%);border-radius:15px;box-shadow:0 2px 10px rgba(138,43,226,0.2);border:1px solid rgba(138,43,226,0.1);backdrop-filter:blur(5px)}.chat-message p{margin-bottom:5px;line-height:1.5}.chat-message p strong{font-weight:600;background:linear-gradient(90deg,#667eea,#f093fb);-webkit-background-clip:text;background-clip:text;-webkit-text-fill-color:transparent}.chat-message p code{background:rgba(138,43,226,0.3);padding:2px 6px;border-radius:5px;font-family:'Courier New',Courier,monospace;color:#f093fb;border:1px solid rgba(240,147,251,0.3)}.link-group{display:flex;justify-content:space-between;margin:15px 0;padding:10px;background:rgba(15,15,35,0.4);border-radius:10px;border:1px solid rgba(138,43,226,0.2);flex-shrink:0}.link-group a{font-size:14px;color:#b794f6;text-decoration:none;padding:8px 12px;border-radius:8px;transition:all 0.3s ease;border:1px solid transparent}.link-group a:hover{background:linear-gradient(135deg,rgba(102,126,234,0.3) 0%,rgba(118,75,162,0.3) 100%);border-color:rgba(183,148,246,0.5);box-shadow:0 0 15px rgba(138,43,226,0.3);color:#f093fb}.link-group a.disabled{opacity:0.4;pointer-events:none;cursor:not-allowed}form{display:flex;flex-direction:row;width:100%;gap:10px;align-items:center;flex-shrink:0}.input-wrapper{position:relative;flex-grow:1;display:flex;align-items:center}.chat-input{padding:14px 50px 14px 18px;border:1px solid rgba(138,43,226,0.3);border-radius:25px;width:100%;font-size:14px;background:rgba(15,15,35,0.8);color:#e0e0e0;box-shadow:inset 0 2px 10px rgba(0,0,0,0.3),0 0 20px rgba(138,43,226,0.1);transition:all 0.3s ease}.chat-input:focus{outline:none;border-color:rgba(183,148,246,0.6);box-shadow:inset 0 2px 10px rgba(0,0,0,0.3),0 0 25px rgba(138,43,226,0.3)}.chat-input::placeholder{color:rgba(183,148,246,0.5)}.chat-input:disabled{opacity:0.5;cursor:not-allowed}.mic-button{position:absolute;right:8px;top:50%;transform:translateY(-50%);width:34px;height:34px;border:none;border-radius:50%;background:linear-gradient(135deg,rgba(102,126,234,0.4) 0%,rgba(118,75,162,0.4) 100%);color:#b794f6;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all 0.3s ease;padding:0;border:1px solid rgba(138,43,226,0.3)}.mic-button:hover{background:linear-gradient(135deg,rgba(102,126,234,0.6) 0%,rgba(118,75,162,0.6) 100%);color:#f093fb;box-shadow:0 0 15px rgba(138,43,226,0.4);border-color:rgba(183,148,246,0.5)}.mic-button.recording{background:linear-gradient(135deg,#667eea 0%,#764ba2 50%,#f093fb 100%);color:#fff;box-shadow:0 0 20px rgba(138,43,226,0.6);animation:pulse-mic 1.5s ease-in-out infinite}@keyframes pulse-mic{0%,100%{transform:translateY(-50%) scale(1);box-shadow:0 0 20px rgba(138,43,226,0.6)}50%{transform:translateY(-50%) scale(1.05);box-shadow:0 0 30px rgba(240,147,251,0.7)}}.mic-button svg{width:18px;height:18px;fill:currentColor}.mic-button:disabled{opacity:0.4;cursor:not-allowed;pointer-events:none}.recording-indicator{position:absolute;bottom:30px;left:50%;transform:translateX(-50%);display:flex;align-items:center;gap:10px;opacity:0;visibility:hidden;transition:opacity 0.3s ease,visibility 0.3s ease;pointer-events:none;z-index:1000;padding:10px 20px;background:rgba(15,15,35,0.7);border-radius:20px;border:1px solid rgba(138,43,226,0.2);backdrop-filter:blur(5px)}.recording-indicator.active{opacity:1;visibility:visible}.sound-waves{display:flex;align-items:center;gap:3px;height:18px}.sound-wave{width:3px;background:linear-gradient(180deg,#667eea 0%,#b794f6 100%);border-radius:2px;animation:sound-wave 0.6s ease-in-out infinite}.sound-wave:nth-child(1){height:8px;animation-delay:0s}.sound-wave:nth-child(2){height:12px;animation-delay:0.1s}.sound-wave:nth-child(3){height:18px;animation-delay:0.2s}.sound-wave:nth-child(4){height:12px;animation-delay:0.3s}.sound-wave:nth-child(5){height:8px;animation-delay:0.4s}@keyframes sound-wave{0%,60%,100%{transform:scaleY(0.5);opacity:0.5}50%{transform:scaleY(1);opacity:1}}.recording-text{font-size:12px;color:#b794f6;font-weight:500;letter-spacing:1px;text-transform:uppercase}.chat-submit{width:40px;height:40px;min-width:40px;padding:0;border:none;border-radius:50%;font-size:14px;background:linear-gradient(135deg,#667eea 0%,#764ba2 50%,#f093fb 100%);color:#fff;cursor:pointer;transition:all 0.3s ease;font-weight:600;box-shadow:0 4px 20px rgba(102,126,234,0.4);display:flex;align-items:center;justify-content:center}.chat-submit:hover{transform:translateY(-2px);box-shadow:0 6px 25px rgba(102,126,234,0.6)}.chat-submit:active{transform:translateY(0)}.chat-submit:disabled{opacity:0.4;cursor:not-allowed;transform:none;box-shadow:none}.chat-submit svg{width:20px;height:20px;fill:#fff}.viewer-panel{flex:1;padding:0;background:linear-gradient(135deg,rgba(22,33,62,0.9) 0%,rgba(15,15,35,0.95) 100%);display:flex;flex-direction:column;justify-content:center;align-items:center;box-shadow:inset 0 0 60px rgba(75,0,130,0.15);position:relative;overflow:hidden;transition:all 0.4s cubic-bezier(0.4,0,0.2,1)}.loading-overlay{display:none;position:absolute;top:0;left:0;width:100%;height:100%;background:rgba(15,15,35,0.85);justify-content:center;align-items:center;z-index:50;backdrop-filter:blur(5px)}.loading-overlay.active{display:flex}.loading-container{display:flex;flex-direction:column;align-items:center;gap:20px}.spinner{width:60px;height:60px;border:4px solid rgba(138,43,226,0.2);border-top-color:#f093fb;border-right-color:#764ba2;border-radius:50%;animation:spin 1s linear infinite;box-shadow:0 0 30px rgba(138,43,226,0.3)}@keyframes spin{to{transform:rotate(360deg)}}.loading-text{color:#b794f6;font-size:14px;letter-spacing:2px;text-transform:uppercase;animation:pulse-text 1.5s ease-in-out infinite}@keyframes pulse-text{0%,100%{opacity:0.5}50%{opacity:1}}.toggle-chat-btn{position:fixed;left:15px;top:50%;transform:translateY(-50%);width:30px;height:60px;background:linear-gradient(135deg,#667eea 0%,#764ba2 50%,#f093fb 100%);border:none;border-radius:0 10px 10px 0;cursor:pointer;z-index:100;display:flex;align-items:center;justify-content:center;box-shadow:0 4px 20px rgba(102,126,234,0.4);transition:left 0.4s cubic-bezier(0.4,0,0.2,1),box-shadow 0.3s ease}.toggle-chat-btn:hover{box-shadow:0 6px 25px rgba(102,126,234,0.6)}.toggle-chat-btn svg{width:16px;height:16px;fill:#fff;transition:transform 0.3s ease;transform:rotate(180deg)}.toggle-chat-btn.expanded{left:calc(30% - 15px)}.toggle-chat-btn.expanded svg{transform:rotate(0deg)}.modal-overlay{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(10,10,20,0.85);backdrop-filter:blur(8px);z-index:2000;justify-content:center;align-items:center;opacity:0;transition:opacity 0.3s ease}.modal-overlay.active{display:flex;opacity:1}.save-modal{background:linear-gradient(135deg,rgba(26,26,46,0.98) 0%,rgba(22,33,62,0.98) 100%);border-radius:20px;padding:0;width:420px;max-width:90%;box-shadow:0 20px 60px rgba(0,0,0,0.5),0 0 40px rgba(138,43,226,0.3),inset 0 1px 0 rgba(255,255,255,0.1);border:1px solid rgba(138,43,226,0.3);transform:scale(0.9) translateY(20px);transition:transform 0.3s ease;overflow:hidden}.modal-overlay.active .save-modal{transform:scale(1) translateY(0)}.modal-header{background:linear-gradient(135deg,#667eea 0%,#764ba2 50%,#f093fb 100%);padding:20px 25px;display:flex;align-items:center;justify-content:space-between}.modal-header h2{color:#fff;font-size:18px;font-weight:600;letter-spacing:1px;text-shadow:0 2px 10px rgba(0,0,0,0.3);display:flex;align-items:center;gap:10px}.modal-header h2 svg{width:22px;height:22px;fill:#fff}.modal-close{background:rgba(255,255,255,0.2);border:none;width:32px;height:32px;border-radius:50%;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all 0.3s ease}.modal-close:hover{background:rgba(255,255,255,0.3);transform:rotate(90deg)}.modal-close svg{width:16px;height:16px;fill:#fff}.modal-body{padding:25px}.modal-label{display:block;color:#b794f6;font-size:13px;font-weight:600;letter-spacing:0.5px;margin-bottom:10px;text-transform:uppercase}.modal-input-wrapper{position:relative;margin-bottom:20px}.modal-input{width:100%;padding:16px 20px;padding-right:45px;border:2px solid rgba(138,43,226,0.3);border-radius:12px;background:rgba(15,15,35,0.8);color:#e0e0e0;font-size:16px;transition:all 0.3s ease}.modal-input:focus{outline:none;border-color:#b794f6;box-shadow:0 0 20px rgba(138,43,226,0.3)}.modal-input::placeholder{color:rgba(183,148,246,0.4)}.input-icon{position:absolute;right:15px;top:50%;transform:translateY(-50%);width:20px;height:20px;fill:rgba(183,148,246,0.5)}.modal-footer{display:flex;gap:12px;justify-content:flex-end}.modal-btn{padding:12px 24px;border-radius:10px;font-size:14px;font-weight:600;letter-spacing:0.5px;cursor:pointer;transition:all 0.3s ease;border:none}.modal-btn-cancel{background:rgba(255,255,255,0.1);color:#b794f6;border:1px solid rgba(138,43,226,0.3)}.modal-btn-cancel:hover{background:rgba(255,255,255,0.15);border-color:rgba(183,148,246,0.5)}.modal-btn-save{background:linear-gradient(135deg,#667eea 0%,#764ba2 50%,#f093fb 100%);color:#fff;box-shadow:0 4px 15px rgba(102,126,234,0.4)}.modal-btn-save:hover{transform:translateY(-2px);box-shadow:0 6px 20px rgba(102,126,234,0.6)}.modal-btn-save:active{transform:translateY(0)}::-webkit-scrollbar{width:10px;height:10px}::-webkit-scrollbar-track{background:rgba(15,15,35,0.6);border-radius:10px}::-webkit-scrollbar-thumb{background:linear-gradient(180deg,#667eea 0%,#764ba2 50%,#f093fb 100%);border-radius:10px;border:2px solid rgba(15,15,35,0.6);box-shadow:0 0 10px rgba(138,43,226,0.4)}::-webkit-scrollbar-thumb:hover{background:linear-gradient(180deg,#f093fb 0%,#764ba2 50%,#667eea 100%);box-shadow:0 0 15px rgba(240,147,251,0.5)}::-webkit-scrollbar-corner{background:rgba(15,15,35,0.6)}*{scrollbar-width:thin;scrollbar-color:#764ba2 rgba(15,15,35,0.6)}
        .game-factory{width:100%;height:100%;display:flex;flex-direction:column;background:linear-gradient(135deg,rgba(102,126,234,0.08) 0%,rgba(118,75,162,0.08) 100%);overflow:hidden}
        .gf-header{background:linear-gradient(135deg,rgba(102,126,234,0.2) 0%,rgba(118,75,162,0.2) 100%);padding:12px 20px;position:relative;overflow:hidden;border-bottom:1px solid rgba(138,43,226,0.2)}
        .gf-header-content{display:flex;align-items:center;justify-content:center;gap:10px;position:relative;z-index:2}
        .gf-header h1{color:#fff;font-size:18px;font-weight:600;display:flex;align-items:center;gap:8px}
        .gf-header .factory-icon{font-size:20px}
        .gf-floating-ideas{position:absolute;top:0;left:0;width:100%;height:100%;overflow:hidden;pointer-events:none}
        .gf-idea{position:absolute;font-size:11px;color:rgba(183,148,246,0.6);white-space:nowrap;animation:float-idea 12s linear infinite;opacity:0}
        .gf-idea:nth-child(1){top:20%;animation-delay:0s}
        .gf-idea:nth-child(2){top:50%;animation-delay:3s}
        .gf-idea:nth-child(3){top:80%;animation-delay:6s}
        .gf-idea:nth-child(4){top:35%;animation-delay:9s}
        @keyframes float-idea{0%{left:-200px;opacity:0}10%{opacity:0.7}90%{opacity:0.7}100%{left:calc(100% + 200px);opacity:0}}
        .gf-chat-area{flex:1;overflow-y:auto;padding:20px;display:flex;flex-direction:column;gap:15px}
        .gf-message{max-width:80%;padding:15px 20px;border-radius:20px;font-size:15px;line-height:1.6;animation:fadeIn 0.3s ease;max-height:200px;overflow-y:auto}
        .gf-message.bot{align-self:flex-start;background:linear-gradient(135deg,rgba(102,126,234,0.15) 0%,rgba(118,75,162,0.15) 100%);border:1px solid rgba(138,43,226,0.3);border-bottom-left-radius:5px}
        .gf-message.user{align-self:flex-end;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:#fff;border-bottom-right-radius:5px}
        .gf-message::-webkit-scrollbar{width:6px}
        .gf-message::-webkit-scrollbar-thumb{background:rgba(138,43,226,0.4);border-radius:3px}
        @keyframes fadeIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
        .gf-input-area{padding:20px;background:rgba(0,0,0,0.3);display:flex;gap:12px;align-items:center;flex-wrap:wrap}
        .gf-input{flex:1;min-width:200px;padding:16px 20px;border:2px solid rgba(138,43,226,0.3);border-radius:25px;background:rgba(0,0,0,0.4);color:#fff;font-size:15px}
        .gf-input:focus{outline:none;border-color:#b794f6;box-shadow:0 0 15px rgba(138,43,226,0.3)}
        .gf-input::placeholder{color:rgba(255,255,255,0.5)}
        .gf-mic-btn{width:50px;height:50px;border:none;border-radius:50%;background:linear-gradient(135deg,rgba(102,126,234,0.4) 0%,rgba(118,75,162,0.4) 100%);color:#fff;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all 0.3s ease;border:2px solid rgba(138,43,226,0.3)}
        .gf-mic-btn:hover{background:linear-gradient(135deg,rgba(102,126,234,0.6) 0%,rgba(118,75,162,0.6) 100%);transform:scale(1.05)}
        .gf-mic-btn.recording{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);animation:pulse-gf 1.5s ease-in-out infinite;border-color:#b794f6}
        @keyframes pulse-gf{0%,100%{transform:scale(1);box-shadow:0 0 0 0 rgba(138,43,226,0.4)}50%{transform:scale(1.05);box-shadow:0 0 20px 10px rgba(138,43,226,0.2)}}
        .gf-mic-btn svg{width:24px;height:24px;fill:currentColor}
        .gf-mic-btn:disabled{opacity:0.4;cursor:not-allowed}
        .gf-send-btn{width:50px;height:50px;border:none;border-radius:50%;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:#fff;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all 0.3s ease;box-shadow:0 4px 15px rgba(102,126,234,0.4)}
        .gf-send-btn:hover{transform:scale(1.1);box-shadow:0 6px 20px rgba(102,126,234,0.6)}
        .gf-send-btn:disabled{opacity:0.4;cursor:not-allowed;transform:none;box-shadow:none}
        .gf-send-btn svg{width:22px;height:22px;fill:#fff}
        .gf-build-btn{padding:14px 28px;border:none;border-radius:25px;background:linear-gradient(135deg,#f093fb 0%,#764ba2 100%);color:#fff;font-size:14px;font-weight:700;cursor:pointer;transition:all 0.3s ease;text-transform:uppercase;letter-spacing:1px;box-shadow:0 4px 15px rgba(240,147,251,0.4);display:flex;align-items:center;gap:8px;opacity:0.3;pointer-events:none;transform:scale(0.95)}
        .gf-build-btn.active{opacity:1;pointer-events:auto;transform:scale(1)}
        .gf-build-btn:hover{transform:scale(1.05);box-shadow:0 6px 20px rgba(240,147,251,0.5)}
        .gf-build-btn svg{width:18px;height:18px;fill:#fff}
        .gf-typing{display:flex;gap:6px;padding:15px 20px;align-self:flex-start;background:linear-gradient(135deg,rgba(102,126,234,0.15) 0%,rgba(118,75,162,0.15) 100%);border-radius:20px;border-bottom-left-radius:5px}
        .gf-typing span{width:10px;height:10px;background:#b794f6;border-radius:50%;animation:typing 1.4s infinite ease-in-out}
        .gf-typing span:nth-child(1){animation-delay:0s}
        .gf-typing span:nth-child(2){animation-delay:0.2s}
        .gf-typing span:nth-child(3){animation-delay:0.4s}
        @keyframes typing{0%,60%,100%{transform:translateY(0)}30%{transform:translateY(-10px)}}
        .gf-recording-indicator{display:none;align-items:center;gap:10px;padding:10px 20px;background:rgba(138,43,226,0.2);border-radius:25px;border:1px solid rgba(138,43,226,0.3)}
        .gf-recording-indicator.active{display:flex}
        .gf-waves{display:flex;gap:4px;height:20px}
        .gf-wave{width:4px;background:linear-gradient(180deg,#667eea 0%,#f093fb 100%);border-radius:2px;animation:wave 0.6s ease-in-out infinite}
        .gf-wave:nth-child(1){height:8px;animation-delay:0s}
        .gf-wave:nth-child(2){height:12px;animation-delay:0.1s}
        .gf-wave:nth-child(3){height:20px;animation-delay:0.2s}
        .gf-wave:nth-child(4){height:12px;animation-delay:0.3s}
        .gf-wave:nth-child(5){height:8px;animation-delay:0.4s}
        @keyframes wave{0%,100%{transform:scaleY(0.5)}50%{transform:scaleY(1)}}
        .gf-rec-text{font-size:12px;color:#b794f6;text-transform:uppercase;letter-spacing:1px;font-weight:600}
        .build-modal-overlay{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(10,10,20,0.9);backdrop-filter:blur(10px);z-index:3000;justify-content:center;align-items:center;opacity:0;transition:opacity 0.3s ease}
        .build-modal-overlay.active{display:flex;opacity:1}
        .build-modal{background:linear-gradient(135deg,rgba(26,26,46,0.98) 0%,rgba(22,33,62,0.98) 100%);border-radius:25px;padding:0;width:600px;max-width:90%;max-height:80vh;box-shadow:0 20px 60px rgba(0,0,0,0.5),0 0 60px rgba(138,43,226,0.4);border:1px solid rgba(138,43,226,0.3);transform:scale(0.9) translateY(20px);transition:transform 0.3s ease;overflow:hidden;display:flex;flex-direction:column}
        .build-modal-overlay.active .build-modal{transform:scale(1) translateY(0)}
        .build-modal-header{background:linear-gradient(135deg,#667eea 0%,#764ba2 50%,#f093fb 100%);padding:25px;display:flex;align-items:center;justify-content:space-between}
        .build-modal-header h2{color:#fff;font-size:22px;font-weight:700;letter-spacing:1px;display:flex;align-items:center;gap:12px}
        .build-modal-header h2 svg{width:28px;height:28px;fill:#fff}
        .build-modal-close{background:rgba(255,255,255,0.2);border:none;width:36px;height:36px;border-radius:50%;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all 0.3s ease}
        .build-modal-close:hover{background:rgba(255,255,255,0.3);transform:rotate(90deg)}
        .build-modal-close svg{width:18px;height:18px;fill:#fff}
        .build-modal-body{padding:25px;flex:1;overflow-y:auto}
        .build-prompt-area{background:rgba(15,15,35,0.8);border:1px solid rgba(138,43,226,0.3);border-radius:15px;padding:20px;min-height:200px;max-height:300px;overflow-y:auto;color:#e0e0e0;font-size:14px;line-height:1.8;white-space:pre-wrap}
        .build-modal-footer{padding:20px 25px;background:rgba(0,0,0,0.3);display:flex;gap:15px;justify-content:flex-end}
        .build-modal-btn{padding:14px 30px;border-radius:25px;font-size:15px;font-weight:600;cursor:pointer;transition:all 0.3s ease;border:none;display:flex;align-items:center;gap:8px}
        .build-modal-btn-cancel{background:rgba(255,255,255,0.1);color:#b794f6;border:1px solid rgba(138,43,226,0.3)}
        .build-modal-btn-cancel:hover{background:rgba(255,255,255,0.15)}
        .build-modal-btn-go{background:linear-gradient(135deg,#667eea 0%,#764ba2 50%,#f093fb 100%);color:#fff;box-shadow:0 4px 20px rgba(102,126,234,0.5)}
        .build-modal-btn-go:hover{transform:translateY(-2px);box-shadow:0 6px 25px rgba(102,126,234,0.7)}
        .build-modal-btn-go svg{width:18px;height:18px;fill:#fff}
        .build-loading{display:none;flex-direction:column;align-items:center;gap:15px;padding:40px}
        .build-loading.active{display:flex}
        .build-loading .spinner{width:50px;height:50px;border:4px solid rgba(138,43,226,0.2);border-top-color:#f093fb;border-radius:50%;animation:spin 1s linear infinite}
        .build-loading-text{color:#b794f6;font-size:14px;letter-spacing:1px}
    </style>
</head>
<body>
    <div class="modal-overlay" id="saveModal">
        <div class="save-modal">
            <div class="modal-header">
                <h2><svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M17 3H5c-1.11 0-2 .9-2 2v14c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V7l-4-4zm-5 16c-1.66 0-3-1.34-3-3s1.34-3 3-3 3 1.34 3 3-1.34 3-3 3zm3-10H5V5h10v4z"/></svg>Save Page</h2>
                <button class="modal-close" id="modalClose"><svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg></button>
            </div>
            <div class="modal-body">
                <label class="modal-label" for="savePageName">Page Name</label>
                <div class="modal-input-wrapper">
                    <input type="text" class="modal-input" id="savePageName" placeholder="Enter page name...">
                    <svg class="input-icon" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M14 2H6c-1.1 0-1.99.9-1.99 2L4 20c0 1.1.89 2 1.99 2H18c1.1 0 2-.9 2-2V8l-6-6zm2 16H8v-2h8v2zm0-4H8v-2h8v2zm-3-5V3.5L18.5 9H13z"/></svg>
                </div>
                <div class="modal-footer">
                    <button class="modal-btn modal-btn-cancel" id="modalCancel">Cancel</button>
                    <button class="modal-btn modal-btn-save" id="modalSave">Save Page</button>
                </div>
            </div>
        </div>
    </div>
    <div class="build-modal-overlay" id="buildModal">
        <div class="build-modal">
            <div class="build-modal-header">
                <h2><svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M19.35 10.04C18.67 6.59 15.64 4 12 4 9.11 4 6.6 5.64 5.35 8.04 2.34 8.36 0 10.91 0 14c0 3.31 2.69 6 6 6h13c2.76 0 5-2.24 5-5 0-2.64-2.05-4.78-4.65-4.96zM14 13v4h-4v-4H7l5-5 5 5h-3z"/></svg>Your Game Design</h2>
                <button class="build-modal-close" id="buildModalClose"><svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg></button>
            </div>
            <div class="build-modal-body">
                <div class="build-loading" id="buildLoading">
                    <div class="spinner"></div>
                    <span class="build-loading-text">Creating your game design...</span>
                </div>
                <div class="build-prompt-area" id="buildPromptArea"></div>
            </div>
            <div class="build-modal-footer">
                <button class="build-modal-btn build-modal-btn-cancel" id="buildModalCancel">Keep Chatting</button>
                <button class="build-modal-btn build-modal-btn-go" id="buildModalGo">
                    <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M13 3v6h8l-8 8v-6H5l8-8z"/></svg>
                    Build My Game!
                </button>
            </div>
        </div>
    </div>
    <div class="chat-panel collapsed" id="chatPanel">
        <div class="chat-content">
            <div class="chat-header">SynthOS</div>
            <div class="chat-messages" id="chatMessages">
                <div class="chat-message"><p><strong>SynthOS:</strong> What can I create for you?</p></div>
                <div class="chat-message"><p><strong>You:</strong> I want to build a Roblox game idea generator for my 10-year-old daughter. It should have its own chat interface powered by the LLM, with a mic button for voice input. It should let her pick a genre, interview her about her game idea, and then generate a game concept she can copy and paste to build.</p></div>
                <div class="chat-message"><p><strong>SynthOS:</strong> What a fun project for your daughter! üéÆ I've created a Roblox Game Idea Generator with genre selection, voice input, and an AI-powered interview system. She can pick a genre, chat about her ideas, and get a complete game concept with a "Build This!" button that copies it over!</p></div>
                <div class="chat-message"><p><strong>You:</strong> Let's remove the genre categories at the top - they don't seem to be helping. Just have a nice opening prompt. Make the game fullscreen, start with the SynthOS chat panel closed. Add a "Build It!" button that she can click at any point during the interview to submit her game idea to the page builder.</p></div>
                <div class="chat-message"><p><strong>SynthOS:</strong> Done! üöÄ I've made the generator fullscreen with the chat panel collapsed by default. Removed the genre buttons and added a friendly opening prompt. There's now a prominent "Build It!" button she can click anytime during the conversation to send her game idea to me for building!</p></div>
                <div class="chat-message"><p><strong>You:</strong> Rename it to "Game Factory", drop the Roblox branding, keep the green color scheme. The LLM needs to understand Roblox genres like Obby (obstacle course), Tycoon, Simulator, etc. Have it return JSON with both the chat message AND a running build prompt. Hide the Build It button until after the first message, then show it next to the send button.</p></div>
                <div class="chat-message"><p><strong>SynthOS:</strong> Done! üè≠ Renamed to "Game Factory" with the green theme. Now using the LLM API with a detailed system prompt that explains Roblox genres (Obby, Tycoon, Simulator, Roleplay, etc.). The AI returns JSON with both the message to display AND a cumulative build prompt. The "Build It!" button appears after the first user message, positioned next to send!</p></div>
                <div class="chat-message"><p><strong>You:</strong> Switch to the purple SynthOS color scheme. When she clicks Build, make an LLM call to generate a full game design prompt from the conversation, show it in a popup modal with a "Go" button that submits to SynthOS to build the actual game page.</p></div>
                <div class="chat-message"><p><strong>SynthOS:</strong> Perfect! üé® Switched to the purple SynthOS theme. Now when she clicks "Build It!", it opens a modal that calls the LLM to generate a complete game design document from the conversation. She can review it and click "Build My Game!" to send it to me - I'll redesign the entire page into her playable game!</p></div>
                <div class="chat-message"><p><strong>You:</strong> ok the mic button in game factory should work the same way as it does in the synthos button. pressing the mic turns on listening but disables the send button. you have to turn off speach to send a response</p></div>
                <div class="chat-message"><p><strong>SynthOS:</strong> Fixed! üé§ The Game Factory mic button now works exactly like the SynthOS one - when recording is active, the send button is disabled and shows the "Listening..." indicator. She has to tap the mic again to stop recording before she can send her message. This prevents accidental sends while still talking!</p></div>
                <div class="chat-message"><p><strong>You:</strong> can you give the header a super cool animation effect... whatever seems cool and fits the theme</p></div>
                <div class="chat-message"><p><strong>SynthOS:</strong> ‚ú® Done! Added some magical effects to the header: a sweeping shine animation, glowing text that pulses, the factory icon bounces and wobbles playfully, floating particles rise up like sparks from a factory, and spinning gears in the background! It's got that enchanted workshop vibe now! üè≠‚öôÔ∏è</p></div>
                <div class="chat-message"><p><strong>You:</strong> we're adding markdow response to messages so lets kap the hight of a message before we show a scroll bar... Make the header smaller and work a bit more like an add... so maybe you just show "Game Factory" waith a subtle in theme back ground but the title+subtitle floats off and game ideas float in... floats off and</p></div>
                <div class="chat-message"><p><strong>SynthOS:</strong> Done! üéØ Made the header much more compact - now it's a sleek banner style with just "Game Factory" and the icon. Added floating game ideas that drift across like a marquee (Obby, Tycoon, Simulator, etc.) giving it that ad/promo feel. Also capped message height at 200px with scrollbars for longer markdown responses!</p></div>
            </div>
            <div class="link-group">
                <a href="#" id="saveLink">Save</a>
                <a href="/pages" id="pagesLink">Pages</a>
                <a href="#" id="resetLink">Reset</a>
            </div>
            <form action="/" method="POST" id="chatForm">
                <div class="input-wrapper">
                    <input type="text" class="chat-input" id="chatInput" name="message" placeholder="Type a message...">
                    <button type="button" class="mic-button" id="micButton" title="Voice input"><svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3zm-1-9c0-.55.45-1 1-1s1 .45 1 1v6c0 .55-.45 1-1 1s-1-.45-1-1V5zm6 6c0 2.76-2.24 5-5 5s-5-2.24-5-5H5c0 3.53 2.61 6.43 6 6.92V21h2v-3.08c3.39-.49 6-3.39 6-6.92h-2z"/></svg></button>
                </div>
                <button type="submit" class="chat-submit" id="chatSubmit" title="Send"><svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M4 12l1.41 1.41L11 7.83V20h2V7.83l5.58 5.59L20 12l-8-8-8 8z"/></svg></button>
            </form>
        </div>
    </div>
    <button class="toggle-chat-btn" id="toggleChatBtn" title="Toggle chat panel"><svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"/></svg></button>
    <div class="viewer-panel" id="viewerPanel" tabindex="-1">
        <div class="game-factory" id="gameFactory">
            <div class="gf-header">
                <div class="gf-floating-ideas">
                    <div class="gf-idea">üèÉ Obby Adventure</div>
                    <div class="gf-idea">üí∞ Tycoon Empire</div>
                    <div class="gf-idea">üêæ Pet Simulator</div>
                    <div class="gf-idea">üè† Roleplay World</div>
                </div>
                <div class="gf-header-content">
                    <h1><span class="factory-icon">üè≠</span> Game Factory</h1>
                </div>
            </div>
            <div class="gf-chat-area" id="gfChatArea">
                <div class="gf-message bot">Hey there, future game creator! üåü Welcome to the Game Factory! I'm here to help you design the most AMAZING game ever! So tell me - what kind of game are you dreaming about today? Maybe a tricky obstacle course where you jump and dodge? A tycoon where you build an empire? A simulator where you collect cool stuff? Or something totally unique that nobody's ever made before? What sounds fun to you?</div>
            </div>
            <div class="gf-input-area">
                <div class="gf-recording-indicator" id="gfRecordingIndicator">
                    <div class="gf-waves"><div class="gf-wave"></div><div class="gf-wave"></div><div class="gf-wave"></div><div class="gf-wave"></div><div class="gf-wave"></div></div>
                    <span class="gf-rec-text">Listening...</span>
                </div>
                <input type="text" class="gf-input" id="gfInput" placeholder="Tell me about your game idea...">
                <button type="button" class="gf-mic-btn" id="gfMicBtn" title="Talk to me!"><svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3zm-1-9c0-.55.45-1 1-1s1 .45 1 1v6c0 .55-.45 1-1 1s-1-.45-1-1V5zm6 6c0 2.76-2.24 5-5 5s-5-2.24-5-5H5c0 3.53 2.61 6.43 6 6.92V21h2v-3.08c3.39-.49 6-3.39 6-6.92h-2z"/></svg></button>
                <button class="gf-send-btn" id="gfSendBtn" title="Send"><svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg></button>
                <button class="gf-build-btn" id="gfBuildBtn">
                    <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M19.35 10.04C18.67 6.59 15.64 4 12 4 9.11 4 6.6 5.64 5.35 8.04 2.34 8.36 0 10.91 0 14c0 3.31 2.69 6 6 6h13c2.76 0 5-2.24 5-5 0-2.64-2.05-4.78-4.65-4.96zM14 13v4h-4v-4H7l5-5 5 5h-3z"/></svg>
                    Build It!
                </button>
            </div>
        </div>
        <div class="recording-indicator" id="recordingIndicator">
            <div class="sound-waves"><div class="sound-wave"></div><div class="sound-wave"></div><div class="sound-wave"></div><div class="sound-wave"></div><div class="sound-wave"></div></div>
            <span class="recording-text">Listening</span>
        </div>
        <div id="loadingOverlay" class="loading-overlay">
            <div class="loading-container">
                <div class="spinner"></div>
                <div class="loading-text">Updating...</div>
            </div>
        </div>
    </div>
    <div id="thoughts" style="display: none;">User wants: 1) Max height on messages with scrollbar for markdown support 2) Smaller, more ad-like header with floating game ideas that drift across. Made the header compact (just title + icon), added floating idea text that animates across like a marquee showing different game genres. Messages now have max-height: 200px with overflow-y: auto for scrolling long content.</div>
    <script>
        const chatInput=document.getElementById("chatInput");const viewerPanel=document.getElementById("viewerPanel");const micButton=document.getElementById('micButton');const recordingIndicator=document.getElementById('recordingIndicator');const chatForm=document.getElementById("chatForm");const chatSubmit=document.getElementById('chatSubmit');
        let recognition=null;let isRecording=false;
        chatInput.addEventListener('mousedown',function(e){e.stopPropagation();});
        chatInput.addEventListener('click',function(e){e.stopPropagation();this.focus();});
        chatInput.addEventListener('focus',function(){if(document.activeElement&&viewerPanel.contains(document.activeElement)){document.activeElement.blur()}});
        viewerPanel.addEventListener('click',function(e){if(e.target===viewerPanel||e.target.closest('.idle-container')||e.target.closest('.loading-overlay')){if(document.activeElement&&viewerPanel.contains(document.activeElement)){document.activeElement.blur()}}});
        document.addEventListener('click',function(e){if(e.target===chatInput||chatInput.contains(e.target)){chatInput.focus()}});
        function setLoadingState(isLoading){const saveLink=document.getElementById('saveLink');const pagesLink=document.getElementById('pagesLink');const resetLink=document.getElementById('resetLink');const loadingOverlay=document.getElementById('loadingOverlay');if(isLoading){saveLink.classList.add('disabled');pagesLink.classList.add('disabled');resetLink.classList.add('disabled');chatSubmit.disabled=true;chatInput.disabled=true;micButton.disabled=true;loadingOverlay.classList.add('active')}else{saveLink.classList.remove('disabled');pagesLink.classList.remove('disabled');resetLink.classList.remove('disabled');chatSubmit.disabled=false;chatInput.disabled=false;micButton.disabled=false;loadingOverlay.classList.remove('active')}}
        function stopRecording(){if(recognition&&isRecording){recognition.stop();isRecording=false;micButton.classList.remove('recording');recordingIndicator.classList.remove('active');chatSubmit.disabled=false}}
        function startRecording(){if(recognition&&!isRecording){chatInput.dataset.baseValue=chatInput.value;try{recognition.start();isRecording=true;micButton.classList.add('recording');recordingIndicator.classList.add('active');chatSubmit.disabled=true}catch(e){isRecording=false;chatSubmit.disabled=false}}}
        function toggleRecording(){if(isRecording){stopRecording()}else{startRecording()}}
        chatForm.addEventListener('submit',function(e){if(isRecording){e.preventDefault();return}setTimeout(()=>setLoadingState(true),0);this.action=window.location.pathname});
        const saveModal=document.getElementById('saveModal');const savePageNameInput=document.getElementById('savePageName');const modalClose=document.getElementById('modalClose');const modalCancel=document.getElementById('modalCancel');const modalSave=document.getElementById('modalSave');
        function getCurrentPageName(){const path=window.location.pathname;let pageName=path.replace(/^\//,'');if(!pageName||pageName===''){pageName=''}return pageName}
        function isSpecialPage(pageName){if(!pageName||pageName===''){return true}if(pageName.toLowerCase()==='home'){return true}if(pageName.startsWith('[')&&pageName.endsWith(']')){return true}return false}
        function openSaveModal(){const pageName=getCurrentPageName();if(isSpecialPage(pageName)){savePageNameInput.value='';savePageNameInput.placeholder='Enter page name...'}else{savePageNameInput.value=pageName;savePageNameInput.placeholder='Enter page name...'}saveModal.classList.add('active');setTimeout(()=>savePageNameInput.focus(),100)}
        function closeSaveModal(){saveModal.classList.remove('active')}
        function performSave(){const pageName=savePageNameInput.value.trim();if(pageName){const url=`${window.location.pathname}/save?name=${encodeURIComponent(pageName)}`;window.location.href=url}}
        document.getElementById("saveLink").addEventListener("click",function(e){e.preventDefault();if(!this.classList.contains('disabled')){openSaveModal()}});
        modalClose.addEventListener('click',closeSaveModal);modalCancel.addEventListener('click',closeSaveModal);modalSave.addEventListener('click',performSave);
        saveModal.addEventListener('click',function(e){if(e.target===saveModal){closeSaveModal()}});
        savePageNameInput.addEventListener('keydown',function(e){if(e.key==='Enter'){e.preventDefault();performSave()}else if(e.key==='Escape'){closeSaveModal()}});
        document.getElementById("resetLink").addEventListener("click",function(e){e.preventDefault();if(!this.classList.contains('disabled')){setLoadingState(true);window.location.href=`${window.location.pathname}/reset`}});
        document.getElementById("pagesLink").addEventListener("click",function(e){if(this.classList.contains('disabled')){e.preventDefault()}});
        window.onload=function(){const chatMessages=document.getElementById('chatMessages');chatMessages.scrollTo({top:chatMessages.scrollHeight,behavior:'smooth'})};
        const toggleBtn=document.getElementById('toggleChatBtn');const chatPanel=document.getElementById('chatPanel');
        toggleBtn.addEventListener('click',function(){chatPanel.classList.toggle('collapsed');toggleBtn.classList.toggle('expanded')});
        if('webkitSpeechRecognition' in window||'SpeechRecognition' in window){const SpeechRecognition=window.SpeechRecognition||window.webkitSpeechRecognition;recognition=new SpeechRecognition();recognition.continuous=true;recognition.interimResults=true;recognition.lang='en-US';recognition.maxAlternatives=1;recognition.onend=function(){if(isRecording){try{recognition.start()}catch(e){isRecording=false;micButton.classList.remove('recording');recordingIndicator.classList.remove('active');chatSubmit.disabled=false}}};recognition.onresult=function(event){let finalTranscript='';let interimTranscript='';for(let i=event.resultIndex;i<event.results.length;i++){const transcript=event.results[i][0].transcript;if(event.results[i].isFinal){finalTranscript+=transcript}else{interimTranscript+=transcript}}if(finalTranscript){const currentValue=chatInput.value;if(currentValue&&!currentValue.endsWith(' ')){chatInput.value=currentValue+' '+finalTranscript}else{chatInput.value=currentValue+finalTranscript}chatInput.dataset.baseValue=chatInput.value}else if(interimTranscript){const baseValue=chatInput.dataset.baseValue||'';chatInput.value=baseValue+interimTranscript}};recognition.onerror=function(event){if(event.error==='no-speech'){return}if(event.error!=='no-speech'&&event.error!=='aborted'){isRecording=false;micButton.classList.remove('recording');recordingIndicator.classList.remove('active');chatSubmit.disabled=false}};micButton.addEventListener('click',function(){if(this.disabled)return;toggleRecording()})}else{micButton.style.opacity='0.5';micButton.style.cursor='not-allowed';micButton.title='Speech recognition not supported in this browser'}

        // Game Factory Logic with LLM Integration
        const gfInput=document.getElementById('gfInput');const gfSendBtn=document.getElementById('gfSendBtn');const gfMicBtn=document.getElementById('gfMicBtn');const gfChatArea=document.getElementById('gfChatArea');const gfBuildBtn=document.getElementById('gfBuildBtn');const gfRecordingIndicator=document.getElementById('gfRecordingIndicator');
        const buildModal=document.getElementById('buildModal');const buildModalClose=document.getElementById('buildModalClose');const buildModalCancel=document.getElementById('buildModalCancel');const buildModalGo=document.getElementById('buildModalGo');const buildPromptArea=document.getElementById('buildPromptArea');const buildLoading=document.getElementById('buildLoading');
        let gfRecognition=null;let gfIsRecording=false;
        let conversationHistory=[];
        let generatedBuildPrompt='';
        let hasUserSentMessage=false;
        
        const systemPrompt=`You are a friendly, enthusiastic game design assistant helping a child (around 10 years old) design their dream game. You understand Roblox-style game genres:

ROBLOX GAME GENRES:
- Obby (Obstacle Course): Jumping puzzles, parkour, avoiding obstacles to reach the end
- Tycoon: Build and manage a business/factory, earn money, upgrade and expand
- Simulator: Repetitive actions to level up stats (Pet Simulator, Mining Simulator, etc.)
- Roleplay: Pretend to be someone (Adopt Me, Brookhaven, work at a pizza place)
- Battle Royale: Last player standing combat games
- Tower Defense: Place towers to stop waves of enemies
- Horror: Scary games with monsters or survival elements
- Racing: Vehicle racing games
- Fighting: Combat-focused PvP games
- Adventure: Story-driven exploration games
- Building: Creative construction games

Ask engaging follow-up questions about their game idea. Be encouraging and excited! Ask about:
- What the player does in the game
- What makes it special or unique
- What the world/setting looks like
- What rewards or goals there are
- Any cool features they want

Keep responses short, fun, and age-appropriate. Use emojis! Ask ONE follow-up question at a time.`;

        function addBotMessage(text){const msg=document.createElement('div');msg.className='gf-message bot';msg.textContent=text;gfChatArea.appendChild(msg);gfChatArea.scrollTop=gfChatArea.scrollHeight;conversationHistory.push({role:'assistant',content:text})}
        function addUserMessage(text){const msg=document.createElement('div');msg.className='gf-message user';msg.textContent=text;gfChatArea.appendChild(msg);gfChatArea.scrollTop=gfChatArea.scrollHeight;conversationHistory.push({role:'user',content:text})}
        function showTyping(){const typing=document.createElement('div');typing.className='gf-typing';typing.id='gfTyping';typing.innerHTML='<span></span><span></span><span></span>';gfChatArea.appendChild(typing);gfChatArea.scrollTop=gfChatArea.scrollHeight}
        function hideTyping(){const typing=document.getElementById('gfTyping');if(typing)typing.remove()}
        
        async function processUserInput(input){
            addUserMessage(input);
            if(!hasUserSentMessage){
                hasUserSentMessage=true;
                gfBuildBtn.classList.add('active');
            }
            showTyping();
            gfInput.disabled=true;
            gfSendBtn.disabled=true;
            gfMicBtn.disabled=true;
            
            try{
                const conversationText=conversationHistory.map(m=>`${m.role==='user'?'Child':'Assistant'}: ${m.content}`).join('\n\n');
                const prompt=`${systemPrompt}\n\nConversation so far:\n${conversationText}\n\nRespond with a short, encouraging message and ask ONE follow-up question:`;
                
                const response=await fetch('/api/generate/completion',{
                    method:'POST',
                    headers:{'Content-Type':'application/json'},
                    body:JSON.stringify({prompt:prompt,temperature:0.7})
                });
                
                const data=await response.json();
                hideTyping();
                addBotMessage(data.answer);
            }catch(error){
                hideTyping();
                addBotMessage("Oops! Something went wrong. Can you tell me more about your game idea? üéÆ");
            }
            
            gfInput.disabled=false;
            gfSendBtn.disabled=false;
            gfMicBtn.disabled=false;
            gfInput.value='';
            gfInput.focus();
        }
        
        gfSendBtn.addEventListener('click',function(){
            if(gfIsRecording)return;
            const input=gfInput.value.trim();
            if(input){processUserInput(input)}
        });
        gfInput.addEventListener('keydown',function(e){
            if(e.key==='Enter'){
                e.preventDefault();
                if(!gfIsRecording){
                    gfSendBtn.click();
                }
            }
        });
        
        async function openBuildModal(){
            buildModal.classList.add('active');
            buildPromptArea.style.display='none';
            buildLoading.classList.add('active');
            buildModalGo.disabled=true;
            
            const conversationText=conversationHistory.map(m=>`${m.role==='user'?'Child':'Game Factory'}: ${m.content}`).join('\n\n');
            
            const buildPromptRequest=`You are a game design document generator. Based on this conversation between a child and the Game Factory assistant, create a detailed game design prompt that can be used to build a playable web-based game.

CONVERSATION:
${conversationText}

Generate a comprehensive game design document that includes:
1. GAME TITLE - A catchy name for the game
2. GENRE - The type of game (Obby, Tycoon, Simulator, etc.)
3. CORE GAMEPLAY - What the player does moment-to-moment
4. SETTING/THEME - The world, visuals, and atmosphere
5. PLAYER ABILITIES - What the player can do (jump, collect, build, etc.)
6. PROGRESSION - How the player advances (levels, upgrades, unlocks)
7. UNIQUE FEATURES - What makes this game special
8. WIN CONDITION - How to beat the game or main goals

Write this as a clear, detailed prompt that could be given to a developer to build a simple web-based version of this game. Be specific and creative!`;

            try{
                const response=await fetch('/api/generate/completion',{
                    method:'POST',
                    headers:{'Content-Type':'application/json'},
                    body:JSON.stringify({prompt:buildPromptRequest,temperature:0.7})
                });
                
                const data=await response.json();
                generatedBuildPrompt=data.answer;
                buildPromptArea.textContent=generatedBuildPrompt;
                buildLoading.classList.remove('active');
                buildPromptArea.style.display='block';
                buildModalGo.disabled=false;
            }catch(error){
                buildLoading.classList.remove('active');
                buildPromptArea.textContent='Error generating game design. Please try again!';
                buildPromptArea.style.display='block';
            }
        }
        
        function closeBuildModal(){
            buildModal.classList.remove('active');
        }
        
        gfBuildBtn.addEventListener('click',function(){
            if(hasUserSentMessage){
                openBuildModal();
            }
        });
        
        buildModalClose.addEventListener('click',closeBuildModal);
        buildModalCancel.addEventListener('click',closeBuildModal);
        buildModal.addEventListener('click',function(e){if(e.target===buildModal)closeBuildModal()});
        
        buildModalGo.addEventListener('click',function(){
            const gameRequest=`Build me a playable web game based on this design:\n\n${generatedBuildPrompt}`;
            chatInput.value=gameRequest;
            closeBuildModal();
            chatPanel.classList.remove('collapsed');
            toggleBtn.classList.add('expanded');
            setTimeout(()=>{chatForm.requestSubmit()},300);
        });
        
        // Game Factory Speech Recognition - mirrors SynthOS behavior
        if('webkitSpeechRecognition' in window||'SpeechRecognition' in window){
            const SpeechRecognition=window.SpeechRecognition||window.webkitSpeechRecognition;
            gfRecognition=new SpeechRecognition();
            gfRecognition.continuous=true;
            gfRecognition.interimResults=true;
            gfRecognition.lang='en-US';
            gfRecognition.maxAlternatives=1;
            
            gfRecognition.onend=function(){
                if(gfIsRecording){
                    try{
                        gfRecognition.start();
                    }catch(e){
                        gfIsRecording=false;
                        gfMicBtn.classList.remove('recording');
                        gfRecordingIndicator.classList.remove('active');
                        gfSendBtn.disabled=false;
                    }
                }
            };
            
            gfRecognition.onresult=function(event){
                let finalTranscript='';
                let interimTranscript='';
                for(let i=event.resultIndex;i<event.results.length;i++){
                    const transcript=event.results[i][0].transcript;
                    if(event.results[i].isFinal){
                        finalTranscript+=transcript;
                    }else{
                        interimTranscript+=transcript;
                    }
                }
                if(finalTranscript){
                    const currentValue=gfInput.value;
                    const baseValue=gfInput.dataset.baseValue||'';
                    if(baseValue&&!baseValue.endsWith(' ')){
                        gfInput.value=baseValue+' '+finalTranscript;
                    }else{
                        gfInput.value=baseValue+finalTranscript;
                    }
                    gfInput.dataset.baseValue=gfInput.value;
                }else if(interimTranscript){
                    const baseValue=gfInput.dataset.baseValue||'';
                    gfInput.value=baseValue+interimTranscript;
                }
            };
            
            gfRecognition.onerror=function(event){
                if(event.error==='no-speech'){
                    return;
                }
                if(event.error!=='no-speech'&&event.error!=='aborted'){
                    gfIsRecording=false;
                    gfMicBtn.classList.remove('recording');
                    gfRecordingIndicator.classList.remove('active');
                    gfSendBtn.disabled=false;
                }
            };
            
            function gfStopRecording(){
                if(gfRecognition&&gfIsRecording){
                    gfRecognition.stop();
                    gfIsRecording=false;
                    gfMicBtn.classList.remove('recording');
                    gfRecordingIndicator.classList.remove('active');
                    gfSendBtn.disabled=false;
                }
            }
            
            function gfStartRecording(){
                if(gfRecognition&&!gfIsRecording){
                    gfInput.dataset.baseValue=gfInput.value;
                    try{
                        gfRecognition.start();
                        gfIsRecording=true;
                        gfMicBtn.classList.add('recording');
                        gfRecordingIndicator.classList.add('active');
                        gfSendBtn.disabled=true;
                    }catch(e){
                        gfIsRecording=false;
                        gfSendBtn.disabled=false;
                    }
                }
            }
            
            function gfToggleRecording(){
                if(gfIsRecording){
                    gfStopRecording();
                }else{
                    gfStartRecording();
                }
            }
            
            gfMicBtn.addEventListener('click',function(){
                if(this.disabled)return;
                gfToggleRecording();
            });
        }else{
            gfMicBtn.style.opacity='0.5';
            gfMicBtn.style.cursor='not-allowed';
            gfMicBtn.title='Speech recognition not supported';
        }
    </script>
</body>
</html>