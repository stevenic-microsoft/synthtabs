<!DOCTYPE html><html lang="en"><head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SynthOS</title>
    <script id="theme-info" src="/api/theme-info.js" data-locked="true"></script>
    <link id="theme-css" rel="stylesheet" href="/api/theme.css" data-locked="true">
    <style>.idle-container{position:absolute;width:100%;height:100%;pointer-events:none;opacity:1;transition:opacity 1s ease-out}.idle-container.hidden{opacity:0}.breathing-orb{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);width:80px;height:80px;border-radius:50%;background:radial-gradient(circle,rgba(102,126,234,.15) 0,transparent 70%);animation:4s ease-in-out infinite breathe}.breathing-orb::before{content:'';position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);width:8px;height:8px;border-radius:50%;background:rgba(183,148,246,.6);box-shadow:0 0 20px rgba(183,148,246,.4);animation:4s ease-in-out infinite core-pulse}@keyframes breathe{0%,100%{width:80px;height:80px;opacity:.3}50%{width:120px;height:120px;opacity:.6}}@keyframes core-pulse{0%,100%{opacity:.4;box-shadow:0 0 20px rgba(183,148,246,.3)}50%{opacity:.8;box-shadow:0 0 30px rgba(183,148,246,.5)}}.orbit-ring{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);width:200px;height:200px;border:1px solid rgba(102,126,234,.1);border-radius:50%;animation:20s linear infinite orbit-rotate}.orbit-ring::after{content:'';position:absolute;top:-3px;left:50%;transform:translateX(-50%);width:6px;height:6px;background:rgba(240,147,251,.5);border-radius:50%;box-shadow:0 0 10px rgba(240,147,251,.3)}@keyframes orbit-rotate{from{transform:translate(-50%,-50%) rotate(0)}to{transform:translate(-50%,-50%) rotate(360deg)}}</style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.9.0/d3.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/14.1.1/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mermaid/11.1.0/mermaid.min.js"></script>
    <script id="page-info" src="/api/page-info.js?page=builder"></script>
<style id="pexels-styles">
#pexels-app {
  display: flex;
  flex-direction: column;
  height: 100%;
  font-family: inherit;
  color: var(--text-primary);
  background: var(--bg-primary);
}

.pexels-header {
  min-height: var(--header-min-height);
  padding: var(--header-padding-vertical) var(--header-padding-horizontal);
  line-height: var(--header-line-height);
  display: flex;
  align-items: center;
  justify-content: center;
  box-sizing: border-box;
  background: var(--bg-secondary);
  border-bottom: 1px solid var(--border-color);
  font-size: 1.1rem;
  font-weight: 700;
  color: var(--text-primary);
  gap: 8px;
}

.pexels-header svg {
  width: 22px;
  height: 22px;
  fill: var(--accent-primary);
}

.pexels-search-bar {
  padding: 16px 20px;
  background: var(--bg-tertiary);
  border-bottom: 1px solid var(--border-color);
  display: flex;
  flex-direction: column;
  gap: 10px;
}

.pexels-search-row {
  display: flex;
  gap: 8px;
}

.pexels-search-input {
  flex: 1;
  padding: 10px 14px;
  border: 1px solid var(--border-color);
  border-radius: 8px;
  background: var(--bg-primary);
  color: var(--text-primary);
  font-size: 0.95rem;
  outline: none;
  transition: border-color 0.2s;
}

.pexels-search-input:focus {
  border-color: var(--accent-primary);
  box-shadow: 0 0 0 3px var(--accent-glow);
}

.pexels-search-input::placeholder {
  color: var(--text-secondary);
  opacity: 0.7;
}

.pexels-search-btn {
  padding: 10px 20px;
  background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
  color: #fff;
  border: none;
  border-radius: 8px;
  font-size: 0.95rem;
  font-weight: 600;
  cursor: pointer;
  transition: opacity 0.2s, transform 0.1s;
  white-space: nowrap;
}

.pexels-search-btn:hover {
  opacity: 0.9;
  transform: translateY(-1px);
}

.pexels-search-btn:active {
  transform: translateY(0);
}

.pexels-search-btn:disabled {
  opacity: 0.5;
  cursor: not-allowed;
  transform: none;
}

.pexels-filters {
  display: flex;
  gap: 10px;
  flex-wrap: wrap;
  align-items: center;
}

.pexels-filter-label {
  font-size: 0.8rem;
  color: var(--text-secondary);
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.pexels-filter-select {
  padding: 6px 10px;
  border: 1px solid var(--border-color);
  border-radius: 6px;
  background: var(--bg-primary);
  color: var(--text-primary);
  font-size: 0.85rem;
  outline: none;
  cursor: pointer;
}

.pexels-filter-select:focus {
  border-color: var(--accent-primary);
}

.pexels-color-btn {
  width: 22px;
  height: 22px;
  border-radius: 50%;
  border: 2px solid transparent;
  cursor: pointer;
  transition: transform 0.15s, border-color 0.15s;
  box-shadow: 0 1px 3px rgba(0,0,0,0.15);
}

.pexels-color-btn:hover {
  transform: scale(1.15);
}

.pexels-color-btn.active {
  border-color: var(--accent-primary);
  transform: scale(1.15);
  box-shadow: 0 0 0 2px var(--accent-glow);
}

.pexels-body {
  flex: 1;
  overflow-y: auto;
  padding: 16px;
}

.pexels-status {
  text-align: center;
  padding: 40px 20px;
  color: var(--text-secondary);
  font-size: 0.95rem;
}

.pexels-status-icon {
  font-size: 2.5rem;
  margin-bottom: 12px;
}

.pexels-results-info {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 12px;
  font-size: 0.85rem;
  color: var(--text-secondary);
}

.pexels-results-info a {
  color: var(--accent-primary);
  text-decoration: none;
  font-weight: 600;
}

.pexels-results-info a:hover {
  text-decoration: underline;
}

.pexels-grid {
  columns: 3;
  column-gap: 12px;
}

@media (max-width: 900px) {
  .pexels-grid { columns: 2; }
}

@media (max-width: 500px) {
  .pexels-grid { columns: 1; }
}

.pexels-card {
  break-inside: avoid;
  margin-bottom: 12px;
  border-radius: 10px;
  overflow: hidden;
  background: var(--bg-secondary);
  border: 1px solid var(--border-color);
  cursor: pointer;
  transition: transform 0.2s, box-shadow 0.2s;
  position: relative;
}

.pexels-card:hover {
  transform: translateY(-3px);
  box-shadow: 0 8px 24px var(--accent-glow);
}

.pexels-card img {
  width: 100%;
  display: block;
  transition: opacity 0.3s;
}

.pexels-card-overlay {
  position: absolute;
  bottom: 0;
  left: 0;
  right: 0;
  padding: 10px 12px;
  background: linear-gradient(transparent, rgba(0,0,0,0.65));
  color: #fff;
  font-size: 0.8rem;
  opacity: 0;
  transition: opacity 0.2s;
}

.pexels-card:hover .pexels-card-overlay {
  opacity: 1;
}

.pexels-card-photographer {
  font-weight: 600;
  font-size: 0.82rem;
}

.pexels-card-dims {
  font-size: 0.72rem;
  opacity: 0.8;
  margin-top: 2px;
}

.pexels-load-more {
  display: block;
  margin: 20px auto;
  padding: 10px 28px;
  background: var(--bg-secondary);
  border: 1px solid var(--border-color);
  border-radius: 8px;
  color: var(--accent-primary);
  font-weight: 600;
  font-size: 0.9rem;
  cursor: pointer;
  transition: background 0.2s;
}

.pexels-load-more:hover {
  background: var(--accent-glow);
}

.pexels-load-more:disabled {
  opacity: 0.5;
  cursor: not-allowed;
}

/* Modal */
.pexels-modal-backdrop {
  position: fixed;
  top: 0; left: 0; right: 0; bottom: 0;
  background: rgba(0,0,0,0.7);
  z-index: 10000;
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 20px;
  animation: pexelsFadeIn 0.2s ease;
}

@keyframes pexelsFadeIn {
  from { opacity: 0; }
  to { opacity: 1; }
}

.pexels-modal {
  background: var(--bg-primary);
  border-radius: 14px;
  max-width: 900px;
  max-height: 90vh;
  width: 100%;
  overflow: hidden;
  display: flex;
  flex-direction: column;
  box-shadow: 0 20px 60px rgba(0,0,0,0.3);
  animation: pexelsSlideUp 0.25s ease;
}

@keyframes pexelsSlideUp {
  from { transform: translateY(20px); opacity: 0; }
  to { transform: translateY(0); opacity: 1; }
}

.pexels-modal-img-wrap {
  flex: 1;
  overflow: auto;
  display: flex;
  align-items: center;
  justify-content: center;
  background: #111;
  min-height: 200px;
}

.pexels-modal-img-wrap img {
  max-width: 100%;
  max-height: 65vh;
  object-fit: contain;
}

.pexels-modal-info {
  padding: 16px 20px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 12px;
  flex-wrap: wrap;
  border-top: 1px solid var(--border-color);
}

.pexels-modal-photographer {
  font-weight: 700;
  font-size: 1rem;
  color: var(--text-primary);
}

.pexels-modal-dims {
  font-size: 0.82rem;
  color: var(--text-secondary);
}

.pexels-modal-actions {
  display: flex;
  gap: 8px;
  align-items: center;
}

.pexels-modal-btn {
  padding: 8px 16px;
  border-radius: 7px;
  font-size: 0.85rem;
  font-weight: 600;
  cursor: pointer;
  text-decoration: none;
  transition: opacity 0.2s;
  border: none;
}

.pexels-modal-btn:hover {
  opacity: 0.85;
}

.pexels-modal-btn-primary {
  background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
  color: #fff;
}

.pexels-modal-btn-secondary {
  background: var(--bg-secondary);
  color: var(--text-primary);
  border: 1px solid var(--border-color);
}

.pexels-modal-close {
  position: absolute;
  top: 12px;
  right: 12px;
  width: 36px;
  height: 36px;
  border-radius: 50%;
  background: rgba(0,0,0,0.5);
  color: #fff;
  border: none;
  font-size: 1.2rem;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: background 0.2s;
  z-index: 1;
}

.pexels-modal-close:hover {
  background: rgba(0,0,0,0.7);
}

.pexels-trending-tags {
  display: flex;
  gap: 6px;
  flex-wrap: wrap;
  margin-top: 4px;
}

.pexels-tag {
  padding: 4px 12px;
  background: var(--bg-secondary);
  border: 1px solid var(--border-color);
  border-radius: 20px;
  font-size: 0.8rem;
  color: var(--text-secondary);
  cursor: pointer;
  transition: background 0.2s, color 0.2s;
}

.pexels-tag:hover {
  background: var(--accent-glow);
  color: var(--accent-primary);
}

.pexels-error {
  background: rgba(220, 53, 69, 0.1);
  border: 1px solid rgba(220, 53, 69, 0.3);
  border-radius: 8px;
  padding: 16px;
  text-align: center;
  color: #dc3545;
  margin: 20px;
}

.light-mode .pexels-modal-backdrop {
  background: rgba(0,0,0,0.55);
}
</style></head>
<body>
    <div class="chat-panel" data-locked="true">
        <div class="chat-header" data-locked="true">SynthOS</div>
        <div class="chat-messages" id="chatMessages" data-locked="true">
            <div class="chat-message" id="defaultGreeting"><strong>SynthOS:</strong> What can I create for you? Ask "what can you do?" or "how does this work?" to learn more. Remember to save often!</div>
            <div class="chat-message" id="firstRunGreeting" style="display:none;">
                <p><strong>Welcome to SynthOS!</strong></p>
                <p>You're all set up and ready to start creating. This is the <strong>Builder</strong> ‚Äî your main workspace. Just type what you want to build into the chat and SynthOS will generate it for you as a live, interactive page.</p>
                <p>You can create just about anything: dashboards, tools, games, visualizations, forms, calculators ‚Äî if it can be expressed as a web page, you can build it here through conversation.</p>
                <p><strong>How pages work:</strong></p>
                <ul>
                    <li>Each creation lives on its own <strong>page</strong>. When you save, it gets a name and becomes part of your collection.</li>
                    <li>The <strong>Pages</strong> button (in the link bar above) takes you to the <strong>Pages Gallery</strong> where you can browse, open, and manage all your saved creations.</li>
                </ul>
                <p><strong>Key actions:</strong></p>
                <ul>
                    <li><strong>Save</strong> ‚Äî saves your current page. You'll be prompted for a name the first time. <em>Save often!</em> Your work only persists when you save it.</li>
                    <li><strong>Reset</strong> ‚Äî clears the current page back to a blank slate. Useful when you want to start fresh on something new.</li>
                </ul>
                <p>When you're ready, we recommend trying the <a href="/solar_tutorial">Solar Tutorial</a> ‚Äî it's a guided walkthrough that will show you the basics of creating with SynthOS step by step.</p>
                <p>Have fun building!</p>
            </div>
        <div class="chat-message"><p><strong>User:</strong> Create a stock photography search app using Pexels</p></div><div class="chat-message"><p><strong>SynthOS:</strong> I've built a stock photography search app powered by Pexels! You can search for any topic, browse results in a beautiful masonry grid, filter by orientation and color, and click any photo to see it full-size with download options and photographer credits. Photos provided by <a href="https://www.pexels.com" target="_blank">Pexels</a>.</p></div></div>
        <div class="link-group" data-locked="true">
            <a href="#" id="saveLink" data-locked="true">Save</a>
            <a href="/pages" id="pagesLink" data-locked="true">Pages</a>
            <a href="#" id="resetLink" data-locked="true">Reset</a>
        </div>
        <form action="/" method="POST" id="chatForm" data-locked="true">
            <input type="text" class="chat-input" id="chatInput" name="message" placeholder="Type a message..." data-locked="true">
            <button type="submit" class="chat-submit" data-locked="true">Send</button>
        </form>
    </div>
    <div class="viewer-panel" id="viewerPanel"><div id="pexels-app"></div><div id="loadingOverlay" class="loading-overlay"><div class="spinner"></div></div></div>
    <div id="instructions" style="display: none;" data-locked="true">This is a Pexels stock photography search app. The app uses the Pexels connector to search and display photos. Features include search, orientation filter, color filter, masonry grid layout, photo detail modal, and load more pagination.</div>
    <div id="thoughts" style="display: none;" data-locked="true">Building a stock photography search app using the Pexels connector. Need to check connector availability, build a search UI with grid layout, handle pagination, and show photo details. Will use synthos.connectors.call for Pexels API.</div>
    <script id="idle-animation">function hideIdleAnimation(){const idleContainer=document.getElementById("idleAnimation");idleContainer&&(idleContainer.classList.add("hidden"),setTimeout(()=>{idleContainer.style.display="none"},1e3))}function showIdleAnimation(){const idleContainer=document.getElementById("idleAnimation");idleContainer&&(idleContainer.style.display="block",setTimeout(()=>{idleContainer.classList.remove("hidden")},10))}</script>
    <button class="chat-toggle" aria-label="Toggle chat panel">
        <span class="chat-toggle-dots">
            <span class="chat-toggle-dot"></span>
            <span class="chat-toggle-dot"></span>
            <span class="chat-toggle-dot"></span>
        </span>
    </button>
<script id="first-run-check">
(function() {
    var params = new URLSearchParams(window.location.search);
    if (params.get('firstRun') === 'true') {
        document.getElementById('defaultGreeting').style.display = 'none';
        document.getElementById('firstRunGreeting').style.display = '';
    }
})();
</script>


<script id="pexels-app-script">
(function() {
  const app = document.getElementById('pexels-app');
  if (!app) return;

  const COLORS = [
    { name: 'Any', value: '' },
    { name: 'Red', value: 'red', hex: '#e53e3e' },
    { name: 'Orange', value: 'orange', hex: '#ed8936' },
    { name: 'Yellow', value: 'yellow', hex: '#ecc94b' },
    { name: 'Green', value: 'green', hex: '#48bb78' },
    { name: 'Turquoise', value: 'turquoise', hex: '#38b2ac' },
    { name: 'Blue', value: 'blue', hex: '#4299e1' },
    { name: 'Violet', value: 'violet', hex: '#9f7aea' },
    { name: 'Pink', value: 'pink', hex: '#ed64a6' },
    { name: 'Brown', value: 'brown', hex: '#a0522d' },
    { name: 'Black', value: 'black', hex: '#1a202c' },
    { name: 'Gray', value: 'gray', hex: '#a0aec0' },
    { name: 'White', value: 'white', hex: '#f7fafc' }
  ];

  const TRENDING = ['Nature', 'Architecture', 'People', 'Technology', 'Food', 'Travel', 'Animals', 'Abstract', 'Business', 'Minimal'];

  let state = {
    query: '',
    orientation: '',
    color: '',
    photos: [],
    page: 1,
    totalResults: 0,
    loading: false,
    searched: false,
    connectorOk: null,
    error: null
  };

  function render() {
    let colorBtns = COLORS.map(c => {
      if (!c.value) return '';
      const active = state.color === c.value ? 'active' : '';
      return `<button class="pexels-color-btn ${active}" data-color="${c.value}" title="${c.name}" style="background:${c.hex};${c.value === 'white' ? 'border:1px solid #ccc;' : ''}"></button>`;
    }).join('');

    let trendingHtml = TRENDING.map(t => `<button class="pexels-tag" data-tag="${t}">${t}</button>`).join('');

    let bodyHtml = '';

    if (state.connectorOk === false) {
      bodyHtml = `<div class="pexels-error"><p><strong>Pexels connector not configured</strong></p><p>Please set up the Pexels connector in <a href="/settings?tab=connectors" style="color:var(--accent-primary);font-weight:600;">Settings &gt; Connectors</a> to use this app.</p></div>`;
    } else if (state.error) {
      bodyHtml = `<div class="pexels-error"><p><strong>Error</strong></p><p>${state.error}</p></div>`;
    } else if (state.loading && state.photos.length === 0) {
      bodyHtml = `<div class="pexels-status"><div class="pexels-status-icon">üîç</div><p>Searching Pexels...</p></div>`;
    } else if (!state.searched) {
      bodyHtml = `<div class="pexels-status"><div class="pexels-status-icon">üì∑</div><p>Search millions of free stock photos from Pexels</p><div class="pexels-trending-tags" style="justify-content:center;margin-top:16px;">${trendingHtml}</div></div>`;
    } else if (state.photos.length === 0) {
      bodyHtml = `<div class="pexels-status"><div class="pexels-status-icon">üòï</div><p>No photos found for "${escapeHtml(state.query)}"</p><p style="font-size:0.85rem;margin-top:8px;">Try different keywords or remove filters</p></div>`;
    } else {
      const cards = state.photos.map(p => `
        <div class="pexels-card" data-photo-id="${p.id}">
          <img src="${p.src.medium}" alt="${escapeHtml(p.alt || 'Photo by ' + p.photographer)}" loading="lazy">
          <div class="pexels-card-overlay">
            <div class="pexels-card-photographer">üì∏ ${escapeHtml(p.photographer)}</div>
            <div class="pexels-card-dims">${p.width} √ó ${p.height}</div>
          </div>
        </div>
      `).join('');

      const hasMore = state.photos.length < state.totalResults;
      const loadMoreBtn = hasMore ? `<button class="pexels-load-more" id="pexelsLoadMore" ${state.loading ? 'disabled' : ''}>${state.loading ? 'Loading...' : 'Load More Photos'}</button>` : '';

      bodyHtml = `
        <div class="pexels-results-info">
          <span>${state.totalResults.toLocaleString()} photos found for "${escapeHtml(state.query)}"</span>
          <a href="https://www.pexels.com/search/${encodeURIComponent(state.query)}/" target="_blank">View on Pexels ‚Üó</a>
        </div>
        <div class="pexels-grid">${cards}</div>
        ${loadMoreBtn}
      `;
    }

    app.innerHTML = `
      <div class="pexels-header">
        <svg viewBox="0 0 32 32"><path d="M2 2h28v28H2z" fill="none"/><path d="M10 8h6a6 6 0 010 12h-2v4h-4V8zm4 8h2a2 2 0 000-4h-2v4z"/></svg>
        Pexels Photo Search
      </div>
      <div class="pexels-search-bar">
        <div class="pexels-search-row">
          <input type="text" class="pexels-search-input" id="pexelsInput" placeholder="Search free stock photos..." value="${escapeHtml(state.query)}">
          <button class="pexels-search-btn" id="pexelsSearchBtn" ${state.loading ? 'disabled' : ''}>Search</button>
        </div>
        <div class="pexels-filters">
          <span class="pexels-filter-label">Orientation:</span>
          <select class="pexels-filter-select" id="pexelsOrientation">
            <option value="" ${state.orientation === '' ? 'selected' : ''}>Any</option>
            <option value="landscape" ${state.orientation === 'landscape' ? 'selected' : ''}>Landscape</option>
            <option value="portrait" ${state.orientation === 'portrait' ? 'selected' : ''}>Portrait</option>
            <option value="square" ${state.orientation === 'square' ? 'selected' : ''}>Square</option>
          </select>
          <span class="pexels-filter-label" style="margin-left:8px;">Color:</span>
          ${colorBtns}
          ${state.color ? '<button class="pexels-tag" id="pexelsClearColor" style="font-size:0.75rem;">‚úï Clear</button>' : ''}
        </div>
      </div>
      <div class="pexels-body" id="pexelsBody">${bodyHtml}</div>
    `;

    bindEvents();
  }

  function escapeHtml(str) {
    const d = document.createElement('div');
    d.textContent = str || '';
    return d.innerHTML;
  }

  function bindEvents() {
    const input = document.getElementById('pexelsInput');
    const btn = document.getElementById('pexelsSearchBtn');
    const orient = document.getElementById('pexelsOrientation');
    const loadMore = document.getElementById('pexelsLoadMore');
    const clearColor = document.getElementById('pexelsClearColor');

    if (input) {
      input.addEventListener('keydown', function(e) {
        e.stopPropagation();
        if (e.key === 'Enter') {
          e.preventDefault();
          doSearch();
        }
      });
      input.addEventListener('keyup', function(e) { e.stopPropagation(); });
      input.addEventListener('keypress', function(e) { e.stopPropagation(); });
      // Focus the input
      setTimeout(() => input.focus(), 50);
    }

    if (btn) btn.addEventListener('click', doSearch);

    if (orient) orient.addEventListener('change', function() {
      state.orientation = this.value;
      if (state.searched) doSearch();
    });

    if (loadMore) loadMore.addEventListener('click', loadNextPage);
    if (clearColor) clearColor.addEventListener('click', function() {
      state.color = '';
      if (state.searched) doSearch(); else render();
    });

    document.querySelectorAll('.pexels-color-btn').forEach(b => {
      b.addEventListener('click', function() {
        state.color = state.color === this.dataset.color ? '' : this.dataset.color;
        if (state.searched) doSearch(); else render();
      });
    });

    document.querySelectorAll('.pexels-tag[data-tag]').forEach(t => {
      t.addEventListener('click', function() {
        state.query = this.dataset.tag;
        doSearch();
      });
    });

    document.querySelectorAll('.pexels-card').forEach(card => {
      card.addEventListener('click', function() {
        const id = parseInt(this.dataset.photoId);
        const photo = state.photos.find(p => p.id === id);
        if (photo) showModal(photo);
      });
    });
  }

  async function checkConnector() {
    try {
      const list = await synthos.connectors.list({ id: 'pexels' });
      const pexels = list.find(c => c.id === 'pexels');
      state.connectorOk = pexels && pexels.configured;
    } catch(e) {
      state.connectorOk = false;
    }
  }

  async function doSearch() {
    const input = document.getElementById('pexelsInput');
    if (input) state.query = input.value.trim();
    if (!state.query) return;

    state.page = 1;
    state.photos = [];
    state.searched = true;
    state.loading = true;
    state.error = null;
    render();

    await fetchPhotos();
  }

  async function loadNextPage() {
    state.page++;
    state.loading = true;
    render();
    await fetchPhotos();
  }

  async function fetchPhotos() {
    try {
      let queryParams = `query=${encodeURIComponent(state.query)}&per_page=24&page=${state.page}`;
      if (state.orientation) queryParams += `&orientation=${state.orientation}`;
      if (state.color) queryParams += `&color=${state.color}`;

      const res = await synthos.connectors.call('pexels', 'GET', `/v1/search?${queryParams}`);

      if (res.photos) {
        if (state.page === 1) {
          state.photos = res.photos;
        } else {
          state.photos = state.photos.concat(res.photos);
        }
        state.totalResults = res.total_results || 0;
      } else {
        state.error = 'Unexpected response from Pexels API.';
      }
    } catch(e) {
      state.error = 'Failed to fetch photos: ' + (e.message || 'Unknown error');
    }

    state.loading = false;
    render();
  }

  function showModal(photo) {
    const existing = document.querySelector('.pexels-modal-backdrop');
    if (existing) existing.remove();

    const backdrop = document.createElement('div');
    backdrop.className = 'pexels-modal-backdrop';
    backdrop.innerHTML = `
      <div class="pexels-modal">
        <button class="pexels-modal-close" id="pexelsModalClose">‚úï</button>
        <div class="pexels-modal-img-wrap">
          <img src="${photo.src.large2x || photo.src.large}" alt="${escapeHtml(photo.alt || 'Photo by ' + photo.photographer)}">
        </div>
        <div class="pexels-modal-info">
          <div>
            <div class="pexels-modal-photographer">üì∏ ${escapeHtml(photo.photographer)}</div>
            <div class="pexels-modal-dims">${photo.width} √ó ${photo.height}px</div>
          </div>
          <div class="pexels-modal-actions">
            <a href="${photo.url}" target="_blank" class="pexels-modal-btn pexels-modal-btn-secondary">View on Pexels</a>
            <a href="${photo.src.original}" target="_blank" download class="pexels-modal-btn pexels-modal-btn-primary">Download Original</a>
          </div>
        </div>
      </div>
    `;

    document.body.appendChild(backdrop);

    backdrop.addEventListener('click', function(e) {
      if (e.target === backdrop) backdrop.remove();
    });

    document.getElementById('pexelsModalClose').addEventListener('click', function() {
      backdrop.remove();
    });

    document.addEventListener('keydown', function handler(e) {
      if (e.key === 'Escape') {
        backdrop.remove();
        document.removeEventListener('keydown', handler);
      }
    });
  }

  // Init
  async function init() {
    await checkConnector();
    render();
  }

  init();
})();
</script><script id="page-helpers" src="/api/page-helpers.js?v=2" data-locked="true"></script><script id="page-script" src="/api/page-script.js?v=2" data-locked="true"></script></body></html>