<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SynthOS</title>
    <style>
        *{margin:0;padding:0;box-sizing:border-box}body{font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;background:linear-gradient(135deg,#1a1a2e 0%,#16213e 50%,#0f0f23 100%);color:#e0e0e0;height:100vh;display:flex;overflow:hidden}.chat-panel{width:30%;min-width:300px;background:linear-gradient(180deg,rgba(26,26,46,0.95) 0%,rgba(22,33,62,0.95) 100%);box-shadow:0 0 30px rgba(138,43,226,0.2),inset 0 0 60px rgba(75,0,130,0.1);padding:20px;display:flex;flex-direction:column;border-right:1px solid rgba(138,43,226,0.3);position:relative;z-index:10;transform:translateX(0);transition:transform 0.4s cubic-bezier(0.4,0,0.2,1),margin-right 0.4s cubic-bezier(0.4,0,0.2,1);flex-shrink:0}.chat-panel.collapsed{transform:translateX(-100%);margin-right:calc(-30% + 45px)}.chat-panel .chat-content{display:flex;flex-direction:column;height:100%;opacity:1;transition:opacity 0.2s ease}.chat-panel.collapsed .chat-content{opacity:0}.chat-header{font-size:24px;padding:15px;background:linear-gradient(135deg,#667eea 0%,#764ba2 50%,#f093fb 100%);color:#fff;text-align:center;border-radius:15px;box-shadow:0 4px 20px rgba(102,126,234,0.4);text-shadow:0 2px 10px rgba(0,0,0,0.3);letter-spacing:2px;flex-shrink:0}.chat-messages{flex-grow:1;overflow-y:auto;padding:15px;margin-top:15px;background:rgba(15,15,35,0.6);border-radius:15px;border:1px solid rgba(138,43,226,0.2);box-shadow:inset 0 0 30px rgba(75,0,130,0.2)}.chat-message{margin-bottom:15px;padding:12px 15px;background:linear-gradient(135deg,rgba(102,126,234,0.15) 0%,rgba(118,75,162,0.15) 100%);border-radius:15px;box-shadow:0 2px 10px rgba(138,43,226,0.2);border:1px solid rgba(138,43,226,0.1);backdrop-filter:blur(5px)}.chat-message p{margin-bottom:5px;line-height:1.5}.chat-message p strong{font-weight:600;background:linear-gradient(90deg,#667eea,#f093fb);-webkit-background-clip:text;background-clip:text;-webkit-text-fill-color:transparent}.chat-message p code{background:rgba(138,43,226,0.3);padding:2px 6px;border-radius:5px;font-family:'Courier New',Courier,monospace;color:#f093fb;border:1px solid rgba(240,147,251,0.3)}.chat-message ul,.chat-message ol{margin:8px 0 8px 20px}.chat-message li{margin-bottom:4px}.chat-message a{color:#b794f6;text-decoration:none;border-bottom:1px solid rgba(183,148,246,0.3)}.chat-message a:hover{color:#f093fb;border-bottom-color:#f093fb}.chat-message em{color:#b794f6;font-style:italic}.link-group{display:flex;justify-content:space-between;margin:15px 0;padding:10px;background:rgba(15,15,35,0.4);border-radius:10px;border:1px solid rgba(138,43,226,0.2);flex-shrink:0}.link-group a{font-size:14px;color:#b794f6;text-decoration:none;padding:8px 12px;border-radius:8px;transition:all 0.3s ease;border:1px solid transparent}.link-group a:hover{background:linear-gradient(135deg,rgba(102,126,234,0.3) 0%,rgba(118,75,162,0.3) 100%);border-color:rgba(183,148,246,0.5);box-shadow:0 0 15px rgba(138,43,226,0.3);color:#f093fb}.link-group a.disabled{opacity:0.4;pointer-events:none;cursor:not-allowed}form{display:flex;flex-direction:row;width:100%;gap:10px;align-items:center;flex-shrink:0}.input-wrapper{position:relative;flex-grow:1;display:flex;align-items:center}.chat-input{padding:14px 50px 14px 18px;border:1px solid rgba(138,43,226,0.3);border-radius:25px;width:100%;font-size:14px;background:rgba(15,15,35,0.8);color:#e0e0e0;box-shadow:inset 0 2px 10px rgba(0,0,0,0.3),0 0 20px rgba(138,43,226,0.1);transition:all 0.3s ease}.chat-input:focus{outline:none;border-color:rgba(183,148,246,0.6);box-shadow:inset 0 2px 10px rgba(0,0,0,0.3),0 0 25px rgba(138,43,226,0.3)}.chat-input::placeholder{color:rgba(183,148,246,0.5)}.chat-input:disabled{opacity:0.5;cursor:not-allowed}.mic-button{position:absolute;right:8px;top:50%;transform:translateY(-50%);width:34px;height:34px;border:none;border-radius:50%;background:linear-gradient(135deg,rgba(102,126,234,0.4) 0%,rgba(118,75,162,0.4) 100%);color:#b794f6;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all 0.3s ease;padding:0;border:1px solid rgba(138,43,226,0.3)}.mic-button:hover{background:linear-gradient(135deg,rgba(102,126,234,0.6) 0%,rgba(118,75,162,0.6) 100%);color:#f093fb;box-shadow:0 0 15px rgba(138,43,226,0.4);border-color:rgba(183,148,246,0.5)}.mic-button.recording{background:linear-gradient(135deg,#667eea 0%,#764ba2 50%,#f093fb 100%);color:#fff;box-shadow:0 0 20px rgba(138,43,226,0.6);animation:pulse-mic 1.5s ease-in-out infinite}@keyframes pulse-mic{0%,100%{transform:translateY(-50%) scale(1);box-shadow:0 0 20px rgba(138,43,226,0.6)}50%{transform:translateY(-50%) scale(1.05);box-shadow:0 0 30px rgba(240,147,251,0.7)}}.mic-button svg{width:18px;height:18px;fill:currentColor}.mic-button:disabled{opacity:0.4;cursor:not-allowed;pointer-events:none}.recording-indicator{position:absolute;bottom:30px;left:50%;transform:translateX(-50%);display:flex;align-items:center;gap:10px;opacity:0;visibility:hidden;transition:opacity 0.3s ease,visibility 0.3s ease;pointer-events:none;z-index:1000;padding:10px 20px;background:rgba(15,15,35,0.7);border-radius:20px;border:1px solid rgba(138,43,226,0.2);backdrop-filter:blur(5px)}.recording-indicator.active{opacity:1;visibility:visible}.sound-waves{display:flex;align-items:center;gap:3px;height:18px}.sound-wave{width:3px;background:linear-gradient(180deg,#667eea 0%,#b794f6 100%);border-radius:2px;animation:sound-wave 0.6s ease-in-out infinite}.sound-wave:nth-child(1){height:8px;animation-delay:0s}.sound-wave:nth-child(2){height:12px;animation-delay:0.1s}.sound-wave:nth-child(3){height:18px;animation-delay:0.2s}.sound-wave:nth-child(4){height:12px;animation-delay:0.3s}.sound-wave:nth-child(5){height:8px;animation-delay:0.4s}@keyframes sound-wave{0%,60%,100%{transform:scaleY(0.5);opacity:0.5}50%{transform:scaleY(1);opacity:1}}.recording-text{font-size:12px;color:#b794f6;font-weight:500;letter-spacing:1px;text-transform:uppercase}.chat-submit{width:40px;height:40px;min-width:40px;padding:0;border:none;border-radius:50%;font-size:14px;background:linear-gradient(135deg,#667eea 0%,#764ba2 50%,#f093fb 100%);color:#fff;cursor:pointer;transition:all 0.3s ease;font-weight:600;box-shadow:0 4px 20px rgba(102,126,234,0.4);display:flex;align-items:center;justify-content:center}.chat-submit:hover{transform:translateY(-2px);box-shadow:0 6px 25px rgba(102,126,234,0.6)}.chat-submit:active{transform:translateY(0)}.chat-submit:disabled{opacity:0.4;cursor:not-allowed;transform:none;box-shadow:none}.chat-submit svg{width:20px;height:20px;fill:#fff}.viewer-panel{flex:1;padding:0;background:linear-gradient(135deg,rgba(22,33,62,0.9) 0%,rgba(15,15,35,0.95) 100%);display:flex;flex-direction:column;justify-content:center;align-items:center;box-shadow:inset 0 0 60px rgba(75,0,130,0.15);position:relative;overflow:hidden;transition:all 0.4s cubic-bezier(0.4,0,0.2,1)}.loading-overlay{display:none;position:absolute;top:0;left:0;width:100%;height:100%;background:rgba(15,15,35,0.85);justify-content:center;align-items:center;z-index:50;backdrop-filter:blur(5px)}.loading-overlay.active{display:flex}.loading-container{display:flex;flex-direction:column;align-items:center;gap:20px}.spinner{width:60px;height:60px;border:4px solid rgba(138,43,226,0.2);border-top-color:#f093fb;border-right-color:#764ba2;border-radius:50%;animation:spin 1s linear infinite;box-shadow:0 0 30px rgba(138,43,226,0.3)}@keyframes spin{to{transform:rotate(360deg)}}.loading-text{color:#b794f6;font-size:14px;letter-spacing:2px;text-transform:uppercase;animation:pulse-text 1.5s ease-in-out infinite}@keyframes pulse-text{0%,100%{opacity:0.5}50%{opacity:1}}.toggle-chat-btn{position:fixed;left:15px;top:50%;transform:translateY(-50%);width:30px;height:60px;background:linear-gradient(135deg,#667eea 0%,#764ba2 50%,#f093fb 100%);border:none;border-radius:0 10px 10px 0;cursor:pointer;z-index:100;display:flex;align-items:center;justify-content:center;box-shadow:0 4px 20px rgba(102,126,234,0.4);transition:left 0.4s cubic-bezier(0.4,0,0.2,1),box-shadow 0.3s ease}.toggle-chat-btn:hover{box-shadow:0 6px 25px rgba(102,126,234,0.6)}.toggle-chat-btn svg{width:16px;height:16px;fill:#fff;transition:transform 0.3s ease;transform:rotate(180deg)}.toggle-chat-btn.expanded{left:calc(30% - 15px)}.toggle-chat-btn.expanded svg{transform:rotate(0deg)}.modal-overlay{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(10,10,20,0.85);backdrop-filter:blur(8px);z-index:2000;justify-content:center;align-items:center;opacity:0;transition:opacity 0.3s ease}.modal-overlay.active{display:flex;opacity:1}.save-modal{background:linear-gradient(135deg,rgba(26,26,46,0.98) 0%,rgba(22,33,62,0.98) 100%);border-radius:20px;padding:0;width:420px;max-width:90%;box-shadow:0 20px 60px rgba(0,0,0,0.5),0 0 40px rgba(138,43,226,0.3),inset 0 1px 0 rgba(255,255,255,0.1);border:1px solid rgba(138,43,226,0.3);transform:scale(0.9) translateY(20px);transition:transform 0.3s ease;overflow:hidden}.modal-overlay.active .save-modal{transform:scale(1) translateY(0)}.modal-header{background:linear-gradient(135deg,#667eea 0%,#764ba2 50%,#f093fb 100%);padding:20px 25px;display:flex;align-items:center;justify-content:space-between}.modal-header h2{color:#fff;font-size:18px;font-weight:600;letter-spacing:1px;text-shadow:0 2px 10px rgba(0,0,0,0.3);display:flex;align-items:center;gap:10px}.modal-header h2 svg{width:22px;height:22px;fill:#fff}.modal-close{background:rgba(255,255,255,0.2);border:none;width:32px;height:32px;border-radius:50%;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all 0.3s ease}.modal-close:hover{background:rgba(255,255,255,0.3);transform:rotate(90deg)}.modal-close svg{width:16px;height:16px;fill:#fff}.modal-body{padding:25px}.modal-label{display:block;color:#b794f6;font-size:13px;font-weight:600;letter-spacing:0.5px;margin-bottom:10px;text-transform:uppercase}.modal-input-wrapper{position:relative;margin-bottom:20px}.modal-input{width:100%;padding:16px 20px;padding-right:45px;border:2px solid rgba(138,43,226,0.3);border-radius:12px;background:rgba(15,15,35,0.8);color:#e0e0e0;font-size:16px;transition:all 0.3s ease}.modal-input:focus{outline:none;border-color:#b794f6;box-shadow:0 0 20px rgba(138,43,226,0.3)}.modal-input::placeholder{color:rgba(183,148,246,0.4)}.input-icon{position:absolute;right:15px;top:50%;transform:translateY(-50%);width:20px;height:20px;fill:rgba(183,148,246,0.5)}.modal-footer{display:flex;gap:12px;justify-content:flex-end}.modal-btn{padding:12px 24px;border-radius:10px;font-size:14px;font-weight:600;letter-spacing:0.5px;cursor:pointer;transition:all 0.3s ease;border:none}.modal-btn-cancel{background:rgba(255,255,255,0.1);color:#b794f6;border:1px solid rgba(138,43,226,0.3)}.modal-btn-cancel:hover{background:rgba(255,255,255,0.15);border-color:rgba(183,148,246,0.5)}.modal-btn-save{background:linear-gradient(135deg,#667eea 0%,#764ba2 50%,#f093fb 100%);color:#fff;box-shadow:0 4px 15px rgba(102,126,234,0.4)}.modal-btn-save:hover{transform:translateY(-2px);box-shadow:0 6px 20px rgba(102,126,234,0.6)}.modal-btn-save:active{transform:translateY(0)}::-webkit-scrollbar{width:10px;height:10px}::-webkit-scrollbar-track{background:rgba(15,15,35,0.6);border-radius:10px}::-webkit-scrollbar-thumb{background:linear-gradient(180deg,#667eea 0%,#764ba2 50%,#f093fb 100%);border-radius:10px;border:2px solid rgba(15,15,35,0.6);box-shadow:0 0 10px rgba(138,43,226,0.4)}::-webkit-scrollbar-thumb:hover{background:linear-gradient(180deg,#f093fb 0%,#764ba2 50%,#667eea 100%);box-shadow:0 0 15px rgba(240,147,251,0.5)}::-webkit-scrollbar-corner{background:rgba(15,15,35,0.6)}*{scrollbar-width:thin;scrollbar-color:#764ba2 rgba(15,15,35,0.6)}
        .game-factory{width:100%;height:100%;display:flex;flex-direction:column;background:linear-gradient(135deg,rgba(102,126,234,0.08) 0%,rgba(118,75,162,0.08) 100%);overflow:hidden;position:relative}
        .gf-header{background:linear-gradient(135deg,rgba(102,126,234,0.3) 0%,rgba(118,75,162,0.3) 100%);padding:20px;height:110px;position:relative;overflow:hidden;border-bottom:1px solid rgba(138,43,226,0.3);display:flex;align-items:center;justify-content:center;flex-shrink:0}
        .gf-header::before{content:'';position:absolute;top:0;left:0;right:0;bottom:0;background:linear-gradient(45deg,transparent 30%,rgba(255,255,255,0.1) 50%,transparent 70%);animation:header-shine 3s ease-in-out infinite}
        @keyframes header-shine{0%,100%{transform:translateX(-100%)}50%{transform:translateX(100%)}}
        .gf-header-content{display:flex;align-items:center;justify-content:center;gap:15px;position:relative;z-index:2}
        .gf-header h1{color:#fff;font-size:32px;font-weight:700;display:flex;align-items:center;gap:12px;text-shadow:0 0 30px rgba(240,147,251,0.5),0 0 60px rgba(102,126,234,0.3);animation:title-glow 2s ease-in-out infinite alternate}
        @keyframes title-glow{0%{text-shadow:0 0 30px rgba(240,147,251,0.5),0 0 60px rgba(102,126,234,0.3)}100%{text-shadow:0 0 40px rgba(240,147,251,0.8),0 0 80px rgba(102,126,234,0.5),0 0 100px rgba(183,148,246,0.3)}}
        .gf-header .factory-icon{font-size:40px;animation:icon-bounce 2s ease-in-out infinite;filter:drop-shadow(0 0 15px rgba(240,147,251,0.6))}
        @keyframes icon-bounce{0%,100%{transform:translateY(0) rotate(0deg)}25%{transform:translateY(-8px) rotate(-5deg)}50%{transform:translateY(0) rotate(0deg)}75%{transform:translateY(-5px) rotate(5deg)}}
        .gf-floating-ideas{position:absolute;top:0;left:0;width:100%;height:100%;overflow:hidden;pointer-events:none}
        .gf-idea{position:absolute;font-size:13px;color:rgba(183,148,246,0.7);white-space:nowrap;animation:float-idea 15s linear infinite;opacity:0;font-weight:500;text-shadow:0 0 10px rgba(138,43,226,0.5)}
        .gf-idea:nth-child(1){top:15%;animation-delay:0s}
        .gf-idea:nth-child(2){top:40%;animation-delay:4s}
        .gf-idea:nth-child(3){top:65%;animation-delay:8s}
        .gf-idea:nth-child(4){top:85%;animation-delay:12s}
        @keyframes float-idea{0%{left:-250px;opacity:0}5%{opacity:0.8}95%{opacity:0.8}100%{left:calc(100% + 250px);opacity:0}}
        .gf-particles{position:absolute;top:0;left:0;width:100%;height:100%;overflow:hidden;pointer-events:none}
        .gf-particle{position:absolute;width:4px;height:4px;background:linear-gradient(135deg,#667eea,#f093fb);border-radius:50%;animation:particle-rise 4s ease-out infinite;opacity:0}
        .gf-particle:nth-child(1){left:10%;animation-delay:0s}
        .gf-particle:nth-child(2){left:25%;animation-delay:0.5s}
        .gf-particle:nth-child(3){left:40%;animation-delay:1s}
        .gf-particle:nth-child(4){left:55%;animation-delay:1.5s}
        .gf-particle:nth-child(5){left:70%;animation-delay:2s}
        .gf-particle:nth-child(6){left:85%;animation-delay:2.5s}
        @keyframes particle-rise{0%{bottom:-10px;opacity:0;transform:scale(0)}20%{opacity:1;transform:scale(1)}100%{bottom:120%;opacity:0;transform:scale(0.5)}}
        .gf-gear{position:absolute;opacity:0.15;animation:gear-spin 10s linear infinite}
        .gf-gear:nth-child(1){top:-20px;right:-20px;font-size:80px;animation-direction:normal}
        .gf-gear:nth-child(2){bottom:-15px;left:-15px;font-size:60px;animation-direction:reverse;animation-duration:8s}
        @keyframes gear-spin{from{transform:rotate(0deg)}to{transform:rotate(360deg)}}
        .gf-chat-area{flex:1;overflow-y:auto;padding:20px;display:flex;flex-direction:column;gap:15px;min-height:0}
        .gf-message{max-width:80%;padding:15px 20px;border-radius:20px;font-size:15px;line-height:1.6;animation:fadeIn 0.3s ease;min-height:auto;max-height:250px;overflow-y:auto}
        .gf-message.bot{align-self:flex-start;background:linear-gradient(135deg,rgba(102,126,234,0.15) 0%,rgba(118,75,162,0.15) 100%);border:1px solid rgba(138,43,226,0.3);border-bottom-left-radius:5px}
        .gf-message.user{align-self:flex-end;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:#fff;border-bottom-right-radius:5px}
        .gf-message::-webkit-scrollbar{width:6px}
        .gf-message::-webkit-scrollbar-track{background:rgba(15,15,35,0.4);border-radius:3px}
        .gf-message::-webkit-scrollbar-thumb{background:rgba(138,43,226,0.4);border-radius:3px}
        .gf-message::-webkit-scrollbar-thumb:hover{background:rgba(138,43,226,0.6)}
        .gf-message strong{color:#f093fb}
        .gf-message em{color:#b794f6}
        .gf-message code{background:rgba(138,43,226,0.3);padding:2px 6px;border-radius:4px;font-family:monospace;color:#f093fb}
        .gf-message ul,.gf-message ol{margin:8px 0 8px 20px}
        .gf-message li{margin-bottom:4px}
        @keyframes fadeIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
        .gf-input-area{padding:20px;background:rgba(0,0,0,0.3);display:flex;gap:12px;align-items:center;flex-wrap:wrap;flex-shrink:0;position:relative}
        .gf-input{flex:1;min-width:200px;padding:16px 20px;border:2px solid rgba(138,43,226,0.3);border-radius:25px;background:rgba(0,0,0,0.4);color:#fff;font-size:15px}
        .gf-input:focus{outline:none;border-color:#b794f6;box-shadow:0 0 15px rgba(138,43,226,0.3)}
        .gf-input::placeholder{color:rgba(255,255,255,0.5)}
        .gf-mic-btn{width:50px;height:50px;border:none;border-radius:50%;background:linear-gradient(135deg,rgba(102,126,234,0.4) 0%,rgba(118,75,162,0.4) 100%);color:#fff;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all 0.3s ease;border:2px solid rgba(138,43,226,0.3)}
        .gf-mic-btn:hover{background:linear-gradient(135deg,rgba(102,126,234,0.6) 0%,rgba(118,75,162,0.6) 100%);transform:scale(1.05)}
        .gf-mic-btn.recording{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);animation:pulse-gf 1.5s ease-in-out infinite;border-color:#b794f6}
        @keyframes pulse-gf{0%,100%{transform:scale(1);box-shadow:0 0 0 0 rgba(138,43,226,0.4)}50%{transform:scale(1.05);box-shadow:0 0 20px 10px rgba(138,43,226,0.2)}}
        .gf-mic-btn svg{width:24px;height:24px;fill:currentColor}
        .gf-mic-btn:disabled{opacity:0.4;cursor:not-allowed}
        .gf-send-btn{width:50px;height:50px;border:none;border-radius:50%;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:#fff;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all 0.3s ease;box-shadow:0 4px 15px rgba(102,126,234,0.4)}
        .gf-send-btn:hover{transform:scale(1.1);box-shadow:0 6px 20px rgba(102,126,234,0.6)}
        .gf-send-btn:disabled{opacity:0.4;cursor:not-allowed;transform:none;box-shadow:none}
        .gf-send-btn svg{width:22px;height:22px;fill:#fff}
        .gf-build-btn{padding:14px 28px;border:none;border-radius:25px;background:linear-gradient(135deg,#f093fb 0%,#764ba2 100%);color:#fff;font-size:14px;font-weight:700;cursor:pointer;transition:all 0.3s ease;text-transform:uppercase;letter-spacing:1px;box-shadow:0 4px 15px rgba(240,147,251,0.4);display:flex;align-items:center;gap:8px;opacity:0.3;pointer-events:none;transform:scale(0.95)}
        .gf-build-btn.active{opacity:1;pointer-events:auto;transform:scale(1)}
        .gf-build-btn:hover{transform:scale(1.05);box-shadow:0 6px 20px rgba(240,147,251,0.5)}
        .gf-build-btn:disabled{opacity:0.4;pointer-events:none;cursor:not-allowed;transform:scale(0.95)}
        .gf-build-btn svg{width:18px;height:18px;fill:#fff}
        .gf-typing{display:flex;gap:6px;padding:15px 20px;align-self:flex-start;background:linear-gradient(135deg,rgba(102,126,234,0.15) 0%,rgba(118,75,162,0.15) 100%);border-radius:20px;border-bottom-left-radius:5px}
        .gf-typing span{width:10px;height:10px;background:#b794f6;border-radius:50%;animation:typing 1.4s infinite ease-in-out}
        .gf-typing span:nth-child(1){animation-delay:0s}
        .gf-typing span:nth-child(2){animation-delay:0.2s}
        .gf-typing span:nth-child(3){animation-delay:0.4s}
        @keyframes typing{0%,60%,100%{transform:translateY(0)}30%{transform:translateY(-10px)}}
        .gf-recording-indicator{display:none;align-items:center;gap:10px;padding:10px 20px;background:rgba(138,43,226,0.2);border-radius:25px;border:1px solid rgba(138,43,226,0.3)}
        .gf-recording-indicator.active{display:flex}
        .gf-waves{display:flex;gap:4px;height:20px}
        .gf-wave{width:4px;background:linear-gradient(180deg,#667eea 0%,#f093fb 100%);border-radius:2px;animation:wave 0.6s ease-in-out infinite}
        .gf-wave:nth-child(1){height:8px;animation-delay:0s}
        .gf-wave:nth-child(2){height:12px;animation-delay:0.1s}
        .gf-wave:nth-child(3){height:20px;animation-delay:0.2s}
        .gf-wave:nth-child(4){height:12px;animation-delay:0.3s}
        .gf-wave:nth-child(5){height:8px;animation-delay:0.4s}
        @keyframes wave{0%,100%{transform:scaleY(0.5)}50%{transform:scaleY(1)}}
        .gf-rec-text{font-size:12px;color:#b794f6;text-transform:uppercase;letter-spacing:1px;font-weight:600}
        .gf-error-toast{position:absolute;bottom:100px;left:50%;transform:translateX(-50%) translateY(20px);background:linear-gradient(135deg,rgba(220,53,69,0.9) 0%,rgba(176,42,55,0.9) 100%);color:#fff;padding:12px 24px;border-radius:25px;font-size:14px;font-weight:500;display:flex;align-items:center;gap:10px;box-shadow:0 4px 20px rgba(220,53,69,0.4);border:1px solid rgba(255,255,255,0.2);opacity:0;visibility:hidden;transition:all 0.3s ease;z-index:100;cursor:pointer}
        .gf-error-toast.active{opacity:1;visibility:visible;transform:translateX(-50%) translateY(0)}
        .gf-error-toast svg{width:20px;height:20px;fill:#fff;flex-shrink:0}
        .gf-error-toast span{white-space:nowrap}
        .build-modal-overlay{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(10,10,20,0.9);backdrop-filter:blur(10px);z-index:3000;justify-content:center;align-items:center;opacity:0;transition:opacity 0.3s ease}
        .build-modal-overlay.active{display:flex;opacity:1}
        .build-modal{background:linear-gradient(135deg,rgba(26,26,46,0.98) 0%,rgba(22,33,62,0.98) 100%);border-radius:25px;padding:0;width:600px;max-width:90%;max-height:80vh;box-shadow:0 20px 60px rgba(0,0,0,0.5),0 0 60px rgba(138,43,226,0.4);border:1px solid rgba(138,43,226,0.3);transform:scale(0.9) translateY(20px);transition:transform 0.3s ease;overflow:hidden;display:flex;flex-direction:column}
        .build-modal-overlay.active .build-modal{transform:scale(1) translateY(0)}
        .build-modal-header{background:linear-gradient(135deg,#667eea 0%,#764ba2 50%,#f093fb 100%);padding:25px;display:flex;align-items:center;justify-content:space-between}
        .build-modal-header h2{color:#fff;font-size:22px;font-weight:700;letter-spacing:1px;display:flex;align-items:center;gap:12px}
        .build-modal-header h2 svg{width:28px;height:28px;fill:#fff}
        .build-modal-close{background:rgba(255,255,255,0.2);border:none;width:36px;height:36px;border-radius:50%;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all 0.3s ease}
        .build-modal-close:hover{background:rgba(255,255,255,0.3);transform:rotate(90deg)}
        .build-modal-close svg{width:18px;height:18px;fill:#fff}
        .build-modal-body{padding:25px;flex:1;overflow-y:auto}
        .build-prompt-area{background:rgba(15,15,35,0.8);border:1px solid rgba(138,43,226,0.3);border-radius:15px;padding:20px;min-height:200px;max-height:300px;overflow-y:auto;color:#e0e0e0;font-size:14px;line-height:1.8;white-space:pre-wrap}
        .build-modal-footer{padding:20px 25px;background:rgba(0,0,0,0.3);display:flex;gap:15px;justify-content:flex-end}
        .build-modal-btn{padding:14px 30px;border-radius:25px;font-size:15px;font-weight:600;cursor:pointer;transition:all 0.3s ease;border:none;display:flex;align-items:center;gap:8px}
        .build-modal-btn-cancel{background:rgba(255,255,255,0.1);color:#b794f6;border:1px solid rgba(138,43,226,0.3)}
        .build-modal-btn-cancel:hover{background:rgba(255,255,255,0.15)}
        .build-modal-btn-go{background:linear-gradient(135deg,#667eea 0%,#764ba2 50%,#f093fb 100%);color:#fff;box-shadow:0 4px 20px rgba(102,126,234,0.5)}
        .build-modal-btn-go:hover{transform:translateY(-2px);box-shadow:0 6px 25px rgba(102,126,234,0.7)}
        .build-modal-btn-go:disabled{opacity:0.4;cursor:not-allowed;transform:none;box-shadow:none}
        .build-modal-btn-go svg{width:18px;height:18px;fill:#fff}
        .build-loading{display:none;flex-direction:column;align-items:center;gap:15px;padding:40px}
        .build-loading.active{display:flex}
        .build-loading .spinner{width:50px;height:50px;border:4px solid rgba(138,43,226,0.2);border-top-color:#f093fb;border-radius:50%;animation:spin 1s linear infinite}
        .build-loading-text{color:#b794f6;font-size:14px;letter-spacing:1px}
        .build-error{display:none;flex-direction:column;align-items:center;gap:15px;padding:40px;text-align:center}
        .build-error.active{display:flex}
        .build-error-icon{width:60px;height:60px;background:linear-gradient(135deg,rgba(220,53,69,0.3) 0%,rgba(176,42,55,0.3) 100%);border-radius:50%;display:flex;align-items:center;justify-content:center;border:2px solid rgba(220,53,69,0.5)}
        .build-error-icon svg{width:30px;height:30px;fill:#dc3545}
        .build-error-text{color:#e0e0e0;font-size:15px;line-height:1.5}
        .build-error-retry{color:#b794f6;font-size:14px;cursor:pointer;text-decoration:underline;transition:color 0.3s ease}
        .build-error-retry:hover{color:#f093fb}
        .genre-chip{display:inline-block;padding:8px 16px;margin:4px;background:linear-gradient(135deg,rgba(102,126,234,0.3) 0%,rgba(118,75,162,0.3) 100%);border:1px solid rgba(138,43,226,0.4);border-radius:20px;color:#b794f6;font-size:13px;cursor:pointer;transition:all 0.3s ease;text-decoration:none}
        .genre-chip:hover{background:linear-gradient(135deg,rgba(102,126,234,0.5) 0%,rgba(118,75,162,0.5) 100%);color:#f093fb;border-color:#b794f6;transform:translateY(-2px);box-shadow:0 4px 15px rgba(138,43,226,0.3)}
        .gf-message .genre-chips{margin-top:12px;display:flex;flex-wrap:wrap;gap:6px}
    </style>
</head>
<body>
    <div class="modal-overlay" id="saveModal">
        <div class="save-modal">
            <div class="modal-header">
                <h2><svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M17 3H5c-1.11 0-2 .9-2 2v14c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V7l-4-4zm-5 16c-1.66 0-3-1.34-3-3s1.34-3 3-3 3 1.34 3 3-1.34 3-3 3zm3-10H5V5h10v4z"/></svg>Save Page</h2>
                <button class="modal-close" id="modalClose"><svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg></button>
            </div>
            <div class="modal-body">
                <label class="modal-label" for="savePageName">Page Name</label>
                <div class="modal-input-wrapper">
                    <input type="text" class="modal-input" id="savePageName" placeholder="Enter page name...">
                    <svg class="input-icon" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M14 2H6c-1.1 0-1.99.9-1.99 2L4 20c0 1.1.89 2 1.99 2H18c1.1 0 2-.9 2-2V8l-6-6zm2 16H8v-2h8v2zm0-4H8v-2h8v2zm-3-5V3.5L18.5 9H13z"/></svg>
                </div>
                <div class="modal-footer">
                    <button class="modal-btn modal-btn-cancel" id="modalCancel">Cancel</button>
                    <button class="modal-btn modal-btn-save" id="modalSave">Save Page</button>
                </div>
            </div>
        </div>
    </div>
    <div class="build-modal-overlay" id="buildModal">
        <div class="build-modal">
            <div class="build-modal-header">
                <h2><svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M19.35 10.04C18.67 6.59 15.64 4 12 4 9.11 4 6.6 5.64 5.35 8.04 2.34 8.36 0 10.91 0 14c0 3.31 2.69 6 6 6h13c2.76 0 5-2.24 5-5 0-2.64-2.05-4.78-4.65-4.96zM14 13v4h-4v-4H7l5-5 5 5h-3z"/></svg>Your Game Design</h2>
                <button class="build-modal-close" id="buildModalClose"><svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg></button>
            </div>
            <div class="build-modal-body">
                <div class="build-loading" id="buildLoading">
                    <div class="spinner"></div>
                    <span class="build-loading-text">Creating your game design...</span>
                </div>
                <div class="build-error" id="buildError">
                    <div class="build-error-icon"><svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"/></svg></div>
                    <span class="build-error-text">Oops! Something went wrong while creating your game design.</span>
                    <span class="build-error-retry" id="buildRetry">üîÑ Try Again</span>
                </div>
                <div class="build-prompt-area" id="buildPromptArea"></div>
            </div>
            <div class="build-modal-footer">
                <button class="build-modal-btn build-modal-btn-cancel" id="buildModalCancel">Keep Chatting</button>
                <button class="build-modal-btn build-modal-btn-go" id="buildModalGo">
                    <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M13 3v6h8l-8 8v-6H5l8-8z"/></svg>
                    Build My Game!
                </button>
            </div>
        </div>
    </div>
    <div class="chat-panel collapsed" id="chatPanel">
        <div class="chat-content">
            <div class="chat-header">SynthOS</div>
            <div class="chat-messages" id="chatMessages">
                <div class="chat-message"><p><strong>SynthOS:</strong> üè≠ Welcome to the <strong>Game Factory</strong>! Use the game designer on the right to dream up your perfect game - pick a genre, answer some fun questions, and when you're ready, click <em>"Build It!"</em> to send your game design back here. I'll turn it into a real playable game for you! ‚ú®üéÆ</p></div>
            </div>
            <div class="link-group">
                <a href="#" id="saveLink">Save</a>
                <a href="/pages" id="pagesLink">Pages</a>
                <a href="#" id="resetLink">Reset</a>
            </div>
            <form action="/" method="POST" id="chatForm">
                <div class="input-wrapper">
                    <input type="text" class="chat-input" id="chatInput" name="message" placeholder="Type a message...">
                    <button type="button" class="mic-button" id="micButton" title="Voice input"><svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3zm-1-9c0-.55.45-1 1-1s1 .45 1 1v6c0 .55-.45 1-1 1s-1-.45-1-1V5zm6 6c0 2.76-2.24 5-5 5s-5-2.24-5-5H5c0 3.53 2.61 6.43 6 6.92V21h2v-3.08c3.39-.49 6-3.39 6-6.92h-2z"/></svg></button>
                </div>
                <button type="submit" class="chat-submit" id="chatSubmit" title="Send"><svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M4 12l1.41 1.41L11 7.83V20h2V7.83l5.58 5.59L20 12l-8-8-8 8z"/></svg></button>
            </form>
        </div>
    </div>
    <button class="toggle-chat-btn" id="toggleChatBtn" title="Toggle chat panel"><svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"/></svg></button>
    <div class="viewer-panel" id="viewerPanel" tabindex="-1">
        <div class="game-factory" id="gameFactory">
            <div class="gf-header">
                <div class="gf-particles"><div class="gf-particle"></div><div class="gf-particle"></div><div class="gf-particle"></div><div class="gf-particle"></div><div class="gf-particle"></div><div class="gf-particle"></div></div>
                <div class="gf-gear">‚öôÔ∏è</div><div class="gf-gear">‚öôÔ∏è</div>
                <div class="gf-floating-ideas"><div class="gf-idea">üèÉ Obby Adventure</div><div class="gf-idea">üí∞ Tycoon Empire</div><div class="gf-idea">üêæ Pet Simulator</div><div class="gf-idea">üè† Roleplay World</div></div>
                <div class="gf-header-content"><h1><span class="factory-icon">üè≠</span> Game Factory</h1></div>
            </div>
            <div class="gf-chat-area" id="gfChatArea">
                <div class="gf-message bot">Hey there, future game creator! üåü Welcome to the Game Factory! I'm here to help you design the most AMAZING game ever!<br><br>What kind of game sounds fun to you? Pick one or tell me your own idea!<div class="genre-chips"><span class="genre-chip" data-genre="Obby">üèÉ Obby</span><span class="genre-chip" data-genre="Tycoon">üí∞ Tycoon</span><span class="genre-chip" data-genre="Simulator">üéÆ Simulator</span><span class="genre-chip" data-genre="Roleplay">üè† Roleplay</span><span class="genre-chip" data-genre="Horror">üëª Horror</span><span class="genre-chip" data-genre="Racing">üèéÔ∏è Racing</span><span class="genre-chip" data-genre="Fighting">‚öîÔ∏è Fighting</span><span class="genre-chip" data-genre="Puzzle">üß© Puzzle</span></div></div>
            </div>
            <div class="gf-input-area">
                <div class="gf-error-toast" id="gfErrorToast">
                    <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"/></svg>
                    <span>Oops! Something went wrong. Please try again!</span>
                </div>
                <div class="gf-recording-indicator" id="gfRecordingIndicator"><div class="gf-waves"><div class="gf-wave"></div><div class="gf-wave"></div><div class="gf-wave"></div><div class="gf-wave"></div><div class="gf-wave"></div></div><span class="gf-rec-text">Listening...</span></div>
                <input type="text" class="gf-input" id="gfInput" placeholder="Tell me about your game idea...">
                <button type="button" class="gf-mic-btn" id="gfMicBtn" title="Talk to me!"><svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3zm-1-9c0-.55.45-1 1-1s1 .45 1 1v6c0 .55-.45 1-1 1s-1-.45-1-1V5zm6 6c0 2.76-2.24 5-5 5s-5-2.24-5-5H5c0 3.53 2.61 6.43 6 6.92V21h2v-3.08c3.39-.49 6-3.39 6-6.92h-2z"/></svg></button>
                <button class="gf-send-btn" id="gfSendBtn" title="Send"><svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg></button>
                <button class="gf-build-btn" id="gfBuildBtn"><svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M19.35 10.04C18.67 6.59 15.64 4 12 4 9.11 4 6.6 5.64 5.35 8.04 2.34 8.36 0 10.91 0 14c0 3.31 2.69 6 6 6h13c2.76 0 5-2.24 5-5 0-2.64-2.05-4.78-4.65-4.96zM14 13v4h-4v-4H7l5-5 5 5h-3z"/></svg>Build It!</button>
            </div>
        </div>
        <div class="recording-indicator" id="recordingIndicator"><div class="sound-waves"><div class="sound-wave"></div><div class="sound-wave"></div><div class="sound-wave"></div><div class="sound-wave"></div><div class="sound-wave"></div></div><span class="recording-text">Listening</span></div>
        <div id="loadingOverlay" class="loading-overlay"><div class="loading-container"><div class="spinner"></div><div class="loading-text">Updating...</div></div></div>
    </div>
    <div id="thoughts" style="display: none;">Fixed two issues: 1) Changed .gf-message max-height from 300px to 250px and removed any dynamic height changes - messages now have a fixed max-height and show internal scrollbar only when content exceeds that height. The outer chat area scrolls normally. 2) Added gfIsProcessing flag to track LLM calls and disable send/build buttons during processing. The setGfProcessing() function now properly disables gfSendBtn, gfBuildBtn, gfMicBtn, and gfInput during LLM calls, and re-enables them after completion or error.</div>
    <script>
        const chatInput=document.getElementById("chatInput"),viewerPanel=document.getElementById("viewerPanel"),micButton=document.getElementById("micButton"),recordingIndicator=document.getElementById("recordingIndicator"),chatForm=document.getElementById("chatForm"),chatSubmit=document.getElementById("chatSubmit");let recognition=null,isRecording=!1;chatInput.addEventListener("mousedown",function(e){e.stopPropagation()}),chatInput.addEventListener("click",function(e){e.stopPropagation(),this.focus()}),chatInput.addEventListener("focus",function(){document.activeElement&&viewerPanel.contains(document.activeElement)&&document.activeElement.blur()}),viewerPanel.addEventListener("click",function(e){(e.target===viewerPanel||e.target.closest(".idle-container")||e.target.closest(".loading-overlay"))&&document.activeElement&&viewerPanel.contains(document.activeElement)&&document.activeElement.blur()}),document.addEventListener("click",function(e){(e.target===chatInput||chatInput.contains(e.target))&&chatInput.focus()});function setLoadingState(e){const t=document.getElementById("saveLink"),a=document.getElementById("pagesLink"),n=document.getElementById("resetLink"),s=document.getElementById("loadingOverlay");e?(t.classList.add("disabled"),a.classList.add("disabled"),n.classList.add("disabled"),chatSubmit.disabled=!0,chatInput.disabled=!0,micButton.disabled=!0,s.classList.add("active")):(t.classList.remove("disabled"),a.classList.remove("disabled"),n.classList.remove("disabled"),chatSubmit.disabled=!1,chatInput.disabled=!1,micButton.disabled=!1,s.classList.remove("active"))}function stopRecording(){recognition&&isRecording&&(recognition.stop(),isRecording=!1,micButton.classList.remove("recording"),recordingIndicator.classList.remove("active"),chatSubmit.disabled=!1)}function startRecording(){recognition&&!isRecording&&(chatInput.dataset.baseValue=chatInput.value,recognition.start(),isRecording=!0,micButton.classList.add("recording"),recordingIndicator.classList.add("active"),chatSubmit.disabled=!0)}function toggleRecording(){isRecording?stopRecording():startRecording()}chatForm.addEventListener("submit",function(e){isRecording&&e.preventDefault(),setTimeout(()=>setLoadingState(!0),0),this.action=window.location.pathname});const saveModal=document.getElementById("saveModal"),savePageNameInput=document.getElementById("savePageName"),modalClose=document.getElementById("modalClose"),modalCancel=document.getElementById("modalCancel"),modalSave=document.getElementById("modalSave");function getCurrentPageName(){const e=window.location.pathname;let t=e.replace(/^\//,"");return t||(t=""),t}function isSpecialPage(e){return!e||""===e||"home"===e.toLowerCase()||e.startsWith("[")&&e.endsWith("]")}function openSaveModal(){const e=getCurrentPageName();isSpecialPage(e)?(savePageNameInput.value="",savePageNameInput.placeholder="Enter page name..."):(savePageNameInput.value=e,savePageNameInput.placeholder="Enter page name..."),saveModal.classList.add("active"),setTimeout(()=>savePageNameInput.focus(),100)}function closeSaveModal(){saveModal.classList.remove("active")}function performSave(){const e=savePageNameInput.value.trim();if(e){const t=`${window.location.pathname}/save?name=${encodeURIComponent(e)}`;window.location.href=t}}document.getElementById("saveLink").addEventListener("click",function(e){e.preventDefault(),this.classList.contains("disabled")||openSaveModal()}),modalClose.addEventListener("click",closeSaveModal),modalCancel.addEventListener("click",closeSaveModal),modalSave.addEventListener("click",performSave),saveModal.addEventListener("click",function(e){e.target===saveModal&&closeSaveModal()}),savePageNameInput.addEventListener("keydown",function(e){"Enter"===e.key?(e.preventDefault(),performSave()):"Escape"===e.key&&closeSaveModal()}),document.getElementById("resetLink").addEventListener("click",function(e){e.preventDefault(),this.classList.contains("disabled")||(setLoadingState(!0),window.location.href=`${window.location.pathname}/reset`)}),document.getElementById("pagesLink").addEventListener("click",function(e){this.classList.contains("disabled")&&e.preventDefault()}),window.onload=function(){const e=document.getElementById("chatMessages");e.scrollTo({top:e.scrollHeight,behavior:"smooth"})};const toggleBtn=document.getElementById("toggleChatBtn"),chatPanel=document.getElementById("chatPanel");toggleBtn.addEventListener("click",function(){chatPanel.classList.toggle("collapsed"),toggleBtn.classList.toggle("expanded")});"webkitSpeechRecognition"in window||"SpeechRecognition"in window?(recognition=new(window.SpeechRecognition||window.webkitSpeechRecognition),recognition.continuous=!0,recognition.interimResults=!0,recognition.lang="en-US",recognition.maxAlternatives=1,recognition.onend=function(){if(isRecording)try{recognition.start()}catch(e){isRecording=!1,micButton.classList.remove("recording"),recordingIndicator.classList.remove("active"),chatSubmit.disabled=!1}},recognition.onresult=function(e){let t="",a="";for(let n=e.resultIndex;n<e.results.length;n++){const s=e.results[n][0].transcript;e.results[n].isFinal?t+=s:a+=s}if(t){const e=chatInput.value;e&&!e.endsWith(" ")?chatInput.value=e+" "+t:chatInput.value=e+t,chatInput.dataset.baseValue=chatInput.value}else if(a){const e=chatInput.dataset.baseValue||"";chatInput.value=e+a}},recognition.onerror=function(e){"no-speech"!==e.error&&"aborted"!==e.error&&(isRecording=!1,micButton.classList.remove("recording"),recordingIndicator.classList.remove("active"),chatSubmit.disabled=!1)},micButton.addEventListener("click",function(){this.disabled||toggleRecording()})):(micButton.style.opacity="0.5",micButton.style.cursor="not-allowed",micButton.title="Speech recognition not supported in this browser");
        function parseMarkdown(t){return t.replace(/\*\*(.+?)\*\*/g,"<strong>$1</strong>").replace(/\*(.+?)\*/g,"<em>$1</em>").replace(/`(.+?)`/g,"<code>$1</code>").replace(/\[(.+?)\]\((.+?)\)/g,'<a href="$2" target="_blank">$1</a>').replace(/^\* (.+)$/gm,"<li>$1</li>").replace(/(<li>.*<\/li>)/s,"<ul>$1</ul>").replace(/\n/g,"<br>")}
        const gfInput=document.getElementById("gfInput"),gfSendBtn=document.getElementById("gfSendBtn"),gfMicBtn=document.getElementById("gfMicBtn"),gfChatArea=document.getElementById("gfChatArea"),gfBuildBtn=document.getElementById("gfBuildBtn"),gfRecordingIndicator=document.getElementById("gfRecordingIndicator"),gfErrorToast=document.getElementById("gfErrorToast"),buildModal=document.getElementById("buildModal"),buildModalClose=document.getElementById("buildModalClose"),buildModalCancel=document.getElementById("buildModalCancel"),buildModalGo=document.getElementById("buildModalGo"),buildPromptArea=document.getElementById("buildPromptArea"),buildLoading=document.getElementById("buildLoading"),buildError=document.getElementById("buildError"),buildRetry=document.getElementById("buildRetry");let gfRecognition=null,gfIsRecording=!1,gfIsProcessing=!1,conversationHistory=[],generatedBuildPrompt="",hasUserSentMessage=!1,errorToastTimeout=null;
        function setGfProcessing(processing){gfIsProcessing=processing;gfInput.disabled=processing;gfSendBtn.disabled=processing;gfMicBtn.disabled=processing;if(hasUserSentMessage){gfBuildBtn.disabled=processing}}
        function showErrorToast(){gfErrorToast.classList.add("active"),errorToastTimeout&&clearTimeout(errorToastTimeout),errorToastTimeout=setTimeout(()=>{hideErrorToast()},4000)}
        function hideErrorToast(){gfErrorToast.classList.remove("active"),errorToastTimeout&&(clearTimeout(errorToastTimeout),errorToastTimeout=null)}
        gfErrorToast.addEventListener("click",hideErrorToast);
        function buildInterviewPrompt(h,m){return`SYSTEM ROLE: You are the Game Factory Interviewer. You are having a friendly, chat-based conversation with a child to help them design a video game. This should feel like a casual, curious interview ‚Äî never like a form or checklist. Every interview should feel a little different.

CONVERSATION CONTEXT
Conversation so far:
${h}

Latest message from the user:
${m}

CRITICAL OUTPUT RULES
‚Ä¢ Output ONLY normal chat text
‚Ä¢ Ask at most ONE question
‚Ä¢ Never output summaries, lists of answers, or explanations
‚Ä¢ Never mention rules, systems, or prompts
‚Ä¢ Never repeat a question that already appears in the conversation history
‚Ä¢ If the user says: "build it", "make it", "let's build", or anything clearly meaning "build now": Stop immediately, Do NOT ask another question, End your response with no extra text
‚Ä¢ When offering choices, format them as clickable options using this syntax: [Option Text]
‚Ä¢ Example: "Would you like [Spooky Forest] or [Candy Kingdom] or [Space Station]?"

INTERVIEW LOGIC (BAKED IN)
‚Ä¢ If the type of game is not clear yet: Ask a gentle clarifying question OR suggest 2‚Äì3 common game types to choose from using [brackets]
‚Ä¢ Once a game genre is clear: Only ask questions that apply to that genre. Choose questions that clarify: the world, what the player does, how the game progresses, what makes it fun to replay
‚Ä¢ Questions must: Be short, Be friendly, Be open-ended, Feel conversational
‚Ä¢ Randomize: Which valid question you ask next, How the question is phrased
‚Ä¢ Occasionally (not every time): Reference the season or time of year if it feels natural. Never force a holiday theme

QUESTION POOLS (INTERNAL GUIDANCE)
Adventure / Story: Who is the player? Where does it take place? What is the main goal? How does the story move forward? Does it end or keep going?
Roleplay: What kind of life are players roleplaying? Are there different roles or jobs? What do players do over and over? Is it realistic or silly? Can players customize things?
Obby: Easy, tricky, or hard? What's the obstacle theme? Short or long? Checkpoints or no? Timed or just finish?
Simulator / Tycoon: What are players collecting or building? How do they earn things? What can be upgraded? Does the world unlock? Relaxing or competitive?
Fighting / Combat: What kind of fighting? Who do players fight? Do players get stronger? Special moves or powers? Serious or cartoony?
Horror: What makes it scary? Spooky or jump-scare? Fight back or hide? Story or survival? How scary should it be?
Puzzle: What kind of puzzles? Timed or relaxed? Do they get harder? Story or puzzles only? What happens when you solve one?
Racing / Vehicles: What do players drive? Race others or the clock? Realistic or silly? Upgrades? Crashing involved?
Collection / Pets: What are players collecting? How do they get them? Are some rare? Do they grow or change? Can players trade or show them off?
Minigames: How many games? Silly or competitive? How long are rounds? Rewards between games? Best with friends or solo?

COMPLETION RULE
If all relevant questions for the chosen genre have already been asked and answered in the conversation history, respond with EXACTLY: Now Go Build It!`}
        function parseGfMarkdown(t){let r=t.replace(/\*\*(.+?)\*\*/g,"<strong>$1</strong>").replace(/\*(.+?)\*/g,"<em>$1</em>").replace(/`(.+?)`/g,"<code>$1</code>").replace(/\[(.+?)\]\((.+?)\)/g,'<a href="$2" target="_blank">$1</a>').replace(/^\* (.+)$/gm,"<li>$1</li>").replace(/(<li>.*<\/li>)/s,"<ul>$1</ul>");const chips=[];r=r.replace(/\[([^\]]+)\]/g,(m,p1)=>{if(!p1.includes("http")){chips.push(p1);return`<span class="genre-chip" data-genre="${p1}">${p1}</span>`}return m});if(chips.length>0){r=r.replace(/(<span class="genre-chip"[^>]*>[^<]*<\/span>)/g,'$1 ')}return r.replace(/\n/g,"<br>")}
        function addBotMessage(t){const e=document.createElement("div");e.className="gf-message bot",e.innerHTML=parseGfMarkdown(t),gfChatArea.appendChild(e),gfChatArea.scrollTop=gfChatArea.scrollHeight,conversationHistory.push({role:"assistant",content:t}),bindGenreChips(e),t.trim().toLowerCase().includes("now go build it")&&setTimeout(()=>{hasUserSentMessage&&openBuildModal()},500)}
        function addUserMessage(t){const e=document.createElement("div");e.className="gf-message user",e.textContent=t,gfChatArea.appendChild(e),gfChatArea.scrollTop=gfChatArea.scrollHeight,conversationHistory.push({role:"user",content:t})}
        function showTyping(){const t=document.createElement("div");t.className="gf-typing",t.id="gfTyping",t.innerHTML="<span></span><span></span><span></span>",gfChatArea.appendChild(t),gfChatArea.scrollTop=gfChatArea.scrollHeight}
        function hideTyping(){const t=document.getElementById("gfTyping");t&&t.remove()}
        function formatConversationHistory(){return conversationHistory.map(e=>`${"user"===e.role?"Child":"Game Factory"}: ${e.content}`).join("\n\n")}
        function bindGenreChips(container){container.querySelectorAll(".genre-chip").forEach(chip=>{chip.addEventListener("click",function(){const genre=this.dataset.genre;if(genre&&!gfIsRecording&&!gfIsProcessing){processUserInput(genre)}})})}
        document.querySelectorAll(".genre-chip").forEach(chip=>{chip.addEventListener("click",function(){const genre=this.dataset.genre;if(genre&&!gfIsRecording&&!gfIsProcessing){processUserInput(genre)}})});
        async function processUserInput(t){hideErrorToast();addUserMessage(t),hasUserSentMessage||(hasUserSentMessage=!0,gfBuildBtn.classList.add("active"));const e=["build it","make it","let's build","lets build","build my game","make my game"];if(e.some(e=>t.toLowerCase().includes(e)))return void openBuildModal();showTyping(),setGfProcessing(!0);try{const a=formatConversationHistory(),n=buildInterviewPrompt(a,t),s=await fetch("/api/generate/completion",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({prompt:n,temperature:.7})}),i=await s.json();if(!s.ok||!i.answer) throw new Error("LLM error");hideTyping(),addBotMessage(i.answer)}catch(e){hideTyping();conversationHistory.pop();showErrorToast()}setGfProcessing(!1);gfInput.value="",gfInput.focus()}
        gfSendBtn.addEventListener("click",function(){if(!gfIsRecording&&!gfIsProcessing){const t=gfInput.value.trim();t&&processUserInput(t)}}),gfInput.addEventListener("keydown",function(t){"Enter"===t.key&&(t.preventDefault(),gfIsRecording||gfIsProcessing||gfSendBtn.click())});
        async function generateBuildPrompt(){buildPromptArea.style.display="none",buildError.classList.remove("active"),buildLoading.classList.add("active"),buildModalGo.disabled=!0;const t=formatConversationHistory(),e=`You are a game design document generator. Based on this conversation between a child and the Game Factory assistant, create a detailed game design prompt that can be used to build a playable web-based game.\n\nCONVERSATION:\n${t}\n\nGenerate a comprehensive game design document that includes:\n1. GAME TITLE - A catchy name for the game\n2. GENRE - The type of game (Obby, Tycoon, Simulator, etc.)\n3. CORE GAMEPLAY - What the player does moment-to-moment\n4. SETTING/THEME - The world, visuals, and atmosphere\n5. PLAYER ABILITIES - What the player can do (jump, collect, build, etc.)\n6. PROGRESSION - How the player advances (levels, upgrades, unlocks)\n7. UNIQUE FEATURES - What makes this game special\n8. WIN CONDITION - How to beat the game or main goals\n\nWrite this as a clear, detailed prompt that could be given to a developer to build a simple web-based version of this game. Be specific and creative!`;try{const a=await fetch("/api/generate/completion",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({prompt:e,temperature:.7})}),n=await a.json();if(!a.ok || !n.answer) throw new Error("LLM error");generatedBuildPrompt=n.answer,buildPromptArea.textContent=generatedBuildPrompt,buildLoading.classList.remove("active"),buildPromptArea.style.display="block",buildModalGo.disabled=!1}catch(t){buildLoading.classList.remove("active"),buildError.classList.add("active"),buildPromptArea.style.display="none"}}
        async function openBuildModal(){buildModal.classList.add("active"),await generateBuildPrompt()}
        function closeBuildModal(){buildModal.classList.remove("active")}
        buildRetry.addEventListener("click",function(){generateBuildPrompt()});
        gfBuildBtn.addEventListener("click",function(){hasUserSentMessage&&!gfIsProcessing&&openBuildModal()}),buildModalClose.addEventListener("click",closeBuildModal),buildModalCancel.addEventListener("click",closeBuildModal),buildModal.addEventListener("click",function(t){t.target===buildModal&&closeBuildModal()}),buildModalGo.addEventListener("click",function(){const t=`Build me a playable web game based on this design:\n\n${generatedBuildPrompt}`;chatInput.value=t,closeBuildModal(),chatPanel.classList.remove("collapsed"),toggleBtn.classList.add("expanded"),setTimeout(()=>{chatForm.requestSubmit()},300)});
        if("webkitSpeechRecognition"in window||"SpeechRecognition"in window){gfRecognition=new(window.SpeechRecognition||window.webkitSpeechRecognition),gfRecognition.continuous=!0,gfRecognition.interimResults=!0,gfRecognition.lang="en-US",gfRecognition.maxAlternatives=1,gfRecognition.onend=function(){if(gfIsRecording)try{gfRecognition.start()}catch(t){gfIsRecording=!1,gfMicBtn.classList.remove("recording"),gfRecordingIndicator.classList.remove("active"),gfSendBtn.disabled=gfIsProcessing}},gfRecognition.onresult=function(t){let e="",a="";for(let n=t.resultIndex;n<t.results.length;n++){const s=t.results[n][0].transcript;t.results[n].isFinal?e+=s:a+=s}if(e){const t=gfInput.dataset.baseValue||"";t&&!t.endsWith(" ")?gfInput.value=t+" "+e:gfInput.value=t+e,gfInput.dataset.baseValue=gfInput.value}else if(a){const t=gfInput.dataset.baseValue||"";gfInput.value=t+a}},gfRecognition.onerror=function(t){"no-speech"!==t.error&&"aborted"!==t.error&&(gfIsRecording=!1,gfMicBtn.classList.remove("recording"),gfRecordingIndicator.classList.remove("active"),gfSendBtn.disabled=gfIsProcessing)};function gfStopRecording(){gfRecognition&&gfIsRecording&&(gfRecognition.stop(),gfIsRecording=!1,gfMicBtn.classList.remove("recording"),gfRecordingIndicator.classList.remove("active"),gfSendBtn.disabled=gfIsProcessing)}function gfStartRecording(){gfRecognition&&!gfIsRecording&&!gfIsProcessing&&(gfInput.dataset.baseValue=gfInput.value,gfRecognition.start(),gfIsRecording=!0,gfMicBtn.classList.add("recording"),gfRecordingIndicator.classList.add("active"),gfSendBtn.disabled=!0)}function gfToggleRecording(){gfIsRecording?gfStopRecording():gfStartRecording()}gfMicBtn.addEventListener("click",function(){this.disabled||gfToggleRecording()})}else gfMicBtn.style.opacity="0.5",gfMicBtn.style.cursor="not-allowed",gfMicBtn.title="Speech recognition not supported";
    </script>
</body>
</html>