<!DOCTYPE html><html lang="en"><head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teams - Settings</title>
    <script id="theme-info" src="/api/theme-info.js" data-locked="true"></script>
    <link id="theme-css" rel="stylesheet" href="/api/theme.css" data-locked="true">
    <style>
.viewer-panel { padding: 0 20px }
.viewer-panel > div { flex: none }
.viewer-panel > .settings-container { flex: 1; min-height: 0 }
.settings-title { font-size: 18px; font-weight: 700; padding: 14px 20px; display: flex; align-items: center; justify-content: center; box-sizing: border-box; background: var(--accent-primary); color: var(--accent-contrast, #fff); border-radius: 6px 6px 0 0; width: 100%; box-shadow: var(--shadow-sm) }
.settings-container { display: flex; flex-direction: column; width: 100%; flex-grow: 1; background: var(--bg-secondary); border-radius: 0 0 6px 6px; border: 1px solid var(--border-color); border-top: none; overflow: hidden }
.accordion-section { display: flex; flex-direction: column; flex-shrink: 0; overflow: hidden; border-bottom: 1px solid var(--border-color) }
.accordion-section:last-child { border-bottom: none }
.accordion-section.active { flex-shrink: 1; flex-grow: 1; min-height: 0 }
.accordion-header { display: flex; justify-content: space-between; align-items: center; width: 100%; padding: 14px 20px; background: none; border: none; color: var(--text-primary); font-size: 14px; font-weight: 600; cursor: pointer; transition: background 0.2s; flex-shrink: 0 }
.accordion-header:hover { background: var(--surface-hover, var(--bg-tertiary)) }
.accordion-section.active .accordion-header { background: var(--accent-glow) }
.accordion-chevron { font-size: 11px; color: var(--text-secondary); transition: transform 0.3s }
.accordion-section.active .accordion-chevron { transform: rotate(180deg) }
.accordion-body { display: none; flex-direction: column; flex-grow: 1; min-height: 0; overflow: hidden }
.accordion-section.active .accordion-body { display: flex }
.accordion-content { display: flex; flex-direction: column; gap: 12px; overflow-y: auto; padding: 16px 20px; flex-grow: 1 }
.button-row { display: flex; justify-content: flex-end; padding: 12px 20px; border-top: 1px solid var(--border-color); flex-shrink: 0 }
.apply-btn { padding: 10px 24px; border: none; border-radius: 4px; font-size: 14px; background: var(--accent-primary); color: var(--accent-contrast, #fff); cursor: pointer; transition: 0.2s; font-weight: 600 }
.apply-btn:hover { background: var(--accent-hover) }
.apply-btn:active { background: var(--accent-pressed) }
.apply-btn:disabled { opacity: 0.35; pointer-events: none; cursor: default }
.form-group { display: flex; flex-direction: column; width: 100% }
.form-group label { display: block; margin-bottom: 6px; color: var(--text-secondary); font-weight: 600; font-size: 13px }
.form-group input, .form-group select, .form-group textarea { width: 100%; padding: 10px 14px; border-radius: 4px; border: 1px solid var(--border-color); background: var(--input-bg, var(--bg-primary)); color: var(--text-primary); font-size: 14px; transition: border-color 0.2s; box-sizing: border-box }
.form-group input:focus, .form-group select:focus, .form-group textarea:focus { outline: none; box-shadow: inset 0 -2px 0 var(--accent-primary) }
.form-group input::placeholder, .form-group textarea::placeholder { color: var(--input-placeholder, var(--text-disabled)) }
.form-group textarea { resize: vertical; min-height: 80px }
.form-group select { padding-right: 32px }
.info-text { color: var(--text-secondary); font-size: 13px; line-height: 1.6; text-align: center; padding: 12px; background: var(--bg-tertiary); border-radius: 6px; border: 1px solid var(--border-color) }
.info-text a { color: var(--accent-primary); text-decoration: none; font-weight: 500 }
.info-text a:hover { text-decoration: underline }
.config-required-banner { padding: 12px 16px; background: var(--alert-warn-bg, rgba(255,180,50,0.12)); border: 1px solid var(--alert-warn-border, rgba(255,180,50,0.3)); border-radius: 6px; color: var(--alert-warn-fg, #8A6A00); font-size: 13px; font-weight: 500; text-align: center; line-height: 1.5 }
.model-card { border: 1px solid var(--border-color); border-radius: 6px; padding: 16px; display: flex; flex-direction: column; gap: 10px; background: var(--bg-tertiary) }
.model-card-title { font-size: 14px; font-weight: 700; color: var(--text-primary); margin: 0 }
.model-card.disabled { opacity: 0.35; pointer-events: none; user-select: none }
.filter-btn { padding: 6px 14px; border-radius: 4px; border: 1px solid var(--border-color); background: transparent; color: var(--text-secondary); font-size: 13px; cursor: pointer; transition: 0.2s; white-space: nowrap; flex-shrink: 0 }
.filter-btn:hover { border-color: var(--accent-primary); color: var(--accent-primary) }
.filter-btn.active { background: var(--accent-primary); color: var(--accent-contrast, #fff); border-color: transparent }
.toggle-switch { position: relative; width: 44px; height: 24px; flex-shrink: 0 }
.toggle-switch input { opacity: 0; width: 0; height: 0 }
.toggle-slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background: var(--toggle-track-off, #c8c6c4); border: 1px solid var(--toggle-border-off, #8A8886); border-radius: 24px; transition: 0.3s }
.toggle-slider:before { content: ""; position: absolute; height: 18px; width: 18px; left: 2px; bottom: 2px; background: var(--toggle-thumb, #8A8886); border-radius: 50%; transition: 0.3s }
.toggle-switch input:checked + .toggle-slider { background: var(--toggle-track-on, var(--accent-primary)); border-color: var(--toggle-border-on, var(--accent-primary)) }
.toggle-switch input:checked + .toggle-slider:before { transform: translateX(20px); background: var(--accent-contrast, #fff) }
.more-settings-link { display: inline-block; color: var(--accent-primary); font-size: 13px; cursor: pointer; text-decoration: none; padding: 4px 0; transition: 0.2s; user-select: none }
.more-settings-link:hover { text-decoration: underline }
.wizard-hidden { display: none !important }
.accordion-section.disabled .accordion-header { opacity: 0.35; pointer-events: none; cursor: default }
.agent-toggle-row { display: flex; align-items: center; gap: 10px }
.agent-list { display: flex; flex-direction: column; gap: 0; max-height: 400px; overflow-y: auto; border: 1px solid var(--border-color); border-radius: 6px }
.agent-row { display: flex; align-items: center; gap: 12px; padding: 12px 16px; border-bottom: 1px solid var(--border-color); cursor: pointer; transition: background 0.15s }
.agent-row:last-child { border-bottom: none }
.agent-row:hover { background: var(--surface-hover, var(--bg-tertiary)) }
.agent-row.selected { background: var(--accent-glow) }
.agent-row-info { flex: 1; min-width: 0; display: flex; align-items: center; gap: 10px }
.agent-row-name { font-size: 14px; font-weight: 600; color: var(--text-primary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis }
.agent-row-desc { font-size: 12px; color: var(--text-secondary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; flex: 1; min-width: 0 }
.agent-row-badge { font-size: 11px; color: var(--text-secondary); background: var(--accent-glow); padding: 2px 8px; border-radius: 4px; white-space: nowrap; flex-shrink: 0 }
.agent-status-dot { width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0 }
.agent-status-dot.connected { background: var(--status-success, #107C10) }
.agent-status-dot.disconnected { background: var(--text-disabled) }
.agent-row-actions { display: flex; align-items: center; gap: 8px; flex-shrink: 0 }
.agent-chat-panel { border: 1px solid var(--border-color); border-radius: 6px; margin-top: 12px; overflow: hidden; display: none }
.agent-chat-panel.open { display: flex; flex-direction: column }
.agent-chat-header { display: flex; justify-content: space-between; align-items: center; padding: 10px 16px; background: var(--accent-glow); font-size: 13px; font-weight: 600; color: var(--text-primary) }
.agent-chat-close { background: none; border: none; color: var(--text-secondary); cursor: pointer; font-size: 16px; padding: 0 4px }
.agent-chat-close:hover { color: var(--text-primary) }
.agent-chat-messages { max-height: 250px; overflow-y: auto; padding: 12px 16px; display: flex; flex-direction: column; gap: 8px; font-size: 13px }
.agent-chat-msg { padding: 8px 12px; border-radius: 6px; max-width: 85%; line-height: 1.5; word-wrap: break-word; white-space: pre-wrap }
.agent-chat-msg.user { background: var(--accent-primary); color: var(--accent-contrast, #fff); align-self: flex-end }
.agent-chat-msg.agent { background: var(--bg-tertiary); color: var(--text-primary); align-self: flex-start; border: 1px solid var(--border-color) }
.agent-chat-msg.error { background: var(--alert-error-bg); color: var(--alert-error-fg); align-self: center; font-size: 12px }
.agent-chat-msg.status { color: var(--text-secondary); align-self: center; font-size: 12px; font-style: italic }
.agent-chat-input-row { display: flex; gap: 8px; padding: 12px 16px; border-top: 1px solid var(--border-color) }
.agent-chat-input { flex: 1; padding: 10px 14px; border-radius: 4px; border: 1px solid var(--border-color); background: var(--input-bg, var(--bg-primary)); color: var(--text-primary); font-size: 13px }
.agent-chat-input:focus { outline: none; box-shadow: inset 0 -2px 0 var(--accent-primary) }
.agent-chat-input::placeholder { color: var(--input-placeholder, var(--text-disabled)) }
.agent-chat-send { padding: 10px 18px; border: none; border-radius: 4px; font-size: 13px; background: var(--accent-primary); color: var(--accent-contrast, #fff); cursor: pointer; font-weight: 600; transition: 0.2s }
.agent-chat-send:hover { background: var(--accent-hover) }
.agent-chat-send:disabled { opacity: 0.5; pointer-events: none }
.conn-modal-content { background: var(--surface, var(--bg-primary)); border: 1px solid var(--border-color); border-radius: 8px; padding: 24px; max-width: 520px; width: 90%; max-height: 85vh; display: flex; flex-direction: column; gap: 14px; box-shadow: var(--shadow-lg, 0 6px 18px rgba(0,0,0,0.18)); overflow-y: auto }
.conn-modal-title { font-size: 16px; font-weight: 700; color: var(--text-primary) }
.conn-modal-desc { font-size: 13px; color: var(--text-secondary); line-height: 1.5 }
.conn-modal-actions { display: flex; gap: 10px; justify-content: flex-end; margin-top: 8px }
.conn-modal-btn { padding: 10px 20px; border: none; border-radius: 4px; font-size: 14px; background: var(--accent-primary); color: var(--accent-contrast, #fff); cursor: pointer; transition: 0.2s; font-weight: 600 }
.conn-modal-btn:hover { background: var(--accent-hover) }
.conn-modal-btn.cancel { background: transparent; border: 1px solid var(--border-color); color: var(--text-primary) }
.conn-modal-btn.cancel:hover { background: var(--surface-hover, var(--bg-tertiary)) }
.conn-modal-btn.remove { background: var(--danger, #d13438); color: #fff }
.conn-modal-btn.remove:hover { opacity: 0.85 }
</style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.9.0/d3.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/14.1.1/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mermaid/11.1.0/mermaid.min.js"></script>
</head>
<body>
    <div class="viewer-panel" id="viewerPanel" style="justify-content: flex-start; align-items: stretch;">
        <div class="settings-title" style="max-width: none; border-radius: 6px 6px 0 0;">Settings</div>
        <div class="settings-container" style="max-width: none; border-radius: 0; max-height: none; flex-grow: 1;">

            <div class="accordion-section active" data-section="general">
                <button class="accordion-header">
                    <span>General</span>
                    <span class="accordion-chevron">&#9662;</span>
                </button>
                <div class="accordion-body">
                    <div class="accordion-content">
                        <div class="form-group">
                            <label for="theme">Theme</label>
                            <select id="theme">
                                <option value="">Loading themes...</option>
                            </select>
                        </div>
                    </div>
                    <div class="button-row">
                        <button class="apply-btn" data-apply="general">Apply</button>
                    </div>
                </div>
            </div>

            <div class="accordion-section" data-section="models">
                <button class="accordion-header">
                    <span>Page Building &amp; Chat</span>
                    <span class="accordion-chevron">&#9662;</span>
                </button>
                <div class="accordion-body">
                    <div class="accordion-content">
                        <div id="configBanner" class="config-required-banner" style="display:none;">
                            Model configuration is required before you can use Teams. Please fill in the Page Builder fields below and click Apply.
                        </div>

                        <div class="model-card" id="builderCard">
                            <div class="model-card-title">Page Builder Model</div>
                            <div class="form-group">
                                <label for="provider-builder">Provider</label>
                                <select id="provider-builder" required="">
                                    <option value="">Select a provider</option>
                                </select>
                            </div>
                            <div class="form-group" id="fg-apikey-builder">
                                <label for="serviceApiKey-builder">API Key</label>
                                <input type="password" id="serviceApiKey-builder" placeholder="Enter your API Key" required="">
                                <div id="providerInstructions" class="info-text" style="display:none;margin-top:8px;"></div>
                            </div>
                            <div class="form-group" id="fg-model-builder">
                                <label for="model-builder">Model</label>
                                <select id="model-builder" required="">
                                    <option value="">Select a model</option>
                                </select>
                            </div>
                            <a id="moreSettingsLink" class="more-settings-link">&#9662; More settings</a>
                            <div class="form-group" id="fg-maxTokens-builder">
                                <label for="maxTokens-builder">Max Output Tokens</label>
                                <input type="number" id="maxTokens-builder" placeholder="Enter max token count" required="">
                            </div>
                            <div class="form-group" id="fg-instructions-builder">
                                <label for="instructions-builder">Additional Instructions</label>
                                <textarea id="instructions-builder" placeholder="Enter any additional instructions"></textarea>
                            </div>
                        </div>

                        <div class="model-card" id="chatCard">
                            <div class="model-card-title">Chat Model</div>
                            <div class="form-group" id="fg-provider-chat">
                                <label for="provider-chat">Provider</label>
                                <select id="provider-chat" required="">
                                    <option value="">Select a provider</option>
                                </select>
                            </div>
                            <div class="form-group" id="fg-apikey-chat">
                                <label for="serviceApiKey-chat">API Key</label>
                                <input type="password" id="serviceApiKey-chat" placeholder="Enter your API Key" required="">
                            </div>
                            <div class="form-group" id="fg-model-chat">
                                <label for="model-chat">Model</label>
                                <select id="model-chat" required="">
                                    <option value="">Select a model</option>
                                </select>
                            </div>
                            <a id="moreSettingsLinkChat" class="more-settings-link">&#9662; More settings</a>
                            <div class="form-group" id="fg-maxTokens-chat">
                                <label for="maxTokens-chat">Max Output Tokens</label>
                                <input type="number" id="maxTokens-chat" placeholder="Enter max token count" required="">
                            </div>
                            <div class="form-group" id="fg-instructions-chat">
                                <label for="instructions-chat">Additional Instructions</label>
                                <textarea id="instructions-chat" placeholder="Enter any additional instructions"></textarea>
                            </div>
                        </div>

                    </div>
                    <div class="button-row">
                        <button class="apply-btn" data-apply="models">Apply</button>
                    </div>
                </div>
            </div>

            <div class="accordion-section" data-section="agents">
                <button class="accordion-header">
                    <span>Agents <span style="display:inline-block;margin-left:6px;padding:1px 7px;font-size:10px;font-weight:600;letter-spacing:.5px;border-radius:6px;background:var(--accent-tertiary, #8a2be2);color:#fff;vertical-align:middle;line-height:16px;text-transform:uppercase;">Preview</span></span>
                    <span class="accordion-chevron">&#9662;</span>
                </button>
                <div class="accordion-body">
                    <div class="accordion-content">
                        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
                            <div style="font-size:13px;color:var(--text-secondary);">Configure agents (A2A or OpenClaw) that your pages can communicate with.</div>
                            <button class="conn-modal-btn" id="addAgentBtn" style="padding:8px 18px;font-size:13px;">+ Add Agent</button>
                        </div>
                        <div class="agent-list" id="agentList"></div>
                        <div id="agentEmptyState" style="display:none;text-align:center;padding:30px;color:var(--text-secondary);font-size:14px;">
                            No agents configured yet. Click "+ Add Agent" to get started.
                        </div>
                        <div class="agent-chat-panel" id="agentChatPanel">
                            <div class="agent-chat-header">
                                <span id="agentChatTitle">Chat with Agent</span>
                                <button class="agent-chat-close" id="agentChatClose">&times;</button>
                            </div>
                            <div class="agent-chat-messages" id="agentChatMessages"></div>
                            <div class="agent-chat-input-row">
                                <input type="text" class="agent-chat-input" id="agentChatInput" placeholder="Type a test message...">
                                <button class="agent-chat-send" id="agentChatSendBtn">Send</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </div>
        <div id="loadingOverlay" class="loading-overlay"><div class="spinner"></div></div>
    </div>
    <div class="chat-rail" aria-label="Open chat panel"><span class="chat-rail-label">Tab Designer</span></div>
    <div class="chat-panel" data-locked="true">
        <div class="chat-panel-header" data-locked="true"><span class="chat-panel-header__title">Tab Designer</span><button class="chat-panel-close" aria-label="Close chat panel">&times;</button></div>
        <div class="chat-messages" id="chatMessages" data-locked="true">
            <div class="chat-message" id="defaultGreeting">
                <p><strong>Teams:</strong> Configure your settings below. Use the accordion sections to navigate between General settings, Model configuration (Page Builder &amp; Chat Completion), and Additional Features.</p>
                <p>The <strong>Page Builder Model</strong> is used when building pages via chat. The <strong>Chat Model</strong> is used by pages that call <code>synthos.generate.completion()</code>.</p>
            </div>
            <div class="chat-message" id="firstRunGreeting" style="display:none;">
                <p><strong>Teams:</strong> Welcome to Teams! We're glad you're here.</p>
                <p>Before you can start building, we need to connect to an AI provider. Just pick your provider below, paste in your API key, and you'll be ready to go.</p>
                <p>You can always come back to this page later to change your theme or enable additional features.</p>
            </div>
        </div>
        <div class="link-group" data-locked="true">
            <a href="#" id="saveLink" data-locked="true">Save</a>
            <a href="/pages" id="pagesLink" data-locked="true">Pages</a>
            <a href="#" id="resetLink" data-locked="true">Reset</a>
        </div>
        <form action="/" method="POST" id="chatForm" data-locked="true">
            <input type="text" class="chat-input" id="chatInput" name="message" placeholder="Type a message..." data-locked="true">
            <button type="submit" class="chat-submit" data-locked="true">Send</button>
        </form>
    </div>
    <div class="modal-overlay" id="agentModal" style="display:none;">
        <div class="conn-modal-content">
            <div class="conn-modal-title" id="agentModalTitle">Add Agent</div>
            <div id="agentFormGroup">
                <div class="form-group" style="margin-bottom:10px;">
                    <label>Agent Type</label>
                    <div style="display:flex;gap:8px;">
                        <button class="filter-btn active" id="agentTypeA2A">A2A Agent</button>
                        <button class="filter-btn" id="agentTypeOpenClaw">OpenClaw Agent</button>
                    </div>
                </div>
                <div class="form-group" style="margin-bottom:10px;">
                    <label for="agentUrl">Agent URL</label>
                    <div style="display:flex;gap:8px;">
                        <input type="text" id="agentUrl" placeholder="https://example.com" style="flex:1;">
                        <button class="conn-modal-btn" id="agentDiscoverBtn" style="padding:10px 16px;white-space:nowrap;font-size:13px;">Discover</button>
                    </div>
                    <div id="agentUrlHint" style="font-size:11px;color:var(--text-secondary);margin-top:4px;">Enter a URL and click Discover to auto-fill from the agent card, or fill in the fields manually.</div>
                </div>
                <div class="form-group" id="agentTokenGroup" style="margin-bottom:10px;display:none;">
                    <label for="agentToken">Token</label>
                    <input type="password" id="agentToken" placeholder="Gateway authentication token">
                </div>
                <div class="form-group" id="agentSessionKeyGroup" style="margin-bottom:10px;display:none;">
                    <label for="agentSessionKey">Default Session Key</label>
                    <input type="text" id="agentSessionKey" placeholder="e.g. agent:main:main">
                </div>
                <div id="agentSshTunnelGroup" style="display:none;margin-bottom:10px;">
                    <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px;cursor:pointer;" id="agentSshTunnelToggleHeader">
                        <span style="font-size:12px;color:var(--text-secondary);" id="agentSshTunnelArrow">&#9654;</span>
                        <label style="margin:0;cursor:pointer;font-size:13px;font-weight:600;color:var(--text-secondary);">SSH Tunnel</label>
                        <label class="toggle-switch" style="margin-left:auto;" onclick="event.stopPropagation();">
                            <input type="checkbox" id="agentSshTunnelEnabled">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                    <div id="agentSshTunnelFields" style="display:none;padding-left:4px;">
                        <div class="form-group" style="margin-bottom:8px;">
                            <label for="agentSshCommand" style="font-size:12px;">SSH Command</label>
                            <input type="text" id="agentSshCommand" placeholder="ssh -p 22 -N -L 18789:127.0.0.1:43901 root@0.0.0.0">
                        </div>
                        <div class="form-group" style="margin-bottom:8px;">
                            <label for="agentSshPassword" style="font-size:12px;">Password</label>
                            <input type="password" id="agentSshPassword" placeholder="SSH password">
                        </div>
                    </div>
                </div>
                <div class="form-group" style="margin-bottom:10px;">
                    <label for="agentName">Name</label>
                    <input type="text" id="agentName" placeholder="My Agent">
                </div>
                <div class="form-group" style="margin-bottom:10px;">
                    <label for="agentDescription">Description</label>
                    <textarea id="agentDescription" placeholder="Describe what this agent does and when to use it..." style="min-height:60px;"></textarea>
                </div>
                <div id="agentSkillsPreview" style="display:none;padding:10px;border-radius:8px;border:1px solid var(--border-color);background:var(--bg-tertiary);margin-bottom:10px;">
                    <div style="font-size:12px;font-weight:600;color:var(--text-secondary);margin-bottom:4px;">Discovered Skills</div>
                    <div id="agentSkillsList" style="font-size:12px;color:var(--text-secondary);"></div>
                </div>
            </div>
            <div class="conn-modal-actions">
                <button class="conn-modal-btn" id="agentSaveBtn">Save</button>
                <button class="conn-modal-btn cancel" id="agentCancelBtn">Cancel</button>
                <button class="conn-modal-btn remove" id="agentRemoveBtn" style="display:none;">Remove</button>
            </div>
        </div>
    </div>
    <div id="instructionsHidden" style="display: none;" data-locked="true"></div>
    <div id="thoughts" style="display: none;" data-locked="true"></div>
    <script id="settings-logic">
// --- Accordion logic ---
function openSection(sectionName) {
    document.querySelectorAll('.accordion-section').forEach(function(s) {
        s.classList.remove('active');
    });
    var target = document.querySelector('.accordion-section[data-section="' + sectionName + '"]');
    if (target) target.classList.add('active');
}

document.querySelectorAll('.accordion-header').forEach(function(header) {
    header.addEventListener('click', function() {
        var section = header.closest('.accordion-section');
        if (section.classList.contains('disabled')) return;
        var sectionName = section.dataset.section;
        var isActive = section.classList.contains('active');
        document.querySelectorAll('.accordion-section').forEach(function(s) {
            s.classList.remove('active');
        });
        if (!isActive) {
            section.classList.add('active');
            // Update URL without reload
            var url = new URL(window.location);
            url.searchParams.set('tab', sectionName);
            history.replaceState(null, '', url);
        }
    });
});

// --- URL param: open requested tab ---
var params = new URLSearchParams(window.location.search);
var tabParam = params.get('tab');
if (tabParam && ['general', 'models', 'agents'].indexOf(tabParam) !== -1) {
    openSection(tabParam);
}

// --- Agents logic ---
var agentList = [], currentAgentId = null, currentAgentSkills = null, currentAgentCapabilities = null;
var currentAgentType = 'a2a';
var chatAgentId = null;

function loadAgents() {
    fetch('/api/agents').then(function(r) { return r.json(); }).then(function(list) {
        agentList = list;
        renderAgentList();
    });
}

function renderAgentList() {
    var listEl = document.getElementById('agentList');
    var emptyState = document.getElementById('agentEmptyState');
    listEl.innerHTML = '';
    listEl.style.display = agentList.length === 0 ? 'none' : '';
    emptyState.style.display = agentList.length === 0 ? '' : 'none';

    agentList.forEach(function(a) {
        var row = document.createElement('div');
        row.className = 'agent-row';

        // Status dot (openclaw only)
        if (a.provider === 'openclaw') {
            var dot = document.createElement('div');
            dot.className = 'agent-status-dot ' + (a.connected ? 'connected' : 'disconnected');
            dot.title = a.connected ? 'Connected' : 'Disconnected';
            row.appendChild(dot);
        }

        // Info section
        var info = document.createElement('div');
        info.className = 'agent-row-info';

        var nameEl = document.createElement('div');
        nameEl.className = 'agent-row-name';
        nameEl.textContent = a.name;

        var descEl = document.createElement('div');
        descEl.className = 'agent-row-desc';
        descEl.textContent = a.description || '';

        info.appendChild(nameEl);
        info.appendChild(descEl);
        row.appendChild(info);

        // Badge
        var badge = document.createElement('div');
        badge.className = 'agent-row-badge';
        badge.textContent = a.provider === 'openclaw' ? 'OpenClaw' : 'A2A';
        row.appendChild(badge);

        // Actions
        var actions = document.createElement('div');
        actions.className = 'agent-row-actions';

        // Chat or Reconnect button (depending on connection state)
        var isDisconnected = a.provider === 'openclaw' && a.enabled !== false && !a.connected;
        var chatBtn = document.createElement('button');
        chatBtn.className = 'filter-btn';
        chatBtn.style.fontSize = '12px';
        chatBtn.style.padding = '4px 10px';
        if (isDisconnected) {
            chatBtn.textContent = 'Reconnect';
            chatBtn.addEventListener('click', (function(agent) {
                return function(e) {
                    e.stopPropagation();
                    chatBtn.disabled = true;
                    chatBtn.textContent = 'Connecting...';
                    fetch('/api/agents/' + encodeURIComponent(agent.id) + '/connect', { method: 'POST' })
                        .then(function() { loadAgents(); })
                        .catch(function() { chatBtn.disabled = false; chatBtn.textContent = 'Reconnect'; });
                };
            })(a));
        } else {
            chatBtn.textContent = 'Chat';
            chatBtn.addEventListener('click', function(e) {
                e.stopPropagation();
                openAgentChat(a);
            });
        }
        actions.appendChild(chatBtn);

        // Edit button
        var editBtn = document.createElement('button');
        editBtn.className = 'filter-btn';
        editBtn.textContent = 'Edit';
        editBtn.style.fontSize = '12px';
        editBtn.style.padding = '4px 10px';
        editBtn.addEventListener('click', function(e) {
            e.stopPropagation();
            openAgentEditModal(a);
        });
        actions.appendChild(editBtn);

        // Enable/disable toggle
        var toggleLabel = document.createElement('label');
        toggleLabel.className = 'toggle-switch';
        var toggleInput = document.createElement('input');
        toggleInput.type = 'checkbox';
        toggleInput.checked = a.enabled !== false;
        toggleInput.addEventListener('click', function(e) { e.stopPropagation(); });
        toggleInput.addEventListener('change', (function(agentId, inp) {
            return function() {
                fetch('/api/agents/' + encodeURIComponent(agentId), {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ enabled: inp.checked })
                }).then(function() { loadAgents(); });
            };
        })(a.id, toggleInput));
        var toggleSlider = document.createElement('span');
        toggleSlider.className = 'toggle-slider';
        toggleLabel.appendChild(toggleInput);
        toggleLabel.appendChild(toggleSlider);
        actions.appendChild(toggleLabel);

        row.appendChild(actions);
        listEl.appendChild(row);
    });
}

// --- Agent quick chat ---
function openAgentChat(agent) {
    chatAgentId = agent.id;
    document.getElementById('agentChatTitle').textContent = 'Chat with ' + agent.name;
    document.getElementById('agentChatMessages').innerHTML = '';
    document.getElementById('agentChatInput').value = '';
    var panel = document.getElementById('agentChatPanel');
    panel.classList.add('open');
    document.getElementById('agentChatInput').focus();
}

function closeAgentChat() {
    chatAgentId = null;
    document.getElementById('agentChatPanel').classList.remove('open');
}

function addChatMsg(role, text) {
    var msgs = document.getElementById('agentChatMessages');
    var div = document.createElement('div');
    div.className = 'agent-chat-msg ' + role;
    div.textContent = text;
    msgs.appendChild(div);
    msgs.scrollTop = msgs.scrollHeight;
    return div;
}

function sendAgentChatMessage() {
    if (!chatAgentId) return;
    var input = document.getElementById('agentChatInput');
    var message = input.value.trim();
    if (!message) return;

    input.value = '';
    addChatMsg('user', message);

    var sendBtn = document.getElementById('agentChatSendBtn');
    sendBtn.disabled = true;
    sendBtn.textContent = '...';

    // Check if agent supports streaming
    var agent = agentList.find(function(a) { return a.id === chatAgentId; });
    var supportsStreaming = agent && agent.capabilities && agent.capabilities.streaming;

    if (supportsStreaming) {
        // Use streaming
        var responseDiv = addChatMsg('agent', '');
        var responseText = '';

        fetch('/api/agents/' + encodeURIComponent(chatAgentId) + '/stream', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ message: message })
        }).then(function(res) {
            if (!res.ok) return res.json().then(function(d) { throw new Error(d.error || 'Send failed'); });
            var reader = res.body.getReader();
            var decoder = new TextDecoder();
            var buffer = '';
            function pump() {
                return reader.read().then(function(result) {
                    if (result.done) { sendBtn.disabled = false; sendBtn.textContent = 'Send'; return; }
                    buffer += decoder.decode(result.value, { stream: true });
                    var lines = buffer.split('\n');
                    buffer = lines.pop() || '';
                    for (var i = 0; i < lines.length; i++) {
                        var line = lines[i];
                        if (line.indexOf('data: ') === 0) {
                            var data = line.substring(6);
                            if (data === '[DONE]') { sendBtn.disabled = false; sendBtn.textContent = 'Send'; return; }
                            try {
                                var evt = JSON.parse(data);
                                if (evt.kind === 'text' && evt.data) {
                                    responseText += evt.data;
                                    responseDiv.textContent = responseText;
                                    document.getElementById('agentChatMessages').scrollTop = document.getElementById('agentChatMessages').scrollHeight;
                                } else if (evt.kind === 'error') {
                                    addChatMsg('error', 'Error: ' + (evt.data || 'Unknown error'));
                                    sendBtn.disabled = false; sendBtn.textContent = 'Send';
                                    return;
                                }
                            } catch (e) {}
                        }
                    }
                    return pump();
                });
            }
            return pump();
        }).catch(function(err) {
            if (!responseText) responseDiv.remove();
            addChatMsg('error', 'Error: ' + err.message);
            sendBtn.disabled = false; sendBtn.textContent = 'Send';
        });
    } else {
        // Non-streaming
        addChatMsg('status', 'Waiting for response...');
        fetch('/api/agents/' + encodeURIComponent(chatAgentId) + '/send', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ message: message })
        }).then(function(r) {
            if (!r.ok) return r.json().then(function(d) { throw new Error(d.error || 'Send failed'); });
            return r.json();
        }).then(function(result) {
            // Remove "waiting" status
            var msgs = document.getElementById('agentChatMessages');
            var last = msgs.lastElementChild;
            if (last && last.classList.contains('status')) last.remove();
            addChatMsg('agent', result.text || JSON.stringify(result.raw, null, 2));
        }).catch(function(err) {
            var msgs = document.getElementById('agentChatMessages');
            var last = msgs.lastElementChild;
            if (last && last.classList.contains('status')) last.remove();
            addChatMsg('error', 'Error: ' + err.message);
        }).finally(function() {
            sendBtn.disabled = false; sendBtn.textContent = 'Send';
        });
    }
}

document.getElementById('agentChatClose').addEventListener('click', closeAgentChat);
document.getElementById('agentChatSendBtn').addEventListener('click', sendAgentChatMessage);
document.getElementById('agentChatInput').addEventListener('keydown', function(e) {
    if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendAgentChatMessage(); }
});

function setAgentType(type) {
    currentAgentType = type;
    document.getElementById('agentTypeA2A').className = 'filter-btn' + (type === 'a2a' ? ' active' : '');
    document.getElementById('agentTypeOpenClaw').className = 'filter-btn' + (type === 'openclaw' ? ' active' : '');
    document.getElementById('agentTokenGroup').style.display = type === 'openclaw' ? '' : 'none';
    document.getElementById('agentSessionKeyGroup').style.display = type === 'openclaw' ? '' : 'none';
    document.getElementById('agentSshTunnelGroup').style.display = type === 'openclaw' ? '' : 'none';
    document.getElementById('agentUrlHint').textContent = type === 'openclaw'
        ? 'Enter the gateway HTTP URL and token, then click Discover to verify connectivity.'
        : 'Enter a URL and click Discover to auto-fill from the agent card, or fill in the fields manually.';
}

function resetAgentModal() {
    currentAgentId = null;
    currentAgentSkills = null;
    currentAgentCapabilities = null;
    setAgentType('a2a');
    document.getElementById('agentUrl').value = '';
    document.getElementById('agentToken').value = '';
    document.getElementById('agentSessionKey').value = '';
    document.getElementById('agentName').value = '';
    document.getElementById('agentDescription').value = '';
    document.getElementById('agentSkillsPreview').style.display = 'none';
    document.getElementById('agentSkillsList').innerHTML = '';
    document.getElementById('agentRemoveBtn').style.display = 'none';
    // Reset SSH tunnel fields
    document.getElementById('agentSshTunnelEnabled').checked = false;
    document.getElementById('agentSshCommand').value = '';
    document.getElementById('agentSshPassword').value = '';
    document.getElementById('agentSshTunnelFields').style.display = 'none';
    document.getElementById('agentSshTunnelArrow').innerHTML = '&#9654;';
}

function openAgentAddModal() {
    resetAgentModal();
    document.getElementById('agentModalTitle').textContent = 'Add Agent';
    document.getElementById('agentModal').style.display = 'flex';
}

function openAgentEditModal(agent) {
    resetAgentModal();
    currentAgentId = agent.id;
    setAgentType(agent.provider || 'a2a');
    document.getElementById('agentModalTitle').textContent = 'Edit Agent';
    document.getElementById('agentUrl').value = agent.url || '';
    document.getElementById('agentName').value = agent.name || '';
    document.getElementById('agentDescription').value = agent.description || '';
    // Token is stripped by the server — show placeholder in edit mode for openclaw
    if (agent.provider === 'openclaw') {
        document.getElementById('agentToken').placeholder = '(token saved — leave blank to keep)';
        document.getElementById('agentSessionKey').value = agent.sessionKey || '';
        // Populate SSH tunnel fields (password is stripped by server)
        if (agent.sshTunnel) {
            document.getElementById('agentSshTunnelEnabled').checked = !!agent.sshTunnel.enabled;
            document.getElementById('agentSshCommand').value = agent.sshTunnel.command || '';
            document.getElementById('agentSshPassword').placeholder = '(password saved — leave blank to keep)';
            if (agent.sshTunnel.enabled) {
                document.getElementById('agentSshTunnelFields').style.display = '';
                document.getElementById('agentSshTunnelArrow').innerHTML = '&#9660;';
            }
        }
    }
    document.getElementById('agentRemoveBtn').style.display = '';
    document.getElementById('agentModal').style.display = 'flex';
}

function closeAgentModal() {
    document.getElementById('agentModal').style.display = 'none';
    resetAgentModal();
}

function renderSkillsList(skills) {
    var container = document.getElementById('agentSkillsList');
    var wrapper = document.getElementById('agentSkillsPreview');
    if (!skills || skills.length === 0) {
        wrapper.style.display = 'none';
        container.innerHTML = '';
        return;
    }
    wrapper.style.display = '';
    container.innerHTML = skills.map(function(s) {
        var label = s.name || s.id || 'Skill';
        var desc = s.description ? ' — ' + s.description : '';
        return '<span style="display:inline-block;padding:2px 8px;margin:2px;border-radius:8px;background:var(--accent-glow);font-size:11px;">' + label + desc + '</span>';
    }).join('');
}

document.getElementById('agentTypeA2A').addEventListener('click', function() { setAgentType('a2a'); });
document.getElementById('agentTypeOpenClaw').addEventListener('click', function() { setAgentType('openclaw'); });

// SSH Tunnel collapsible section
document.getElementById('agentSshTunnelToggleHeader').addEventListener('click', function() {
    var fields = document.getElementById('agentSshTunnelFields');
    var arrow = document.getElementById('agentSshTunnelArrow');
    var isOpen = fields.style.display !== 'none';
    fields.style.display = isOpen ? 'none' : '';
    arrow.innerHTML = isOpen ? '&#9654;' : '&#9660;';
});
document.getElementById('agentSshTunnelEnabled').addEventListener('change', function() {
    if (this.checked) {
        document.getElementById('agentSshTunnelFields').style.display = '';
        document.getElementById('agentSshTunnelArrow').innerHTML = '&#9660;';
    }
});

document.getElementById('addAgentBtn').addEventListener('click', function(e) {
    e.stopPropagation();
    openAgentAddModal();
});
document.getElementById('agentCancelBtn').addEventListener('click', closeAgentModal);

var agentModalMouseDownTarget = null;
document.getElementById('agentModal').addEventListener('mousedown', function(e) { agentModalMouseDownTarget = e.target; });
document.getElementById('agentModal').addEventListener('click', function(e) {
    if (e.target === this && agentModalMouseDownTarget === this) closeAgentModal();
    agentModalMouseDownTarget = null;
});

document.getElementById('agentDiscoverBtn').addEventListener('click', function() {
    var url = document.getElementById('agentUrl').value.trim();
    if (!url) return;
    var btn = this;
    btn.disabled = true;
    btn.textContent = 'Discovering...';

    var body = { url: url, type: currentAgentType };
    if (currentAgentType === 'openclaw') {
        var token = document.getElementById('agentToken').value.trim();
        if (!token) { alert('Token is required for OpenClaw discovery.'); btn.disabled = false; btn.textContent = 'Discover'; return; }
        body.token = token;
    }

    fetch('/api/agents/discover', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(body)
    }).then(function(r) {
        if (!r.ok) return r.json().then(function(d) { throw new Error(d.error || 'Discovery failed'); });
        return r.json();
    }).then(function(result) {
        var nameEl = document.getElementById('agentName');
        var descEl = document.getElementById('agentDescription');
        if (!nameEl.value.trim() && result.name) nameEl.value = result.name;
        if (!descEl.value.trim() && result.description) descEl.value = result.description;
        if (result.skills) {
            currentAgentSkills = result.skills;
            renderSkillsList(currentAgentSkills);
        }
        if (result.capabilities) {
            currentAgentCapabilities = result.capabilities;
        }
        if (currentAgentType === 'openclaw' && result.verified) {
            alert('Gateway verified successfully!');
        }
    }).catch(function(err) {
        alert('Discovery failed: ' + err.message);
    }).finally(function() {
        btn.disabled = false;
        btn.textContent = 'Discover';
    });
});

document.getElementById('agentSaveBtn').addEventListener('click', function() {
    var name = document.getElementById('agentName').value.trim();
    var url = document.getElementById('agentUrl').value.trim();
    var description = document.getElementById('agentDescription').value.trim();
    if (!name) { alert('Name is required.'); return; }
    if (!url) { alert('Agent URL is required.'); return; }
    if (!description) { alert('Description is required — explain what this agent does so pages know when to use it.'); return; }

    var body = {
        url: url,
        name: name,
        description: description,
        enabled: true,
        provider: currentAgentType
    };
    if (currentAgentId) body.id = currentAgentId;
    if (currentAgentSkills) body.skills = currentAgentSkills;
    if (currentAgentCapabilities) body.capabilities = currentAgentCapabilities;

    // Include token for openclaw agents
    if (currentAgentType === 'openclaw') {
        var token = document.getElementById('agentToken').value.trim();
        if (token) body.token = token;
        // For new openclaw agents, token is required
        if (!token && !currentAgentId) { alert('Token is required for OpenClaw agents.'); return; }
        // Set streaming capability by default for openclaw
        if (!body.capabilities) body.capabilities = { streaming: true };
        var sessionKey = document.getElementById('agentSessionKey').value.trim();
        if (sessionKey) body.sessionKey = sessionKey;

        // SSH tunnel config
        var sshEnabled = document.getElementById('agentSshTunnelEnabled').checked;
        var sshCommand = document.getElementById('agentSshCommand').value.trim();
        var sshPassword = document.getElementById('agentSshPassword').value;
        if (sshEnabled || sshCommand) {
            body.sshTunnel = {
                enabled: sshEnabled,
                command: sshCommand
            };
            // Only include password if provided (otherwise server preserves existing)
            if (sshPassword) body.sshTunnel.password = sshPassword;
        }
    }

    fetch('/api/agents', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(body)
    }).then(function(r) {
        if (r.ok) { closeAgentModal(); loadAgents(); }
    });
});

document.getElementById('agentRemoveBtn').addEventListener('click', function() {
    if (!currentAgentId) return;
    fetch('/api/agents/' + encodeURIComponent(currentAgentId), { method: 'DELETE' }).then(function(r) {
        if (r.ok) { closeAgentModal(); loadAgents(); }
    });
});

// --- Save logic ---
function saveAllSettings() {
    var builderApiKey = document.getElementById('serviceApiKey-builder').value;
    var builderModel = document.getElementById('model-builder').value;
    var builderMaxTokens = document.getElementById('maxTokens-builder').value;
    var builderProvider = document.getElementById('provider-builder').value;

    if (!builderProvider || !builderApiKey || !builderModel || !builderMaxTokens) {
        alert('Please fill in all required Page Builder fields (Provider, API Key, Model, Max Output Tokens).');
        openSection('models');
        return;
    }

    var models = [
        {
            use: 'builder',
            provider: builderProvider,
            configuration: {
                apiKey: builderApiKey,
                model: builderModel,
                maxTokens: builderMaxTokens
            },
            imageQuality: 'standard',
            instructions: document.getElementById('instructions-builder').value
        },
        {
            use: 'chat',
            provider: document.getElementById('provider-chat').value,
            configuration: {
                apiKey: document.getElementById('serviceApiKey-chat').value,
                model: document.getElementById('model-chat').value,
                maxTokens: document.getElementById('maxTokens-chat').value
            },
            imageQuality: 'standard',
            instructions: document.getElementById('instructions-chat').value
        }
    ];

    var body = {
        version: 2,
        theme: document.getElementById('theme').value,
        models: models,
        features: []
    };

    fetch('/api/settings', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(body)
    }).then(function(response) {
        if (response.ok || response.redirected) {
            if (wizardActive) {
                window.location.href = '/builder?firstRun=true';
            } else {
                window.location.reload();
            }
        } else {
            alert('Failed to save settings. Please try again.');
        }
    }).catch(function(err) {
        console.error('Error saving settings:', err);
        alert('Failed to save settings. Please try again.');
    });
}

document.querySelectorAll('.apply-btn').forEach(function(btn) {
    btn.addEventListener('click', saveAllSettings);
});

// --- Provider helpers ---
var providersData = [];

function populateProviderDropdowns() {
    var providerOptions = providersData.map(function(p) {
        return '<option value="' + p.name + '">' + p.name + '</option>';
    }).join('');
    document.getElementById('provider-builder').innerHTML = providerOptions;
    document.getElementById('provider-chat').innerHTML = providerOptions;
}

function populateModelDropdown(use, providerName) {
    var provider = providersData.find(function(p) { return p.name === providerName; });
    if (!provider) return;
    var models = use === 'builder' ? provider.builderModels : provider.chatModels;
    var options = models.map(function(m) {
        return '<option value="' + m + '">' + m + '</option>';
    }).join('');
    document.getElementById('model-' + use).innerHTML = options;
}

document.getElementById('provider-builder').addEventListener('change', function() {
    populateModelDropdown('builder', this.value);
});
document.getElementById('provider-chat').addEventListener('change', function() {
    populateModelDropdown('chat', this.value);
});

// --- Provider signup instructions ---
var providerInstructions = {
    'Anthropic': 'Sign up at <a href="https://platform.claude.com" target="_blank">platform.claude.com</a>, then get your key at <a href="https://console.anthropic.com/settings/keys" target="_blank">console.anthropic.com/settings/keys</a>.',
    'OpenAI': 'Sign up at <a href="https://auth.openai.com/create-account" target="_blank">auth.openai.com/create-account</a>, then get your key at <a href="https://platform.openai.com/api-keys" target="_blank">platform.openai.com/api-keys</a>.',
    'FireworksAI': 'Sign up at <a href="https://fireworks.ai" target="_blank">fireworks.ai</a>, then get your key at <a href="https://fireworks.ai/account/api-keys" target="_blank">fireworks.ai/account/api-keys</a>.'
};

// --- "More settings" toggle state (works for all users) ---
var builderAdvanced = false;
var chatAdvanced = false;

function applyAdvancedToggle() {
    document.getElementById('fg-maxTokens-builder').classList.toggle('wizard-hidden', !builderAdvanced);
    document.getElementById('fg-instructions-builder').classList.toggle('wizard-hidden', !builderAdvanced);
    document.getElementById('fg-maxTokens-chat').classList.toggle('wizard-hidden', !chatAdvanced);
    document.getElementById('fg-instructions-chat').classList.toggle('wizard-hidden', !chatAdvanced);
}

document.getElementById('moreSettingsLink').addEventListener('click', function(e) {
    e.preventDefault();
    builderAdvanced = !builderAdvanced;
    this.innerHTML = builderAdvanced ? '&#9652; Less settings' : '&#9662; More settings';
    applyAdvancedToggle();
});

document.getElementById('moreSettingsLinkChat').addEventListener('click', function(e) {
    e.preventDefault();
    chatAdvanced = !chatAdvanced;
    this.innerHTML = chatAdvanced ? '&#9652; Less settings' : '&#9662; More settings';
    applyAdvancedToggle();
});

// Hide advanced fields by default on load
applyAdvancedToggle();

// --- Wizard state ---
var wizardActive = false;
var builderStep = 0;  // 0 = provider only, 1 = + API key, 2 = fully configured

function updateWizardVisibility() {
    if (!wizardActive) return;
    var fgApiKey = document.getElementById('fg-apikey-builder');
    var fgModel = document.getElementById('fg-model-builder');
    var moreLinkBuilder = document.getElementById('moreSettingsLink');
    var chatCardEl = document.getElementById('chatCard');
    var moreLinkChat = document.getElementById('moreSettingsLinkChat');

    // Step 0: only provider visible
    fgApiKey.classList.toggle('wizard-hidden', builderStep < 1);

    // Model dropdown visible at step 2 (auto-selected)
    fgModel.classList.toggle('wizard-hidden', builderStep < 2);

    // Builder "More settings" hidden until step 2
    moreLinkBuilder.style.display = builderStep >= 2 ? 'inline-block' : 'none';
    if (builderStep < 2) {
        document.getElementById('fg-maxTokens-builder').classList.add('wizard-hidden');
        document.getElementById('fg-instructions-builder').classList.add('wizard-hidden');
    } else {
        // Let the toggle state drive visibility
        applyAdvancedToggle();
    }

    // Chat card: before step 2, show only title grayed out
    if (builderStep < 2) {
        ['fg-provider-chat', 'fg-apikey-chat', 'fg-model-chat', 'fg-maxTokens-chat', 'fg-instructions-chat'].forEach(function(id) {
            document.getElementById(id).classList.add('wizard-hidden');
        });
        moreLinkChat.style.display = 'none';
        chatCardEl.classList.add('disabled');
    } else {
        // Step 2: show chat card populated — provider, key, model visible; advanced behind toggle
        ['fg-provider-chat', 'fg-apikey-chat', 'fg-model-chat'].forEach(function(id) {
            document.getElementById(id).classList.remove('wizard-hidden');
        });
        moreLinkChat.style.display = 'inline-block';
        applyAdvancedToggle();
        chatCardEl.classList.remove('disabled');
    }

    updateApplyButton();
}

function updateApplyButton() {
    var btns = document.querySelectorAll('.apply-btn');
    if (!wizardActive) {
        btns.forEach(function(b) { b.disabled = false; });
        return;
    }
    var hasProvider = !!document.getElementById('provider-builder').value;
    var hasKey = !!document.getElementById('serviceApiKey-builder').value;
    var hasModel = !!document.getElementById('model-builder').value;
    var hasTokens = !!document.getElementById('maxTokens-builder').value;
    var ready = hasProvider && hasKey && hasModel && hasTokens;
    btns.forEach(function(b) { b.disabled = !ready; });
}

function autoPopulateChatCard() {
    var providerVal = document.getElementById('provider-builder').value;
    var apiKeyVal = document.getElementById('serviceApiKey-builder').value;

    document.getElementById('provider-chat').value = providerVal;
    populateModelDropdown('chat', providerVal);

    var chatModelSelect = document.getElementById('model-chat');
    if (chatModelSelect.options.length > 0) {
        chatModelSelect.selectedIndex = 0;
    }

    document.getElementById('serviceApiKey-chat').value = apiKeyVal;
    document.getElementById('maxTokens-chat').value = '32000';
}

// --- Wizard event listeners ---
document.getElementById('provider-builder').addEventListener('change', function() {
    if (!wizardActive) return;
    var val = this.value;
    if (!val) return;
    if (builderStep < 1) builderStep = 1;
    var instrEl = document.getElementById('providerInstructions');
    if (providerInstructions[val]) {
        instrEl.innerHTML = providerInstructions[val];
        instrEl.style.display = 'block';
    } else {
        instrEl.style.display = 'none';
    }
    updateWizardVisibility();
});

document.getElementById('serviceApiKey-builder').addEventListener('input', function() {
    if (!wizardActive) return;
    if (this.value.length > 0 && builderStep < 2) {
        builderStep = 2;
        document.getElementById('providerInstructions').style.display = 'none';
        document.getElementById('maxTokens-builder').value = '32000';
        autoPopulateChatCard();
        updateWizardVisibility();
    }
    updateApplyButton();
});

// --- Load data ---
var isConfigured = false;

Promise.all([
    fetch('/api/settings').then(function(r) { return r.json(); }),
    fetch('/api/themes').then(function(r) { return r.json(); })
]).then(function(results) {
    var data = results[0], themes = results[1];

    // Store providers data
    providersData = data.providers || [];

    // Find builder and chat entries from models array
    var models = data.models || [];
    var builder = models.find(function(m) { return m.use === 'builder'; }) || {};
    var chat = models.find(function(m) { return m.use === 'chat'; }) || {};

    var builderConfig = builder.configuration || {};
    var chatConfig = chat.configuration || {};
    var builderApiKey = builderConfig.apiKey || '';
    var builderModel = builderConfig.model || '';
    var builderMaxTokens = builderConfig.maxTokens || '';
    isConfigured = builderApiKey && builderModel && builderMaxTokens;

    // Populate provider dropdowns
    populateProviderDropdowns();

    // Builder fields
    document.getElementById('provider-builder').value = builder.provider || 'Anthropic';
    populateModelDropdown('builder', builder.provider || 'Anthropic');
    document.getElementById('serviceApiKey-builder').value = builderApiKey;
    document.getElementById('model-builder').value = builderModel;
    document.getElementById('maxTokens-builder').value = builderMaxTokens;
    document.getElementById('instructions-builder').value = builder.instructions || '';

    // Chat fields
    document.getElementById('provider-chat').value = chat.provider || 'Anthropic';
    populateModelDropdown('chat', chat.provider || 'Anthropic');
    document.getElementById('serviceApiKey-chat').value = chatConfig.apiKey || '';
    document.getElementById('model-chat').value = chatConfig.model || '';
    document.getElementById('maxTokens-chat').value = chatConfig.maxTokens || '';
    document.getElementById('instructions-chat').value = chat.instructions || '';

    var currentTheme = data.theme || 'nebula-dusk';
    document.getElementById('theme').innerHTML = themes.map(function(t) {
        return '<option value="' + t + '">' + t + '</option>';
    }).join('');
    document.getElementById('theme').value = currentTheme;

    loadAgents();

    var isFirstRun = params.get('firstRun') === '1';

    if (!isConfigured) {
        // Disable chat and navigation
        document.getElementById('chatInput').disabled = true;
        document.getElementById('chatInput').classList.add('disabled');
        var pagesLink = document.getElementById('pagesLink');
        pagesLink.style.opacity = '0.4';
        pagesLink.style.pointerEvents = 'none';

        // Show config required banner and open models section
        document.getElementById('configBanner').style.display = 'block';
        openSection('models');
    }

    if (isFirstRun) {
        // Activate wizard — always treat as unconfigured when firstRun=1
        wizardActive = true;
        builderStep = 0;

        // Disable chat and navigation (even if somehow configured)
        document.getElementById('chatInput').disabled = true;
        document.getElementById('chatInput').classList.add('disabled');

        // Disable Copy, Pages, and Reload links
        ['saveLink', 'pagesLink', 'resetLink'].forEach(function(id) {
            var el = document.getElementById(id);
            el.style.opacity = '0.4';
            el.style.pointerEvents = 'none';
        });

        // Show firstRun greeting, hide default
        document.getElementById('defaultGreeting').style.display = 'none';
        document.getElementById('firstRunGreeting').style.display = '';

        // Show banner and lock to models tab
        document.getElementById('configBanner').style.display = 'block';
        openSection('models');

        // Disable other accordion tabs
        document.querySelector('.accordion-section[data-section="general"]').classList.add('disabled');
        document.querySelector('.accordion-section[data-section="agents"]').classList.add('disabled');

        // Clear any existing values so wizard starts fresh
        document.getElementById('provider-builder').value = '';
        document.getElementById('serviceApiKey-builder').value = '';
        document.getElementById('model-builder').innerHTML = '<option value="">Select a model</option>';
        document.getElementById('maxTokens-builder').value = '';
        document.getElementById('instructions-builder').value = '';
        document.getElementById('provider-chat').value = '';
        document.getElementById('serviceApiKey-chat').value = '';
        document.getElementById('model-chat').innerHTML = '<option value="">Select a model</option>';
        document.getElementById('maxTokens-chat').value = '';
        document.getElementById('instructions-chat').value = '';

        // Add placeholder option to builder provider dropdown
        var builderProviderSelect = document.getElementById('provider-builder');
        var placeholder = document.createElement('option');
        placeholder.value = '';
        placeholder.textContent = 'Select a provider';
        placeholder.disabled = true;
        placeholder.selected = true;
        builderProviderSelect.insertBefore(placeholder, builderProviderSelect.firstChild);
        builderProviderSelect.value = '';

        // Disable Apply buttons until configured
        document.querySelectorAll('.apply-btn').forEach(function(b) { b.disabled = true; });

        updateWizardVisibility();
    }
}).catch(function(error) {
    console.error('Error fetching settings:', error);
});
    </script>
<script id="page-helpers" src="/api/page-helpers.js?v=2" data-locked="true"></script>
<script id="page-script" src="/api/page-script.js?v=2" data-locked="true"></script>
</body></html>